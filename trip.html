<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">載入中...</title>
    <!-- 載入 Tailwind CSS 框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 字體與移動端優化 */
        :root { font-family: 'Inter', sans-serif; }
        .content-area { padding-bottom: 80px; }
        .day-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            cursor: pointer;
        }
        .day-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .fab {
            /* 浮動圓形按鈕 */
            width: 56px;
            height: 56px;
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.5), 0 4px 6px -2px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 載入登入狀態守衛 (Auth Guard) -->
    <script type="module" src="./auth-guard.js"></script>

    <!-- 頁面頂部導航列 -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="max-w-xl mx-auto flex justify-between items-center p-4">
            <button onclick="window.location.href='index.html'" class="text-indigo-600 hover:text-indigo-800 transition duration-150 p-2 rounded-full active:bg-indigo-50 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                <span class="hidden sm:inline">返回列表</span>
            </button>
            <h1 id="trip-name-display" class="text-xl font-bold text-gray-800 truncate flex-grow text-center mx-4">行程載入中...</h1>
        </div>
    </header>

    <!-- 行程內容區 -->
    <main class="content-area max-w-xl mx-auto p-4">
        
        <!-- 行程日期與摘要 -->
        <div class="bg-white p-5 rounded-xl shadow mb-6">
            <p id="trip-dates-display" class="text-sm font-semibold text-indigo-600 mb-2">日期: 正在載入...</p>
            <p id="trip-summary-display" class="text-sm text-gray-500">總天數: - | 最後編輯: 載入中</p>
        </div>

        <!-- 天數列表容器 -->
        <div id="day-list-container" class="space-y-4">
            <!-- 天數卡片將透過 JavaScript 插入這裡 -->
            <div id="loading-spinner" class="mt-8 text-center text-gray-500">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>正在載入天數列表...</p>
            </div>
            
            <div id="no-days-message" class="mt-8 p-6 text-center text-gray-500 bg-white rounded-xl shadow hidden">
                <p class="text-lg font-semibold mb-2">此行程尚未規劃任何天數</p>
                <p class="text-sm">點擊右下角的綠色按鈕新增第一天行程！</p>
            </div>
        </div>

    </main>

    <!-- 新增天數的 FAB (浮動圓形按鈕) -->
    <button id="add-day-fab" class="fab fixed bottom-6 right-6 flex items-center justify-center 
                                        bg-green-600 hover:bg-green-700 text-white 
                                        rounded-full transition duration-200 z-20 active:shadow-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- 頁面邏輯腳本 -->
    <script type="module">
        import { auth, db } from './auth.js';
        import { doc, getDoc, collection, query, onSnapshot, updateDoc, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI 元素
        const pageTitle = document.getElementById('page-title');
        const tripNameDisplay = document.getElementById('trip-name-display');
        const tripDatesDisplay = document.getElementById('trip-dates-display');
        const tripSummaryDisplay = document.getElementById('trip-summary-display');
        const dayListContainer = document.getElementById('day-list-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noDaysMessage = document.getElementById('no-days-message');
        const addDayFab = document.getElementById('add-day-fab');

        let tripId = null;
        let currentUserId = null;
        let currentUserName = null;
        let tripDocRef = null;
        let daysColRef = null;
        let unsubscribeDays = null;
        let tripData = null; // 儲存行程主資料

        // 輔助函數: 取得 URL 參數
        function getQueryVariable(variable) {
            const query = window.location.search.substring(1);
            const vars = query.split("&");
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split("=");
                if (pair[0] === variable) { return pair[1]; }
            }
            return null;
        }

        // 輔助函數: 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '未定';
            return new Date(timestamp.seconds * 1000).toLocaleDateString('zh-TW');
        }
        
        // 輔助函數: 格式化時間戳
        function formatDateTime(timestamp) {
            if (!timestamp) return '無';
            return new Date(timestamp.seconds * 1000).toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' });
        }


        // 1. 監聽 AuthReady 事件
        document.addEventListener('authReady', (e) => {
            currentUserId = e.detail.uid;
            // 這裡我們需要一個方法來取得用戶名稱。在真實情境中，登入時應將用戶名稱存入 Auth 或 Firestore
            // 由於我們只知道 UID，這裡暫時將用戶名稱設為 UID 的前八位
            currentUserName = auth.currentUser.email ? auth.currentUser.email.split('@')[0] : currentUserId.substring(0, 8);

            tripId = getQueryVariable('tripId');
            if (!tripId) {
                alert("錯誤：URL 中缺少 tripId 參數！將導向回首頁。"); // 應使用自訂 Modal
                window.location.replace('index.html');
                return;
            }
            
            // 建立 Firestore 參考
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // 行程主文件路徑: /artifacts/{appId}/public/data/trips/{tripId}
            tripDocRef = doc(db, `artifacts/${appId}/public/data/trips/${tripId}`);
            // 天數子集合路徑: /artifacts/{appId}/public/data/trips/{tripId}/days
            daysColRef = collection(db, `artifacts/${appId}/public/data/trips/${tripId}/days`);

            // 載入行程主資料
            loadTripDetails();
            // 載入天數列表
            loadDaysList();
        });

        // 2. 載入行程主資料 (名稱、日期、編輯資訊)
        async function loadTripDetails() {
            try {
                const docSnap = await getDoc(tripDocRef);
                if (!docSnap.exists()) {
                    alert("錯誤：找不到該行程！");
                    window.location.replace('index.html');
                    return;
                }
                
                tripData = docSnap.data();
                
                // 更新 UI
                pageTitle.textContent = `${tripData.name || '未命名行程'} - 規劃`;
                tripNameDisplay.textContent = tripData.name || '未命名行程';
                
                const startDate = formatDate(tripData.startDate);
                const endDate = formatDate(tripData.endDate);
                tripDatesDisplay.textContent = `日期: ${startDate} ~ ${endDate}`;
                
                const lastEditorName = tripData.lastEditorName || '匿名使用者';
                const lastEditedTime = formatDateTime(tripData.lastEditedTime);
                
                tripSummaryDisplay.innerHTML = `總天數: ${tripData.daysCount || 0} 天 | 最後編輯: ${lastEditorName} 於 ${lastEditedTime}`;
                
            } catch (error) {
                console.error("載入行程主資料失敗:", error);
                alert(`載入行程詳細資訊失敗: ${error.message}`); // 應使用自訂 Modal
            }
        }

        // 3. 載入天數列表 (即時監聽)
        function loadDaysList() {
            if (unsubscribeDays) {
                unsubscribeDays(); // 取消舊的監聽
            }
            
            const daysQuery = query(daysColRef); // 這裡不使用 orderBy，在前端排序

            unsubscribeDays = onSnapshot(daysQuery, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                dayListContainer.innerHTML = '';
                
                const days = [];
                snapshot.forEach(doc => {
                    days.push({ id: doc.id, ...doc.data() });
                });
                
                // 依據 dayOrder 欄位進行前端排序
                days.sort((a, b) => (a.dayOrder || 999) - (b.dayOrder || 999));

                if (days.length === 0) {
                    noDaysMessage.classList.remove('hidden');
                    return;
                }

                noDaysMessage.classList.add('hidden');

                // 渲染天數列表
                days.forEach(day => {
                    const card = createDayCard(day);
                    dayListContainer.appendChild(card);
                });
                
            }, (error) => {
                console.error("Firestore 天數列表即時監聽失敗:", error);
                loadingSpinner.innerHTML = `<p class="text-red-600">載入天數列表錯誤: ${error.message}</p>`;
            });
        }

        // 4. 建立單個天數卡片的 HTML 元素
        function createDayCard(day) {
            const lastEditorName = day.lastEditorName || '匿名';
            const lastEditedTime = formatDateTime(day.lastEditedTime);
            const dayNumber = day.dayOrder || '?';
            
            const card = document.createElement('a');
            // 點擊進入單日活動管理頁
            card.href = `day.html?tripId=${tripId}&dayId=${day.id}`; 
            card.className = 'day-card block bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-green-400 transition duration-150';
            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-extrabold text-green-700">Day ${dayNumber}</h2>
                    <span class="text-sm font-medium text-gray-500">${day.date ? formatDate(day.date) : '日期未定'}</span>
                </div>
                
                <p class="text-gray-700 mb-4">${day.theme || '點擊新增當日主題或活動'}</p>

                <div class="flex justify-between text-xs text-gray-500 border-t pt-2 mt-2">
                    <div>
                        <span class="font-medium">活動數:</span> ${day.activityCount || 0}
                    </div>
                    <div class="text-right">
                        <span class="font-medium">最後編輯:</span> ${lastEditorName} 於 ${lastEditedTime}
                    </div>
                </div>
            `;
            return card;
        }

        // 5. 新增天數功能 (FAB)
        addDayFab.addEventListener('click', async () => {
            if (!tripId || !currentUserId) return;
            
            const daysInList = dayListContainer.children.length;
            const nextDayOrder = daysInList + 1;
            
            // 簡單的日期計算 (如果主行程有日期)
            let dayDate = null;
            if (tripData && tripData.startDate) {
                const startDateMs = tripData.startDate.toMillis();
                dayDate = Timestamp.fromMillis(startDateMs + (nextDayOrder - 1) * 24 * 60 * 60 * 1000);
            }
            
            // 建立新的天數資料
            const newDayData = {
                dayOrder: nextDayOrder, // 用於排序
                theme: `Day ${nextDayOrder} 主題 (可編輯)`,
                date: dayDate,
                activityCount: 0,
                lastEditorUid: currentUserId,
                lastEditorName: currentUserName, 
                lastEditedTime: Timestamp.now()
            };

            try {
                // 寫入 Firestore: artifacts/{appId}/public/data/trips/{tripId}/days
                await addDoc(daysColRef, newDayData);
                
                // 同步更新主行程的 daysCount 欄位
                await updateDoc(tripDocRef, {
                    daysCount: nextDayOrder,
                    lastEditorUid: currentUserId,
                    lastEditorName: currentUserName, 
                    lastEditedTime: Timestamp.now()
                });
                
                // onSnapshot 會自動更新列表
                console.log(`成功新增 Day ${nextDayOrder}`);

            } catch (error) {
                console.error("新增天數失敗:", error);
                alert(`新增天數失敗: ${error.message}`); // 應使用自訂 Modal
            }
        });

        // 當頁面被卸載時，取消 Firestore 的監聽
        window.addEventListener('beforeunload', () => {
            if (unsubscribeDays) {
                unsubscribeDays();
            }
        });

    </script>
</body>
</html>