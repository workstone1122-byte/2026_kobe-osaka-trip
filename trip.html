<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥æˆ¶å¤§é˜ª 5 å¤© 4 å¤œ è¡Œç¨‹ (å¯ç·¨è¼¯)</title>
    <!-- å¼•å…¥ Bootstrap CSS 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- å¼•å…¥ Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .travel-header {
            background: linear-gradient(135deg, #007bff, #00c6ff);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
        .day-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
            border-left: 5px solid #007bff;
            overflow: hidden;
            cursor: pointer; /* è®“å¡ç‰‡å¯ä»¥é»æ“Šé–‹å•Ÿç·¨è¼¯ */
        }
        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .day-marker {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .loading-state {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #6c757d;
        }
        /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            border: none;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: 5px 8px;
            color: #dc3545;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .delete-btn:hover {
            opacity: 1;
            background: white;
        }
    </style>
</head>
<body>

    <!-- Header å€å¡Š -->
    <header class="travel-header">
        <div class="container text-center">
            <h1 class="display-4"><i class="fas fa-plane-departure me-2"></i> ç¥æˆ¶å¤§é˜ª 5 å¤© 4 å¤œ</h1>
            <p class="lead">è¡Œç¨‹æ•¸æ“šä¾†è‡ª Firebase Firestore å¯¦æ™‚åŒæ­¥ã€‚</p>
            <nav class="mt-3">
                <a href="trip.html" class="btn btn-light btn-sm mx-1">è¡Œç¨‹ç¸½è¦½</a>
                <a href="features.html" class="btn btn-outline-light btn-sm mx-1">å…¶ä»–åŠŸèƒ½</a>
            </nav>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å®¹å™¨ -->
    <main class="container">
        <!-- è¡Œç¨‹å…§å®¹å€å¡Š -->
        <div id="itinerary-content">
             <div class="d-flex justify-content-between align-items-center mb-4">
                <p class="text-muted mb-0">æ‚¨å·²æˆåŠŸç™»å…¥ï¼Œè¡Œç¨‹æ•¸æ“šæ­£åœ¨å¯¦æ™‚åŒæ­¥...</p>
                <div>
                    <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ•ï¼šç›´æ¥æ‰“é–‹æ¨¡æ…‹æ¡†ï¼Œä¸¦è¨­å®šç‚ºæ–°å¢æ¨¡å¼ -->
                    <button class="btn btn-success me-2" onclick="openEditModal(null)">
                        <i class="fas fa-plus me-1"></i> æ–°å¢è¡Œç¨‹
                    </button>
                    <!-- ç™»å‡ºæŒ‰éˆ• -->
                    <button class="btn btn-outline-secondary" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt me-1"></i> ç™»å‡º
                    </button>
                </div>
            </div>

            <!-- è®€å–ç‹€æ…‹æˆ–æ“ä½œè¨Šæ¯æœƒé¡¯ç¤ºåœ¨æ­¤ -->
            <div id="itinerary-status" class="loading-state">
                <i class="fas fa-spinner fa-spin me-2"></i> æ­£åœ¨æª¢æŸ¥ç™»å…¥ç‹€æ…‹...
            </div>
            
            <!-- è¡Œç¨‹å¡ç‰‡å°‡è¢« JavaScript æ’å…¥æ­¤è™• -->
            <div id="itinerary-list" class="row">
                <!-- Data will be populated here -->
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨è³‡è¨Š (å¯é¸) -->
    <footer class="text-center text-muted py-4 mt-5 border-top">
        <p><i class="fas fa-database me-1"></i> Data powered by Firebase Firestore.</p>
    </footer>

    <!-- Bootstrap 5 JS æª”æ¡ˆ (Modal éœ€è¦) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- 1. å¼•å…¥ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // *** è«‹ä½¿ç”¨æ‚¨å°ˆæ¡ˆçš„çœŸå¯¦ Firebase Config ***
        // ğŸš¨ è¨˜å¾—æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® ğŸš¨
        const firebaseConfig = {
            apiKey: "AIzaSyBsMiLUgtJtcv48iRp_9QFx5fShtRd6Lro",
            authDomain: "kobe-osaka-2026travel.firebaseapp.com",
            projectId: "kobe-osaka-2026travel",
            storageBucket: "kobe-osaka-2026travel.firebasestorage.app",
            messagingSenderId: "772246724994",
            appId: "1:772246724994:web:26c067ae1096d13ebdef9b"
        };

        // DOM å…ƒç´ åƒè€ƒ
        const itineraryList = document.getElementById('itinerary-list');
        const itineraryStatus = document.getElementById('itinerary-status');
        
        let db;
        let auth;
        let unsubscribe = null; 
        let currentModal; 
        let isEditMode = false; 
        let currentDocId = null; 

        // 1. åˆå§‹åŒ– Firebase æœå‹™
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log("Firebase initialized successfully."); // èª¿è©¦è¨Šæ¯
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            itineraryStatus.innerHTML = '<div class="alert alert-danger text-center" role="alert"><i class="fas fa-times-circle"></i> Firebase åˆå§‹åŒ–å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ config è¨­å®šã€‚</div>';
        }

        /**
         * è™•ç†è¡Œç¨‹è³‡æ–™çš„å¯¦æ™‚ç›£è½èˆ‡æ¸²æŸ“
         */
        function startItineraryListener() {
            if (unsubscribe) {
                unsubscribe();
            }

            itineraryStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> æ­£åœ¨å¾ Firestore è¼‰å…¥è¡Œç¨‹...';
            itineraryList.innerHTML = '';

            // å¯¦æ™‚ç›£è½ 'itinerary' é›†åˆï¼Œä¸¦ä¾æ–‡ä»¶ ID æ’åº (Day1, Day2 é€™æ¨£çš„å‘½åå¯ä»¥é€é documentId æ’åº)
            unsubscribe = db.collection("itinerary").orderBy(firebase.firestore.FieldPath.documentId(), "asc")
                .onSnapshot((querySnapshot) => {
                    itineraryList.innerHTML = ''; 
                    itineraryStatus.innerHTML = ''; // æ¸…é™¤ loading ç‹€æ…‹
                    
                    if (querySnapshot.empty) {
                        itineraryStatus.innerHTML = '<div class="alert alert-warning text-center" role="alert"><i class="fas fa-exclamation-triangle me-2"></i> è³‡æ–™åº«ä¸­æ²’æœ‰æ‰¾åˆ°è¡Œç¨‹è³‡æ–™ (itinerary é›†åˆ)ã€‚è«‹é»æ“Šã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹è¦åŠƒã€‚</div>';
                        console.log("Firestore: Itinerary collection is empty."); 
                        return;
                    }

                    console.log(`Firestore: Found ${querySnapshot.size} itinerary documents.`); 

                    // éæ­·æ‰€æœ‰æ–‡ä»¶ä¸¦ç”Ÿæˆ HTML
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        
                        const dayMatch = docId.match(/Day(\d+)/i);
                        const dayDisplay = dayMatch ? `DAY ${dayMatch[1]}` : docId.toUpperCase();

                        // ç¢ºä¿è³‡æ–™æ˜¯ HTML å®‰å…¨çš„ï¼Œç‰¹åˆ¥æ˜¯å–®å¼•è™Ÿ (&#39;)ï¼Œä»¥ä¾¿å‚³éçµ¦ openEditModal
                        const safeLocation = (data.location || 'åœ°é»æœªå®š').replace(/'/g, '&#39;');
                        const safeDescription = (data.description || 'é»æ“Šç·¨è¼¯è©³ç´°æè¿°...').replace(/'/g, '&#39;');
                        const safeArea = (data.area || 'é—œè¥¿åœ°å€').replace(/'/g, '&#39;');

                        const cardHtml = `
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="day-card p-4 position-relative" onclick="openEditModal('${docId}', '${safeLocation}', '${safeDescription}', '${safeArea}')">
                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteDay('${docId}')" title="åˆªé™¤è¡Œç¨‹">
                                        <i class="fas fa-trash-alt fa-lg"></i>
                                    </button>
                                    <div class="day-marker">${dayDisplay}</div>
                                    <h5 class="mt-2 text-primary">${data.location || 'åœ°é»æœªå®š'}</h5>
                                    <p class="text-secondary">${data.description || 'é»æ“Šç·¨è¼¯è©³ç´°æè¿°...'}</p>
                                    <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i> ${data.area || 'é—œè¥¿åœ°å€'}</small>
                                </div>
                            </div>
                        `;
                        itineraryList.innerHTML += cardHtml;
                    });

                }, (error) => {
                    console.error("å¯¦æ™‚ç›£è½è³‡æ–™å¤±æ•—: ", error);
                    itineraryStatus.innerHTML = `<div class="alert alert-danger text-center" role="alert"><i class="fas fa-lock"></i> è³‡æ–™è®€å–å¤±æ•—ã€‚åŸå› ï¼š**æ¬Šé™ä¸è¶³** (Firebase Rules) æˆ–ç¶²è·¯éŒ¯èª¤ã€‚è«‹ç¢ºèªæ‚¨å·²ç™»å…¥ä¸”è¦å‰‡å·²è¨­å®šç‚ºå…è¨±è®€å–ã€‚</div>`;
                });
        }

        // --- CRUD æ“ä½œå‡½æ•¸ ---

        /**
         * é–‹å•Ÿæ–°å¢æˆ–ç·¨è¼¯è¡Œç¨‹çš„ Modal
         */
        function openEditModal(docId = null, location = '', description = '', area = '') {
            const title = document.getElementById('add-day-modal-title');
            const dayNumInput = document.getElementById('day-num-input');
            const submitButton = document.getElementById('submit-day-button');
            const modalErrorDiv = document.getElementById('modal-error');

            modalErrorDiv.style.display = 'none';
            document.getElementById('add-day-form').reset();
            
            isEditMode = docId !== null;
            currentDocId = docId;

            if (isEditMode) {
                // ç·¨è¼¯æ¨¡å¼
                title.textContent = `ç·¨è¼¯è¡Œç¨‹ï¼š${docId.toUpperCase()}`;
                submitButton.textContent = 'å„²å­˜è®Šæ›´';
                
                const dayMatch = docId.match(/Day(\d+)/i);
                if (dayMatch) {
                    dayNumInput.value = dayMatch[1];
                    dayNumInput.disabled = true; // ç·¨è¼¯æ™‚ä¸å…è¨±ä¿®æ”¹ Day æ•¸å­—
                }
                
                // å¡«å……ç¾æœ‰è³‡æ–™ (å°‡ &#39; è½‰æ›å› ' ä»¥ä¾¿ç·¨è¼¯)
                document.getElementById('location-input').value = location.replace(/&#39;/g, "'");
                document.getElementById('description-input').value = description.replace(/&#39;/g, "'");
                document.getElementById('area-input').value = area.replace(/&#39;/g, "'");
            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = 'æ–°å¢è¡Œç¨‹æ—¥';
                submitButton.textContent = 'æ–°å¢è¡Œç¨‹';
                dayNumInput.disabled = false;
            }
            
            currentModal.show();
        }
        window.openEditModal = openEditModal; 

        /**
         * è™•ç†è¡¨å–®æäº¤ï¼šæ–°å¢æˆ–æ›´æ–°è¡Œç¨‹
         */
        async function submitDayForm() {
            const dayNum = document.getElementById('day-num-input').value.trim();
            const location = document.getElementById('location-input').value.trim();
            const description = document.getElementById('description-input').value.trim();
            const area = document.getElementById('area-input').value.trim();
            const modalErrorDiv = document.getElementById('modal-error');
            const submitButton = document.getElementById('submit-day-button');
            const originalButtonText = submitButton.textContent; 

            modalErrorDiv.style.display = 'none';

            if (!dayNum || isNaN(parseInt(dayNum)) || parseInt(dayNum) < 1) {
                modalErrorDiv.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Day æ•¸å­— (ä¾‹å¦‚: 3)';
                modalErrorDiv.style.display = 'block';
                return;
            }
            
            const docId = `Day${dayNum}`; 
            
            // å•Ÿç”¨è¼‰å…¥ç‹€æ…‹
            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> ${isEditMode ? 'å„²å­˜ä¸­...' : 'æ–°å¢ä¸­...'}`;

            const newDayData = {
                location: location || 'åœ°é»æœªå®š',
                description: description || 'é»æ“Šæ–‡ä»¶ä¾†æ–°å¢è©³ç´°æè¿°...',
                area: area || 'é—œè¥¿åœ°å€',
                // ç¢ºä¿åªæœ‰æ–°å¢æ™‚æ‰è¨­å®š createdAtï¼Œæ›´æ–°æ™‚åªè¨­å®š updatedAt
                createdAt: isEditMode ? undefined : firebase.firestore.FieldValue.serverTimestamp(), 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ currentDocIdï¼›æ–°å¢æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨æ–°çš„ docId
            let finalDocId = isEditMode ? currentDocId : docId;

            try {
                // ä½¿ç”¨ set() ä¸¦è¨­å®š merge: trueï¼Œä»¥ä¾¿åªæ›´æ–°æä¾›çš„æ¬„ä½ï¼Œä¸¦å‰µå»ºæ–°æ–‡ä»¶
                await db.collection("itinerary").doc(finalDocId).set(newDayData, { merge: true });

                currentModal.hide();
                itineraryStatus.innerHTML = `<div class="alert alert-success alert-dismissible fade show text-center" role="alert">è¡Œç¨‹ **${finalDocId}** ${isEditMode ? 'æ›´æ–°' : 'æ–°å¢'}æˆåŠŸï¼
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                console.log(`Firestore: Document ${finalDocId} successfully ${isEditMode ? 'updated' : 'added'}.`); 

            } catch (error) {
                console.error("æ–°å¢/æ›´æ–°è¡Œç¨‹å¤±æ•—:", error);
                modalErrorDiv.textContent = `æ“ä½œå¤±æ•—: ${error.message}ã€‚è«‹ç¢ºèª Firestore å¯«å…¥æ¬Šé™ (Rules)ã€‚`;
                modalErrorDiv.style.display = 'block';
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }
        window.submitDayForm = submitDayForm;

        /**
         * åˆªé™¤æŒ‡å®šè¡Œç¨‹
         */
        function deleteDay(docId) {
            // ä½¿ç”¨é alert çš„æ–¹å¼è¦æ±‚ç¢ºèª (é€™è£¡ä½¿ç”¨åŸç”Ÿçš„ confirm)
            const isConfirmed = confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ ${docId} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`);
            if (!isConfirmed) return;

            db.collection("itinerary").doc(docId).delete().then(() => {
                itineraryStatus.innerHTML = `<div class="alert alert-success alert-dismissible fade show text-center" role="alert">è¡Œç¨‹ **${docId}** åˆªé™¤æˆåŠŸï¼
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                console.log(`Firestore: Document ${docId} successfully deleted.`); 
            }).catch((error) => {
                console.error("åˆªé™¤è¡Œç¨‹å¤±æ•—:", error);
                itineraryStatus.innerHTML = `<div class="alert alert-danger text-center" role="alert">åˆªé™¤è¡Œç¨‹å¤±æ•—: ${error.message}ã€‚è«‹ç¢ºèª Firestore åˆªé™¤æ¬Šé™ (Rules)ã€‚</div>`;
            });
        }
        window.deleteDay = deleteDay; 
        
        // --- ç™»å…¥/ç™»å‡ºé‚è¼¯ ---
        
        function handleLogout() {
            auth.signOut().then(() => {
                // ç™»å‡ºæˆåŠŸå¾Œè·³è½‰å›ç™»å…¥é é¢
                window.location.href = 'index.html'; 
            }).catch((error) => {
                console.error("ç™»å‡ºå¤±æ•—:", error);
            });
        }
        window.handleLogout = handleLogout;


        // 3. ç›£è½ Firebase èº«ä»½é©—è­‰ç‹€æ…‹è®ŠåŒ–
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log(`Auth State: User logged in with UID: ${user.uid}`); 
                // ä½¿ç”¨è€…å·²ç™»å…¥ï¼šå•Ÿå‹• Firestore å¯¦æ™‚ç›£è½
                startItineraryListener();
            } else {
                console.log("Auth State: User not logged in, redirecting to index.html."); 
                // ä½¿ç”¨è€…æœªç™»å…¥ï¼šå¼·åˆ¶è·³è½‰å›ç™»å…¥é é¢
                window.location.href = 'index.html';
            }
        });

        // åˆå§‹åŒ– Modal å¯¦ä¾‹
        document.addEventListener('DOMContentLoaded', () => {
            // ç”±æ–¼ Bootstrap Modal éœ€è¦å¯¦ä¾‹åŒ–
            currentModal = new bootstrap.Modal(document.getElementById('add-day-modal'));

            // ç¢ºä¿æ¯æ¬¡ Modal é—œé–‰æ™‚æ¸…é™¤ç·¨è¼¯ç‹€æ…‹å’ŒéŒ¯èª¤è¨Šæ¯
            const modalElement = document.getElementById('add-day-modal');
            modalElement.addEventListener('hidden.bs.modal', function () {
                document.getElementById('modal-error').style.display = 'none';
                document.getElementById('day-num-input').disabled = false;
                isEditMode = false;
                currentDocId = null;
            });
        });
    </script>

    <!-- æ–°å¢/ç·¨è¼¯è¡Œç¨‹ Modal æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="add-day-modal" tabindex="-1" aria-labelledby="add-day-modal-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-day-modal-title">æ–°å¢è¡Œç¨‹æ—¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-error" class="alert alert-danger" style="display: none;"></div>
                    <form id="add-day-form">
                        <div class="mb-3">
                            <label for="day-num-input" class="form-label">Day æ•¸å­— (ä¾‹å¦‚: 3)</label>
                            <input type="number" class="form-control" id="day-num-input" required min="1" placeholder="è¼¸å…¥ Day æ•¸å­—">
                            <div class="form-text text-muted">è«‹ä½¿ç”¨æ•¸å­— (ä¾‹å¦‚ 1, 2, 3...)ï¼Œé€™å°‡æ±ºå®šè¡Œç¨‹çš„æ’åºã€‚</div>
                        </div>
                        <div class="mb-3">
                            <label for="location-input" class="form-label">åœ°é»åç¨±</label>
                            <input type="text" class="form-control" id="location-input" placeholder="ä¾‹å¦‚: ç’°çƒå½±åŸ">
                        </div>
                        <div class="mb-3">
                            <label for="description-input" class="form-label">è©³ç´°æè¿°</label>
                            <textarea class="form-control" id="description-input" rows="3" placeholder="ä¾‹å¦‚: æ—©ä¸Šæ­è»Šï¼Œä¸­åˆç©å“ˆåˆ©æ³¢ç‰¹å€..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="area-input" class="form-label">å€åŸŸ (åŸå¸‚)</label>
                            <input type="text" class="form-control" id="area-input" placeholder="ä¾‹å¦‚: å¤§é˜ª">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="submit-day-button" onclick="submitDayForm()">æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>