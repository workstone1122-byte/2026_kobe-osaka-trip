<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">è¡Œç¨‹è¼‰å…¥ä¸­...</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        .page-container { max-width: 640px; }
        .schedule-item { transition: all 0.2s ease-in-out; }
        .schedule-item:hover { background-color: #f3f4f6; }
        /* æ‡¸æµ®æ–°å¢æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
        @media (min-width: 640px) {
            /* è®“æŒ‰éˆ•åœ¨ PC æ¨¡å¼ä¸‹ï¼Œä¹Ÿä¿æŒåœ¨å…§å®¹å€åŸŸçš„å³ä¸‹æ–¹ */
            .fab {
                right: calc(50% - 320px + 24px); 
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- é é¢é ‚éƒ¨å°èˆªåˆ— -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="page-container mx-auto flex justify-between items-center p-4">
            <button id="back-to-list" class="text-indigo-600 hover:text-indigo-800 transition duration-150 p-2 rounded-full active:bg-indigo-50 flex items-center">
                <!-- Lucide: Arrow Left -->
                <script>document.write(lucide.createIcons()['arrow-left'].toSvg({ class: 'h-6 w-6 mr-1' }));</script>
                <span class="hidden sm:inline">è¿”å›åˆ—è¡¨</span>
            </button>
            <h1 id="trip-name-display" class="text-xl font-bold text-gray-800 truncate flex-grow text-center mx-4">è¡Œç¨‹è¼‰å…¥ä¸­...</h1>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <main class="page-container mx-auto p-4">
        
        <!-- è¡Œç¨‹è³‡è¨Š (æˆå“¡åˆ—è¡¨) -->
        <div class="mb-6 p-4 bg-indigo-100 border border-indigo-200 rounded-lg text-sm text-indigo-700 flex justify-between items-center">
            <div>
                <span class="font-medium">å…±åŒç·¨è¼¯è€…:</span> 
                <span id="member-list" class="font-mono text-xs break-all ml-1">è¼‰å…¥ä¸­...</span>
            </div>
            <!-- å¯ä»¥æ”¾ä¸€å€‹é‚€è«‹æŒ‰éˆ• -->
            <button id="invite-button" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-600 transition duration-150">
                é‚€è«‹
            </button>
        </div>

        <!-- æ¯æ—¥è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
        <div id="schedule-list" class="space-y-6">
            <!-- æ¯æ—¥è¡Œç¨‹å¡ç‰‡å°‡é€šé JavaScript æ¸²æŸ“åœ¨æ­¤è™• -->
        </div>

        <!-- ç©ºè¡Œç¨‹æç¤º (é è¨­éš±è—) -->
        <div id="no-schedules-message" class="hidden text-center mt-20 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
            <span class="text-6xl" role="img" aria-label="Map Emoji">ğŸ—ºï¸</span>
            <p class="mt-4 text-xl font-semibold text-gray-700">å°šæœªæ–°å¢ä»»ä½•è¡Œç¨‹æ—¥</p>
            <p class="text-gray-500 mt-2">é»æ“Šå³ä¸‹è§’çš„ <span class="font-bold">+</span> æŒ‰éˆ•ï¼Œæ–°å¢æ‚¨çš„ç¬¬ä¸€å¤©è¡Œç¨‹ï¼</p>
        </div>
    </main>
    
    <!-- æ‡¸æµ®æ–°å¢æŒ‰éˆ• (FAB) -->
    <button id="add-schedule-fab" class="fab p-4 bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 transition duration-200 ease-in-out transform hover:scale-105 active:scale-95" title="æ–°å¢è¡Œç¨‹æ—¥">
        <!-- Lucide: Plus Icon -->
        <script>document.write(lucide.createIcons()['plus'].toSvg({ class: 'h-8 w-8' }));</script>
    </button>
    
    <!-- è‡ªè¨‚è¼¸å…¥ Modal (æ–°å¢è¡Œç¨‹æ—¥) -->
    <div id="new-schedule-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">æ–°å¢è¡Œç¨‹æ—¥</h3>
            <form id="new-schedule-form">
                <label for="schedule-name" class="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥è¡Œç¨‹æ—¥åç¨±ï¼š</label>
                <input type="text" id="schedule-name" required maxlength="50"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å¤© - å¤§é˜ªç’°çƒå½±åŸ">
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-new-schedule"
                            class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="create-schedule-button"
                            class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">
                        å»ºç«‹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- åˆªé™¤ç¢ºèª Modal (å–ä»£ confirm()) -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-red-700">ç¢ºèªåˆªé™¤</h3>
            <p id="delete-modal-message" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹æ—¥å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete"
                        class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                    å–æ¶ˆ
                </button>
                <button type="button" id="confirm-delete"
                        class="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">
                    ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>


    <!-- è¼‰å…¥ Firebase æ ¸å¿ƒæ¨¡çµ„èˆ‡ç™»å…¥å®ˆè¡› -->
    <script type="module" src="./auth.js"></script>
    <script type="module" src="./auth-guard.js"></script>

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { auth, db } from './auth.js';
        import { collection, doc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI å…ƒç´  ---
        const pageTitleElement = document.getElementById('page-title');
        const tripNameDisplay = document.getElementById('trip-name-display');
        const memberListElement = document.getElementById('member-list');
        const scheduleListElement = document.getElementById('schedule-list');
        const noSchedulesMessage = document.getElementById('no-schedules-message');
        const addScheduleFab = document.getElementById('add-schedule-fab');
        const backToListButton = document.getElementById('back-to-list');
        
        // Modal å…ƒç´  (æ–°å¢è¡Œç¨‹æ—¥)
        const newScheduleModal = document.getElementById('new-schedule-modal');
        const newScheduleForm = document.getElementById('new-schedule-form');
        const scheduleNameInput = document.getElementById('schedule-name');
        const cancelNewScheduleButton = document.getElementById('cancel-new-schedule');
        const createScheduleButton = document.getElementById('create-schedule-button');
        
        // Modal å…ƒç´  (åˆªé™¤ç¢ºèª)
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        let scheduleToDeleteId = null; // æš«å­˜è¦åˆªé™¤çš„è¡Œç¨‹æ—¥ ID

        // --- å…¨åŸŸè®Šæ•¸ ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let tripId = null;
        let tripDocUnsubscribe = null;
        let schedulesUnsubscribe = null;
        

        // --- è¼”åŠ©å‡½æ•¸ ---
        const getTripIdFromUrl = () => {
            const params = new URLSearchParams(window.location.search);
            return params.get('tripId');
        };
        
        // é¡¯ç¤ºåˆªé™¤ç¢ºèª Modal
        const showDeleteModal = (scheduleId, name) => {
            scheduleToDeleteId = scheduleId;
            document.getElementById('delete-modal-message').textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹æ—¥ "${name}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
            deleteModal.classList.remove('hidden');
        };

        // éš±è—åˆªé™¤ç¢ºèª Modal
        const hideDeleteModal = () => {
            deleteModal.classList.add('hidden');
            scheduleToDeleteId = null;
        };
        
        // åˆªé™¤æ“ä½œé‚è¼¯
        const handleDeleteSchedule = async () => {
            if (!scheduleToDeleteId || !tripId) return;

            hideDeleteModal(); // å…ˆé—œé–‰ Modal

            try {
                // 1. åˆªé™¤å­é›†åˆä¸­çš„æ–‡ä»¶ (è¡Œç¨‹æ—¥)
                const scheduleRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', tripId, 'schedules', scheduleToDeleteId);
                await deleteDoc(scheduleRef);
                console.log(`è¡Œç¨‹æ—¥ ${scheduleToDeleteId} åˆªé™¤æˆåŠŸ.`);

                // 2. æ›´æ–°ä¸»è¡Œç¨‹æ–‡ä»¶çš„æ›´æ–°æ™‚é–“ (å¹«åŠ©åœ¨ index.html ä¸­æ’åº)
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', tripId), {
                    updatedAt: serverTimestamp()
                });

            } catch (error) {
                console.error("åˆªé™¤è¡Œç¨‹æ—¥å¤±æ•—:", error);
                // æ‡‰ä½¿ç”¨è‡ªè¨‚ Modal é¡¯ç¤ºéŒ¯èª¤
                // é€™è£¡ä½¿ç”¨åŸç”Ÿ alert() ä½œç‚ºç·Šæ€¥å‚™ç”¨ï¼Œå¯¦éš›æ‡‰ç”¨è«‹æ›¿æ›
                alert(`åˆªé™¤å¤±æ•—: ${error.message}`); 
            }
        };
        
        confirmDeleteButton.addEventListener('click', handleDeleteSchedule);
        cancelDeleteButton.addEventListener('click', hideDeleteModal);
        
        // --- æ¸²æŸ“å‡½æ•¸ ---
        
        // æ¸²æŸ“å–®å€‹è¡Œç¨‹æ—¥å¡ç‰‡
        const renderScheduleCard = (schedule) => {
            const card = document.createElement('div');
            card.className = 'schedule-item bg-white p-5 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between';
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">${schedule.name}</h3>
                    <p class="text-sm text-gray-500 mt-1">è¦åŠƒé …ç›®æ•¸: ${schedule.itemsCount || 0}</p>
                    <p class="text-xs text-gray-400 mt-2">å‰µå»ºæ–¼: ${schedule.createdAt ? new Date(schedule.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : 'N/A'}</p>
                </div>
                <div class="flex space-x-2">
                    <!-- ç·¨è¼¯æŒ‰éˆ• (åŠŸèƒ½å¾…å¯¦ä½œ) -->
                    <button data-id="${schedule.id}" data-name="${schedule.name}" class="edit-schedule p-2 text-indigo-500 hover:text-indigo-700 rounded-full hover:bg-indigo-50 transition duration-150" title="ç·¨è¼¯é …ç›®">
                        <script>document.write(lucide.createIcons()['edit'].toSvg({ class: 'h-5 w-5' }));</script>
                    </button>
                    <!-- åˆªé™¤æŒ‰éˆ• -->
                    <button data-id="${schedule.id}" data-name="${schedule.name}" class="delete-schedule p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-50 transition duration-150" title="åˆªé™¤è¡Œç¨‹æ—¥">
                        <script>document.write(lucide.createIcons()['trash-2'].toSvg({ class: 'h-5 w-5' }));</script>
                    </button>
                </div>
            `;
            
            // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            card.querySelector('.delete-schedule').addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ç·¨è¼¯
                const id = e.currentTarget.dataset.id;
                const name = e.currentTarget.dataset.name;
                showDeleteModal(id, name);
            });
            
            // ç·¨è¼¯æŒ‰éˆ•äº‹ä»¶ (ç›®å‰åªæ˜¯ placeholder)
            card.querySelector('.edit-schedule').addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å¡ç‰‡é»æ“Š
                // TODO: é»æ“Šå¾Œæ‡‰å°å‘åˆ°æ›´è©³ç´°çš„è¡Œç¨‹è¦åŠƒé é¢
                // é€™è£¡å¿…é ˆæ”¹ç‚ºå°å‘åˆ°ä¸‹ä¸€å€‹é é¢ï¼Œä¾‹å¦‚ trip_day_detail.html?tripId=...&scheduleId=...
                alert(`æº–å‚™ç·¨è¼¯è¡Œç¨‹æ—¥: ${schedule.name} (ID: ${schedule.id})ã€‚æ­¤åŠŸèƒ½å³å°‡å¯¦ä½œã€‚`);
            });
            
            // é»æ“Šå¡ç‰‡ï¼Œæ‡‰å°å‘åˆ°è©³ç´°è¦åŠƒé é¢
            // card.addEventListener('click', () => { ... });

            return card;
        };


        // --- Firestore ç›£è½å™¨ ---

        // ç›£è½ä¸»è¡Œç¨‹æ–‡ä»¶ (trip document)
        const startTripDocListener = (id) => {
            if (tripDocUnsubscribe) tripDocUnsubscribe(); // å–æ¶ˆèˆŠçš„ç›£è½
            
            const tripRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', id);
            
            tripDocUnsubscribe = onSnapshot(tripRef, (tripDoc) => {
                if (tripDoc.exists()) {
                    const data = tripDoc.data();
                    
                    // æ›´æ–° UI è³‡è¨Š
                    const tripName = data.name || 'æœªå‘½åè¡Œç¨‹';
                    pageTitleElement.textContent = tripName;
                    tripNameDisplay.textContent = tripName;
                    
                    // æ›´æ–°æˆå“¡åˆ—è¡¨ (é¡¯ç¤º UIDï¼Œå› ç‚ºæˆ‘å€‘æ²’æœ‰ç”¨æˆ¶åæœå‹™)
                    const members = data.members || [];
                    memberListElement.innerHTML = members.length > 0 ? members.join(', ') : auth.currentUser.uid;
                    
                } else {
                    console.error("è¡Œç¨‹æ–‡ä»¶ä¸å­˜åœ¨:", id);
                    tripNameDisplay.textContent = 'è¡Œç¨‹ä¸å­˜åœ¨';
                    pageTitleElement.textContent = 'è¡Œç¨‹ä¸å­˜åœ¨';
                    // é€™è£¡ä½¿ç”¨åŸç”Ÿ alert() ä½œç‚ºç·Šæ€¥å‚™ç”¨ï¼Œå¯¦éš›æ‡‰ç”¨è«‹æ›¿æ›
                    alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²è¡Œç¨‹ï¼å°‡è¿”å›åˆ—è¡¨ã€‚'); 
                    window.location.replace('./index.html');
                }
            }, (error) => {
                console.error("ç›£è½ä¸»è¡Œç¨‹æ–‡ä»¶å¤±æ•—:", error);
                // é€™è£¡ä½¿ç”¨åŸç”Ÿ alert() ä½œç‚ºç·Šæ€¥å‚™ç”¨ï¼Œå¯¦éš›æ‡‰ç”¨è«‹æ›¿æ›
                alert(`è¼‰å…¥è¡Œç¨‹è©³ç´°è³‡è¨Šå¤±æ•—: ${error.message}`); 
                window.location.replace('./index.html');
            });
        };
        
        // ç›£è½æ¯æ—¥è¡Œç¨‹å­é›†åˆ (schedules subcollection)
        const startSchedulesListener = (id) => {
            if (schedulesUnsubscribe) schedulesUnsubscribe(); // å–æ¶ˆèˆŠçš„ç›£è½

            const schedulesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips', id, 'schedules');
            // æ³¨æ„: æˆ‘å€‘åœ¨é€™è£¡é¿å…ä½¿ç”¨ orderBy ä»¥é˜²ç´¢å¼•éŒ¯èª¤ã€‚å®¢æˆ¶ç«¯æ’åºã€‚
            const q = schedulesRef; 

            schedulesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const schedules = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    schedules.push({
                        id: doc.id,
                        name: data.name || 'ç¬¬ X å¤©',
                        itemsCount: data.itemsCount || 0, // å‡è¨­æœ‰ä¸€å€‹ itemsCount æ¬„ä½
                        createdAt: data.createdAt,
                    });
                });
                
                // å®¢æˆ¶ç«¯æ’åº: æ ¹æ“šå‰µå»ºæ™‚é–“å‡åº (èˆŠçš„åœ¨å‰é¢)
                schedules.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.seconds : 0;
                    const dateB = b.createdAt ? b.createdAt.seconds : 0;
                    return dateA - dateB;
                });
                
                // æ¸²æŸ“ UI
                scheduleListElement.innerHTML = '';
                if (schedules.length === 0) {
                    noSchedulesMessage.classList.remove('hidden');
                } else {
                    noSchedulesMessage.classList.add('hidden');
                    schedules.forEach(schedule => {
                        scheduleListElement.appendChild(renderScheduleCard(schedule));
                    });
                }
            }, (error) => {
                console.error("ç›£è½æ¯æ—¥è¡Œç¨‹å¤±æ•—:", error);
                // é€™è£¡åªé¡¯ç¤ºéŒ¯èª¤ï¼Œä¸å¼·åˆ¶è·³è½‰ï¼Œè®“ç”¨æˆ¶å¯ä»¥å˜—è©¦ä¿®å¾©æˆ–åˆ·æ–°
                scheduleListElement.innerHTML = `<p class="text-red-500 text-center">è¼‰å…¥è¡Œç¨‹åˆ—è¡¨å¤±æ•—ï¼š${error.message}</p>`;
            });
        };
        

        // --- é é¢åˆå§‹åŒ–èˆ‡äº‹ä»¶è™•ç† ---
        
        // è¿”å›æŒ‰éˆ•ä½¿ç”¨ç›¸å°è·¯å¾‘
        backToListButton.addEventListener('click', () => {
            window.location.href = './index.html';
        });

        // é»æ“Š '+' æŒ‰éˆ•é¡¯ç¤º Modal
        addScheduleFab.addEventListener('click', () => {
            if (!tripId) {
                // é€™è£¡ä½¿ç”¨åŸç”Ÿ alert() ä½œç‚ºç·Šæ€¥å‚™ç”¨ï¼Œå¯¦éš›æ‡‰ç”¨è«‹æ›¿æ›
                alert("éŒ¯èª¤ï¼šè¡Œç¨‹ ID éºå¤±ã€‚è«‹è¿”å›åˆ—è¡¨ã€‚");
                return;
            }
            newScheduleModal.classList.remove('hidden');
            scheduleNameInput.focus();
        });
        
        // å–æ¶ˆæ–°å¢æŒ‰éˆ•é‚è¼¯
        cancelNewScheduleButton.addEventListener('click', () => {
            newScheduleModal.classList.add('hidden');
            newScheduleForm.reset(); 
        });
        
        // è™•ç†æ–°å¢è¡Œç¨‹æ—¥è¡¨å–®æäº¤
        newScheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const scheduleName = scheduleNameInput.value.trim();
            
            if (!scheduleName || !tripId) return; 
            
            createScheduleButton.disabled = true;
            createScheduleButton.textContent = 'å»ºç«‹ä¸­...';
            
            try {
                const schedulesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips', tripId, 'schedules');
                
                // 1. æº–å‚™æ–°çš„è¡Œç¨‹æ—¥è³‡æ–™
                const newScheduleData = {
                    name: scheduleName,
                    items: [], // æ¯æ—¥è¦åŠƒé …ç›®åˆ—è¡¨
                    itemsCount: 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };
                
                // 2. å¯«å…¥ Firestore
                await addDoc(schedulesRef, newScheduleData);
                console.log("æ–°è¡Œç¨‹æ—¥å¯«å…¥æˆåŠŸ");
                
                // 3. æ›´æ–°ä¸»è¡Œç¨‹æ–‡ä»¶çš„æ›´æ–°æ™‚é–“ (å¹«åŠ©æ’åº)
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', tripId), {
                    updatedAt: serverTimestamp()
                });

                // 4. éš±è— Modal
                newScheduleModal.classList.add('hidden');
                newScheduleForm.reset(); 
                
            } catch (error) {
                console.error("æ–°å¢è¡Œç¨‹æ—¥å¤±æ•—:", error);
                // é€™è£¡ä½¿ç”¨åŸç”Ÿ alert() ä½œç‚ºç·Šæ€¥å‚™ç”¨ï¼Œå¯¦éš›æ‡‰ç”¨è«‹æ›¿æ›
                alert("æ–°å¢è¡Œç¨‹æ—¥å¤±æ•—ï¼š" + error.message); 
            } finally {
                createScheduleButton.disabled = false;
                createScheduleButton.textContent = 'å»ºç«‹';
            }
        });
        
        // æš«æ™‚ç¦ç”¨é‚€è«‹æŒ‰éˆ•
        document.getElementById('invite-button').addEventListener('click', () => {
            alert('é‚€è«‹åŠŸèƒ½å°šæœªå¯¦ä½œã€‚è«‹ç›´æ¥åˆ†äº« URL æˆ–é‚€è«‹å…¶ä»–ç”¨æˆ¶ç™»å…¥å”ä½œã€‚');
        });


        // ç›£è½ auth-guard.js è§¸ç™¼çš„ 'authReady' äº‹ä»¶
        document.addEventListener('authReady', (e) => {
            tripId = getTripIdFromUrl();
            if (!tripId) {
                console.error("éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘ tripId åƒæ•¸ï¼å°å‘å›é¦–é ã€‚");
                window.location.replace('./index.html');
                return;
            }
            
            console.log(`Auth is ready. Starting listeners for Trip ID: ${tripId}`);
            startTripDocListener(tripId);
            startSchedulesListener(tripId);
        });

        // ç•¶é é¢è¢«å¸è¼‰æ™‚ï¼Œå–æ¶ˆ Firestore çš„æ‰€æœ‰ç›£è½
        window.addEventListener('beforeunload', () => {
            if (tripDocUnsubscribe) {
                tripDocUnsubscribe();
            }
            if (schedulesUnsubscribe) {
                schedulesUnsubscribe();
            }
            console.log("Firestore ç›£è½å·²å–æ¶ˆã€‚");
        });

    </script>
</body>
</html>