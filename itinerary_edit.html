<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯/新增行程</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        input[type="date"], input[type="time"], input[type="text"], textarea {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        input:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        .form-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body>

<div class="container-card">
    <h1 id="page-title" class="text-3xl font-bold text-gray-900 mb-6 text-center">新增行程項目</h1>
    <div id="status-message" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

    <form id="itinerary-form" class="space-y-6">
        <div>
            <label for="name" class="form-label">活動名稱 (Name)</label>
            <input type="text" id="name" name="name" required class="w-full">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="date" class="form-label">日期 (Date)</label>
                <input type="date" id="date" name="date" required class="w-full">
            </div>
            <div>
                <label for="time" class="form-label">時間 (Time)</label>
                <input type="time" id="time" name="time" class="w-full">
            </div>
        </div>

        <div>
            <label for="location" class="form-label">地點 (Location)</label>
            <input type="text" id="location" name="location" class="w-full">
        </div>

        <div>
            <label for="notes" class="form-label">備註 (Notes)</label>
            <textarea id="notes" name="notes" rows="4" class="w-full"></textarea>
        </div>

        <div class="flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            <button type="button" id="cancel-btn" class="w-full sm:w-1/3 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                取消
            </button>
            <button type="submit" id="save-btn" class="w-full sm:w-2/3 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                儲存行程
            </button>
        </div>
    </form>
</div>

<!-- Firebase Modules -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, setDoc, collection, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: Set debug level for firestore
    setLogLevel('Debug');

    let db;
    let auth;
    let userId = null;
    let itineraryId = null; // Store ID for editing purposes

    // --- 1. Firebase 初始化與身份驗證 ---
    const initializeFirebase = async () => {
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // 登入或使用自訂 token
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated. UID:", userId);
                    // 身份驗證完成後，才能初始化頁面邏輯
                    initializePage(); 
                } else {
                    console.error("Authentication failed. Cannot proceed with Firestore operations.");
                    displayStatus('error', '身份驗證失敗，無法存取資料庫。');
                }
            });

        } catch (error) {
            console.error("Firebase Auth Error:", error);
            displayStatus('error', '身份驗證失敗: ' + error.message);
        }
    };
    
    // --- 2. 輔助函數：顯示狀態訊息 ---
    const displayStatus = (type, message) => {
        const statusDiv = document.getElementById('status-message');
        statusDiv.textContent = message;
        statusDiv.className = `p-3 mb-4 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} block`;
    };

    // --- 3. 處理表單提交 (新增/編輯) ---
    const handleFormSubmit = async (event) => {
        event.preventDefault(); // 阻止表單預設提交行為 (這點非常重要！)

        if (!userId) {
            displayStatus('error', '使用者未認證，請稍候...');
            return;
        }

        const saveButton = document.getElementById('save-btn');
        saveButton.disabled = true;
        saveButton.textContent = itineraryId ? '正在更新...' : '正在儲存...';
        
        // 取得表單資料
        const formData = {
            name: document.getElementById('name').value,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            location: document.getElementById('location').value,
            notes: document.getElementById('notes').value,
            createdAt: itineraryId ? null : new Date().toISOString(), // 僅新增時記錄創建時間
            updatedAt: new Date().toISOString()
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // 私有資料路徑: /artifacts/{appId}/users/{userId}/itineraries
        const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/itineraries`);

        try {
            if (itineraryId) {
                // 編輯現有行程
                const docRef = doc(db, collectionRef.path, itineraryId);
                await setDoc(docRef, formData, { merge: true });
                displayStatus('success', '行程已成功更新！');
            } else {
                // 新增行程
                await addDoc(collectionRef, formData);
                displayStatus('success', '新行程已成功儲存！');
            }
            
            // --- 關鍵步驟：成功儲存後導航回清單頁 (現在是 index.html) ---
            setTimeout(() => {
                window.location.href = 'index.html'; // 導航回 index.html
            }, 1000); // 延遲 1 秒，讓使用者看到成功訊息

        } catch (error) {
            console.error("Firestore Save Error:", error);
            displayStatus('error', '儲存行程時發生錯誤: ' + error.message);
            saveButton.disabled = false;
            saveButton.textContent = itineraryId ? '更新行程失敗' : '儲存行程失敗';
        }
    };
    
    // --- 4. 處理初始化與編輯模式載入 ---
    const loadItineraryData = async (id) => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docPath = `artifacts/${appId}/users/${userId}/itineraries/${id}`;
        
        try {
            const docRef = doc(db, docPath);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('name').value = data.name || '';
                document.getElementById('date').value = data.date || '';
                document.getElementById('time').value = data.time || '';
                document.getElementById('location').value = data.location || '';
                document.getElementById('notes').value = data.notes || '';
            } else {
                displayStatus('error', '找不到該行程項目。');
            }
        } catch (error) {
            console.error("Firestore Load Error:", error);
            displayStatus('error', '載入行程資料時發生錯誤: ' + error.message);
        }
    };

    const initializePage = () => {
        // 1. 檢查 URL 參數以判斷是新增還是編輯
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        itineraryId = id;

        if (itineraryId) {
            document.getElementById('page-title').textContent = '編輯行程項目';
            document.getElementById('save-btn').textContent = '更新行程';
            loadItineraryData(itineraryId);
        } else {
             document.getElementById('page-title').textContent = '新增行程項目';
             document.getElementById('save-btn').textContent = '儲存行程';
        }
        
        // 2. 設置事件監聽器
        document.getElementById('itinerary-form').addEventListener('submit', handleFormSubmit);
        
        // 3. 取消按鈕導航回清單頁
        document.getElementById('cancel-btn').addEventListener('click', () => {
            window.location.href = 'index.html'; // 導航回 index.html
        });
    };

    // 啟動應用程式
    initializeFirebase();

</script>
</body>
</html>