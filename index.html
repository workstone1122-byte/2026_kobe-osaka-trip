<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- å€å¡ŠåŠŸèƒ½: æ–‡ä»¶å…ƒæ•¸æ“šèˆ‡æ¨£å¼å¼•å…¥ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹è¦åŠƒå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç²å¾—æ›´å¥½çš„ç¾ä»£æ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* éš±è—åŸç”Ÿå½ˆå‡ºå¼å°è©±æ¡†ï¼Œæˆ‘å€‘ä½¿ç”¨è‡ªå®šç¾© Modal */
        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- å€å¡ŠåŠŸèƒ½: ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ) -->
    <div id="app" class="p-4 sm:p-8">
        <!-- åˆå§‹è¼‰å…¥ç‹€æ…‹ -->
        <div class="flex items-center justify-center min-h-screen">
            <p class="text-lg font-semibold text-indigo-600">è¼‰å…¥ä¸­... æ­£åœ¨é€£æ¥ Firebase...</p>
        </div>
    </div>

    <!-- å€å¡ŠåŠŸèƒ½: Modal - æ–°å¢/ç·¨è¼¯æ—…éŠè¨ˆç•«è¡¨å–® -->
    <div id="addPlanModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800" id="planModalTitle">æ–°å¢æ—…éŠè¨ˆç•«</h2>
                <button onclick="closeAddPlanModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addPlanForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±*</label>
                    <input type="text" id="planName" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ç›®çš„åœ° (å¯é¸)</label>
                    <input type="text" id="planDestination" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é–‹å§‹æ—¥æœŸ*</label>
                        <input type="date" id="planStartDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ*</label>
                        <input type="date" id="planEndDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddPlanModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        å»ºç«‹è¨ˆç•«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å€å¡ŠåŠŸèƒ½: Modal - æ–°å¢è¡Œç¨‹å¡ç‰‡è¡¨å–® -->
    <div id="addItineraryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800">æ–°å¢è¡Œç¨‹å¡ç‰‡</h2>
                <button onclick="closeAddItineraryModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addItineraryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ´»å‹•åç¨±*</label>
                    <input type="text" id="itineraryActivity" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é¸æ“‡æ—¥æœŸ*</label>
                        <select id="itineraryDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required>
                            <!-- é¸é …å°‡ç”± JS å‹•æ…‹å¡«å…… -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ™‚é–“ (å¯é¸)</label>
                        <input type="time" id="itineraryTime" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">åœ°é» (å¯é¸)</label>
                    <input type="text" id="itineraryLocation" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">å‚™è¨»/ç­†è¨˜ (å¯é¸)</label>
                    <textarea id="itineraryNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddItineraryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition shadow-md">
                        å„²å­˜è¡Œç¨‹
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- å€å¡ŠåŠŸèƒ½: æ ¸å¿ƒ JavaScript é‚è¼¯ (æ¨¡å¡ŠåŒ–åˆ†å€) -->
    <script type="module">
        // --- å¼•å…¥ Firebase æ¨¡çµ„ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. é…ç½®èˆ‡è®Šæ•¸ (Configuration & Global State) ---
        
        /* * ğŸ”¥ **è³‡å®‰é‡è¦æç¤ºï¼šFirebase é…ç½®**
         * * 1. **åœ¨ç•¶å‰ç’°å¢ƒä¸­ï¼š** Firebase é…ç½® (__firebase_config) å’Œæ‡‰ç”¨ç¨‹å¼ ID (__app_id)
         * æ˜¯é€šéå®‰å…¨çš„ç³»çµ±å…¨åŸŸè®Šæ•¸è‡ªå‹•ä¸”éš±ç§åœ°å‚³å…¥çš„ã€‚æ‚¨ä¸éœ€è¦æ‰‹å‹•ç²˜è²¼ API Keyã€‚
         * * 2. **éƒ¨ç½²åˆ° GitHub Pages/Vercel/Netlify æ™‚ï¼š** * - ç‚ºäº†è³‡å®‰è€ƒé‡ï¼Œ**çµ•å°ä¸è¦**å°‡æ‚¨çš„ firebaseConfig ç‰©ä»¶ç›´æ¥ç¡¬ç·¨ç¢¼åœ¨é€™è£¡ä¸¦æäº¤åˆ° GitHubã€‚
         * - æ‚¨æ‡‰è©²ä½¿ç”¨è©²å¹³è‡ºçš„**ç’°å¢ƒè®Šæ•¸**åŠŸèƒ½ä¾†å‚³å…¥æ‚¨çš„é…ç½®ã€‚
         * - å¦‚æœæ‚¨é‡åˆ°éƒ¨ç½²å•é¡Œï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒ¨ç½²ç’°å¢ƒæ˜¯å¦æ­£ç¢ºè¨­å®šäº†é¡ä¼¼ `FIREBASE_CONFIG` çš„è®Šæ•¸ã€‚
        */
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // ç¡¬ç·¨ç¢¼çš„æ¸¬è©¦ç”¨æˆ¶æ†‘è­‰ (ç”¨æ–¼ç¢ºä¿ç’°å¢ƒåˆå§‹åŒ–)
        const HARDCODED_EMAIL = 'test@team.com';
        const HARDCODED_PASSWORD = '123456';


        // å…¨åŸŸç‹€æ…‹è®Šæ•¸
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthenticated = false;
        let plans = []; // å„²å­˜æ‰€æœ‰æ—…éŠè¨ˆç•«
        let activePlanId = null; // ç•¶å‰æŸ¥çœ‹çš„è¨ˆç•« ID
        let datesArray = []; // å„²å­˜ç•¶å‰æ´»èºè¨ˆç•«çš„æ—¥æœŸåˆ—è¡¨


        // --- 1. è¼”åŠ©å‡½æ•¸ (Helper Functions) ---

        /**
         * å°‡æ—¥æœŸå­—ä¸²æ ¼å¼åŒ–ç‚º "YYYY/MM/DD (é€±X)"
         * @param {string} dateString - æ ¼å¼ç‚º YYYY-MM-DD çš„æ—¥æœŸå­—ä¸²
         */
        function formatDate(dateString) {
            if (!dateString) return 'æ—¥æœŸæœªå®š';
            try {
                const date = new Date(dateString);
                // è™•ç†æ™‚å€å•é¡Œ
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); 

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[date.getDay()];
                return `${year}/${month}/${day} (é€±${weekday})`;
            } catch (error) {
                console.error("æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:", error);
                return dateString;
            }
        }

        /**
         * è¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸ï¼ˆå«èµ·è¨–æ—¥ï¼‰ä¸¦ç”Ÿæˆæ—¥æœŸé™£åˆ—
         * @param {string} start - é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)
         * @param {string} end - çµæŸæ—¥æœŸ (YYYY-MM-DD)
         * @returns {Array<{date: string, day: number}>} - åŒ…å«æ—¥æœŸå’Œå¤©æ•¸ç·¨è™Ÿçš„é™£åˆ—
         */
        function getDatesArray(start, end) {
            const dates = [];
            let currentDate = new Date(start + 'T00:00:00');
            const endDate = new Date(end + 'T00:00:00');
            let dayCount = 1;

            while (currentDate <= endDate) {
                dates.push({
                    date: currentDate.toISOString().split('T')[0],
                    day: dayCount
                });
                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;
            }
            return dates;
        }

        /**
         * ç²å– Firestore æ–‡ä»¶åƒè€ƒè·¯å¾‘ (ç§æœ‰ç”¨æˆ¶è³‡æ–™)
         * @param {string} planId - æ—…éŠè¨ˆç•« ID
         */
        function getPlanDocRef(planId) {
            if (!db || !currentUserId) throw new Error("Firebase æœªåˆå§‹åŒ–æˆ–ç”¨æˆ¶ ID æœªçŸ¥");
            // ä½¿ç”¨ /artifacts/{appId}/users/{userId}/travel_plans è·¯å¾‘
            return doc(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`, planId);
        }

        /**
         * é¡¯ç¤ºè‡ªå®šç¾©éŒ¯èª¤/é€šçŸ¥è¨Šæ¯ (å–ä»£ alert)
         * @param {string} message - è¨Šæ¯å…§å®¹
         * @param {boolean} isError - æ˜¯å¦ç‚ºéŒ¯èª¤è¨Šæ¯
         */
        function showMessage(message, isError = false) {
            const app = document.getElementById('app');
            const existingMessage = document.getElementById('appMessage');
            if (existingMessage) existingMessage.remove();

            const className = isError 
                ? 'bg-red-100 border-red-400 text-red-700' 
                : 'bg-green-100 border-green-400 text-green-700';

            const messageHtml = `
                <div id="appMessage" class="${className} border-l-4 p-4 rounded-lg shadow-md mb-6 transition-all duration-300">
                    <p class="font-bold">${isError ? 'éŒ¯èª¤' : 'é€šçŸ¥'}</p>
                    <p>${message}</p>
                </div>
            `;
            app.insertAdjacentHTML('afterbegin', messageHtml);
            setTimeout(() => {
                document.getElementById('appMessage')?.classList.add('opacity-0');
                setTimeout(() => document.getElementById('appMessage')?.remove(), 300);
            }, 5000);
        }
        
        /** æ›¿æ› window.confirm çš„è‡ªå®šç¾© Modal é‚è¼¯ (é€™è£¡åƒ…ç‚ºæ¨¡æ“¬) */
        function confirmAction(message) {
            console.warn(`[Confirm Action Required]: ${message} - å‡è¨­ç”¨æˆ¶é»æ“Šäº† "ç¢ºå®š"ã€‚`);
            return true; 
        }

        // --- 2. Firebase CRUD æ“ä½œ (CRUD Operations) ---

        /** æ–°å¢æ—…éŠè¨ˆç•« */
        async function handleAddPlan(planData) {
            if (!db || !currentUserId) return;

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`), {
                    ...planData,
                    userId: currentUserId,
                    itineraries: [], // åˆå§‹è¡Œç¨‹ç‚ºç©ºé™£åˆ—
                    createdAt: serverTimestamp()
                });
                closeAddPlanModal();
                showMessage('æ—…éŠè¨ˆç•«å»ºç«‹æˆåŠŸï¼');
            } catch (e) {
                console.error("æ–°å¢è¨ˆç•«å¤±æ•—:", e);
                showMessage(`æ–°å¢è¨ˆç•«å¤±æ•—: ${e.message}`, true);
            }
        }

        /** åˆªé™¤æ—…éŠè¨ˆç•« */
        async function handleDeletePlan(planId) {
            if (!db || !currentUserId) return;

            if (!confirmAction('ç¢ºå®šè¦åˆªé™¤æ­¤æ—…éŠè¨ˆç•«å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚')) return;
            
            try {
                await deleteDoc(getPlanDocRef(planId));
                activePlanId = null; // å¦‚æœåˆªé™¤ç•¶å‰è¨ˆç•«ï¼Œå‰‡è¿”å›åˆ—è¡¨
                showMessage('æ—…éŠè¨ˆç•«å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("åˆªé™¤è¨ˆç•«å¤±æ•—:", e);
                showMessage(`åˆªé™¤è¨ˆç•«å¤±æ•—: ${e.message}`, true);
            }
        }

        /** æ–°å¢è¡Œç¨‹å¡ç‰‡ */
        async function handleAddItinerary(itineraryData) {
            if (!activePlanId) return;

            try {
                const planDocRef = getPlanDocRef(activePlanId);
                const planDoc = await getDoc(planDocRef);
                if (!planDoc.exists()) {
                    throw new Error("æ‰¾ä¸åˆ°æ—…éŠè¨ˆç•«ã€‚");
                }

                let currentItineraries = planDoc.data().itineraries || [];
                
                if (!itineraryData.date || typeof itineraryData.date !== 'string') {
                    throw new Error("è¡Œç¨‹æ—¥æœŸç„¡æ•ˆã€‚");
                }
                
                const newItinerary = {
                    id: crypto.randomUUID(), // ä½¿ç”¨ UUID ç¢ºä¿å”¯ä¸€æ€§
                    ...itineraryData,
                    order: currentItineraries.length + 1, // ç°¡å–®æ’åº
                    notes: itineraryData.notes || 'ç„¡å‚™è¨»'
                };

                currentItineraries.push(newItinerary);

                await updateDoc(planDocRef, {
                    itineraries: currentItineraries
                });

                closeAddItineraryModal();
                showMessage('è¡Œç¨‹å¡ç‰‡æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("æ–°å¢è¡Œç¨‹å¤±æ•—:", e);
                showMessage(`æ–°å¢è¡Œç¨‹å¤±æ•—: ${e.message}`, true);
            }
        }

        /** åˆªé™¤è¡Œç¨‹å¡ç‰‡ */
        async function handleDeleteItinerary(itineraryId) {
            if (!activePlanId) return;

            if (!confirmAction('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å¡ç‰‡å—ï¼Ÿ')) return;

            try {
                const planDocRef = getPlanDocRef(activePlanId);
                const planDoc = await getDoc(planDocRef);
                if (!planDoc.exists()) return;

                const currentItineraries = planDoc.data().itineraries || [];
                const updatedItineraries = currentItineraries
                    .filter(item => item.id !== itineraryId)
                    .map((item, index) => ({ ...item, order: index + 1 })); // é‡æ–°æ’åº

                await updateDoc(planDocRef, {
                    itineraries: updatedItineraries
                });
                showMessage('è¡Œç¨‹å¡ç‰‡å·²åˆªé™¤ã€‚');

            } catch (e) {
                console.error("åˆªé™¤è¡Œç¨‹å¤±æ•—:", e);
                showMessage(`åˆªé™¤è¡Œç¨‹å¤±æ•—: ${e.message}`, true);
            }
        }

        // --- 3. UI æ¸²æŸ“å‡½æ•¸ (Rendering Functions) ---

        /** æ¸²æŸ“å–®å€‹è¡Œç¨‹å¡ç‰‡ HTML */
        function renderItineraryCard(item) {
            return `
                <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500 relative ml-4 transition duration-300 hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center text-sm font-medium text-emerald-600 mb-1">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                ${item.time || 'å…¨å¤©'}
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 mb-2">${item.activity}</h4>
                            ${item.location ? `
                            <p class="text-sm text-gray-600 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                åœ°é»: ${item.location}
                            </p>` : ''}
                            ${item.notes && item.notes !== 'ç„¡å‚™è¨»' ? `
                            <p class="text-sm text-gray-500 mt-2 italic border-t border-gray-100 pt-2">
                                å‚™è¨»: ${item.notes}
                            </p>` : ''}
                        </div>
                        <button onclick="handleDeleteItinerary('${item.id}')"
                            class="p-1 text-red-400 hover:text-red-600 transition duration-150 rounded-full"
                            title="åˆªé™¤è¡Œç¨‹">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        /** æ¸²æŸ“å–®æ—¥è¡Œç¨‹åˆ†çµ„ HTML */
        function renderDayItinerary(date, day, items) {
            // å°è¡Œç¨‹æŒ‰æ™‚é–“æ’åº
            const sortedItems = items.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

            const itemsHtml = sortedItems.length === 0 
                ? `<div class="text-gray-500 italic ml-4">é€™ä¸€å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ã€‚</div>`
                : sortedItems.map(renderItineraryCard).join('');

            return `
                <div class="relative border-l-4 border-indigo-300 ml-4 pl-6">
                    <!-- æ—¥æœŸæ¨™ç±¤ -->
                    <div class="absolute -left-3 top-0 bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">
                        Day ${day}
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 mt-0 pt-0 ml-4">${formatDate(date)}</h3>

                    <div class="space-y-6">
                        ${itemsHtml}
                        <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ• -->
                        <button onclick="openAddItineraryModal('${date}')"
                            class="flex items-center justify-center w-full max-w-sm ml-4 bg-white border-2 border-dashed border-indigo-300 text-indigo-600 hover:bg-indigo-50 transition duration-150 py-3 rounded-xl shadow-sm font-medium">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            æ–°å¢ç•¶æ—¥è¡Œç¨‹å¡ç‰‡
                        </button>
                    </div>
                </div>
            `;
        }

        /** æ¸²æŸ“æ—…éŠè¨ˆç•«è©³æƒ…é é¢ (è¡Œç¨‹æ™‚é–“è»¸) */
        function renderPlanDetail(plan) {
            datesArray = getDatesArray(plan.startDate, plan.endDate);
            
            // æŒ‰æ—¥æœŸåˆ†çµ„è¡Œç¨‹
            const groupedItineraries = datesArray.reduce((acc, { date, day }) => {
                acc[date] = {
                    day: day,
                    items: (plan.itineraries || [])
                        .filter(item => item.date === date)
                };
                return acc;
            }, {});

            let dayItinerariesHtml = datesArray.map(({ date, day }) => {
                const group = groupedItineraries[date];
                return renderDayItinerary(date, day, group.items);
            }).join('');

            return `
                <header class="mb-6 bg-white p-6 rounded-xl shadow-lg border-b-4 border-indigo-600">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <button onclick="activePlanId = null; renderApp();" class="text-indigo-600 hover:text-indigo-800 transition mb-2 flex items-center">
                                &larr; è¿”å›è¨ˆç•«åˆ—è¡¨
                            </button>
                            <h1 class="text-3xl font-extrabold text-gray-900">${plan.name}</h1>
                            <p class="text-md text-gray-500 mt-1">${formatDate(plan.startDate)} ~ ${formatDate(plan.endDate)} (${datesArray.length} å¤©)</p>
                            ${plan.destination ? `
                            <p class="text-sm text-gray-600 mt-2 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                ${plan.destination}
                            </p>` : ''}
                        </div>
                        <button onclick="handleDeletePlan('${plan.id}')"
                            class="p-3 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50 border border-red-200"
                            title="åˆªé™¤æ­¤è¨ˆç•«">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>
                    </div>
                </header>
                <div class="space-y-10">
                    ${dayItinerariesHtml}
                </div>
            `;
        }

        /** æ¸²æŸ“æ—…éŠè¨ˆç•«åˆ—è¡¨é é¢ */
        function renderPlanList() {
            let planCardsHtml = '';

            if (plans.length === 0) {
                planCardsHtml = `
                    <div class="col-span-full text-center py-10 bg-white rounded-xl shadow">
                        <p class="text-xl text-gray-500">å°šç„¡æ—…éŠè¨ˆç•«ã€‚é»æ“Šã€Œæ–°å¢è¨ˆç•«ã€é–‹å§‹è¦åŠƒï¼</p>
                    </div>
                `;
            } else {
                planCardsHtml = plans.map(plan => `
                    <div id="plan-card-${plan.id}" class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-xl transition duration-300 border-t-4 border-indigo-500">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${plan.name}</h3>
                            <div class="text-sm text-gray-500 space-y-1">
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    ${formatDate(plan.startDate)}
                                </p>
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    ${formatDate(plan.endDate)}
                                </p>
                                ${plan.destination ? `
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    ${plan.destination}
                                </p>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button data-plan-id="${plan.id}" onclick="event.stopPropagation(); handleDeletePlan('${plan.id}')"
                                class="p-2 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50"
                                title="åˆªé™¤è¨ˆç•«">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                            </button>
                            <button data-plan-id="${plan.id}" onclick="setActivePlan('${plan.id}')"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-xl transition duration-300">
                                æŸ¥çœ‹è¡Œç¨‹
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            return `
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">æˆ‘çš„æ—…éŠè¨ˆç•«</h1>
                    <button onclick="openAddPlanModal()"
                        class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        æ–°å¢è¨ˆç•«
                    </button>
                </header>
                <div class="bg-gray-200 border-l-4 border-gray-500 text-gray-800 p-3 rounded-lg mb-6">
                    <p class="text-sm">ç•¶å‰ç”¨æˆ¶ ID (UID): <span class="font-mono text-xs bg-gray-300 p-1 rounded break-all">${currentUserId || 'N/A'}</span></p>
                    <p class="text-xs text-red-600 mt-1">æ­¤ ID æ‡‰å§‹çµ‚ç‚ºå›ºå®šç”¨æˆ¶ <code>${HARDCODED_EMAIL}</code> çš„ UIDã€‚</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${planCardsHtml}
                </div>
            `;
        }


        // --- 4. æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼èˆ‡ç‹€æ…‹ç®¡ç† (Core App Logic) ---

        /** é‡æ–°æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼Œæ ¹æ“š activePlanId é¡¯ç¤ºåˆ—è¡¨æˆ–è©³æƒ… */
        window.renderApp = function() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            
            const activePlan = plans.find(p => p.id === activePlanId);

            if (activePlanId && activePlan) {
                appContainer.innerHTML = renderPlanDetail(activePlan);
                // å¿…é ˆé‡æ–°å¡«å……è¡Œç¨‹ Modal çš„æ—¥æœŸé¸é …
                populateItineraryDates(activePlan);
            } else {
                appContainer.innerHTML = renderPlanList();
            }
        }

        /** è¨­å®šæ´»èºè¨ˆç•« ID ä¸¦é‡æ–°æ¸²æŸ“ */
        window.setActivePlan = function(planId) {
            activePlanId = planId;
            renderApp();
        }

        /** è¨‚é–±æ—…éŠè¨ˆç•«åˆ—è¡¨ (Firestore Realtime) */
        function subscribeToPlans() {
            if (!isAuthenticated || !currentUserId || !db) return;

            const plansCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`);
            const q = query(plansCollectionRef);

            onSnapshot(q, (snapshot) => {
                plans = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => {
                    // åœ¨å®¢æˆ¶ç«¯æŒ‰å»ºç«‹æ™‚é–“å€’åºæ’åº
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB - dateA;
                });
                
                // æ¯æ¬¡è³‡æ–™æ›´æ–°æ™‚ï¼Œé‡æ–°æ¸²æŸ“ App
                renderApp();
            }, (err) => {
                console.error("Firestore è¨‚é–±å¤±æ•—:", err);
                showMessage(`è³‡æ–™è®€å–å¤±æ•—: ${err.message}`, true);
            });
        }


        // --- 5. Modal æ§åˆ¶å‡½æ•¸ (Modal Control) ---

        /** æ‰“é–‹æ–°å¢è¨ˆç•« Modal */
        function openAddPlanModal() {
            document.getElementById('addPlanModal').classList.add('open');
            document.getElementById('addPlanForm').reset();
        }

        /** é—œé–‰æ–°å¢è¨ˆç•« Modal */
        function closeAddPlanModal() {
            document.getElementById('addPlanModal').classList.remove('open');
        }

        /** å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸä¸‹æ‹‰é¸å–® */
        function populateItineraryDates(activePlan) {
            const dateSelect = document.getElementById('itineraryDate');
            if (!dateSelect) return;

            datesArray = getDatesArray(activePlan.startDate, activePlan.endDate);
            dateSelect.innerHTML = datesArray.map(d => 
                `<option value="${d.date}">Day ${d.day} - ${formatDate(d.date)}</option>`
            ).join('');
        }
        
        /** æ‰“é–‹æ–°å¢è¡Œç¨‹ Modal ä¸¦é è¨­æ—¥æœŸ */
        window.openAddItineraryModal = function(preselectedDate = null) {
            const modal = document.getElementById('addItineraryModal');
            const dateSelect = document.getElementById('itineraryDate');
            
            // ç¢ºä¿æ—¥æœŸä¸‹æ‹‰èœå–®ä¸­çš„å€¼è¢«æ­£ç¢ºé é¸
            if (preselectedDate) {
                dateSelect.value = preselectedDate;
            } else if (datesArray.length > 0) {
                 dateSelect.value = datesArray[0].date;
            }
            
            modal.classList.add('open');
            document.getElementById('addItineraryForm').reset();
            // ç”±æ–¼é‡ç½®æœƒæ¸…ç©ºï¼Œéœ€è¦é‡æ–°è¨­å®šæ—¥æœŸ
            if (preselectedDate) {
                 dateSelect.value = preselectedDate;
            }
        }

        /** é—œé–‰æ–°å¢è¡Œç¨‹ Modal */
        function closeAddItineraryModal() {
            document.getElementById('addItineraryModal').classList.remove('open');
        }


        // --- 6. äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ– (Event Listeners & Init) ---

        /** è¨»å†Šè¡¨å–®æäº¤äº‹ä»¶ */
        document.getElementById('addPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('planName').value.trim();
            const destination = document.getElementById('planDestination').value.trim();
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;

            if (!name || !startDate || !endDate) {
                showMessage('è«‹å¡«å¯«è¨ˆç•«åç¨±ã€é–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸã€‚', true);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚', true);
                return;
            }

            handleAddPlan({ name, destination, startDate, endDate });
        });
        
        document.getElementById('addItineraryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const activity = document.getElementById('itineraryActivity').value.trim();
            const date = document.getElementById('itineraryDate').value;
            const time = document.getElementById('itineraryTime').value;
            const location = document.getElementById('itineraryLocation').value.trim();
            const notes = document.getElementById('itineraryNotes').value.trim();

            if (!activity || !date) {
                showMessage('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œæ—¥æœŸã€‚', true);
                return;
            }

            handleAddItinerary({ activity, date, time, location, notes });
        });
        
        // æš´éœ²çµ¦å…¨å±€ï¼Œä»¥ä¾¿åœ¨ HTML å±¬æ€§ä¸­èª¿ç”¨ (onClick)
        window.handleDeletePlan = handleDeletePlan;
        window.handleDeleteItinerary = handleDeleteItinerary;
        window.openAddPlanModal = openAddPlanModal;
        window.closeAddPlanModal = closeAddPlanModal;
        
        /** æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•èˆ‡ Firebase åˆå§‹åŒ– */
        async function initializeAppAndFirebase() {
            
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    // é€™åªæ‡‰åœ¨ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®æ™‚ç™¼ç”Ÿ (ä¾‹å¦‚éƒ¨ç½²åˆ°å¤–éƒ¨å¹³è‡ºä½†å¿˜è¨˜è¨­å®šè®Šæ•¸)
                    throw new Error("Firebase é…ç½®æœªæä¾›ã€‚è«‹æª¢æŸ¥æ‚¨æ˜¯å¦åœ¨éƒ¨ç½²ç’°å¢ƒä¸­æ­£ç¢ºè¨­å®šäº† FIREBASE_CONFIG è®Šæ•¸ã€‚");
                }
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // --- èªè­‰æµç¨‹: å˜—è©¦ä»¥å›ºå®šå¸³è™Ÿç™»å…¥/å‰µå»º ---
                // æ³¨æ„: é€™è£¡ä½¿ç”¨ç¡¬ç·¨ç¢¼å¸³è™Ÿæ˜¯ç‚ºäº†ç¢ºä¿å–®ç”¨æˆ¶ç’°å¢ƒèƒ½å¤ ç©©å®šé‹è¡Œ
                try {
                    console.log(`å˜—è©¦ä»¥ç¡¬ç·¨ç¢¼ç”¨æˆ¶ ${HARDCODED_EMAIL} ç™»å…¥...`);
                    await signInWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);

                } catch (loginError) {
                    console.warn(`ç™»å…¥å¤±æ•— (${loginError.code})ã€‚å˜—è©¦å‰µå»ºç”¨æˆ¶...`);
                    await createUserWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);
                    console.log(`ç”¨æˆ¶ ${HARDCODED_EMAIL} å‰µå»ºæˆåŠŸä¸¦å·²ç™»å…¥ã€‚`);
                }

                // --- ç¢ºèªä¸¦è¨­ç½®ç”¨æˆ¶ç‹€æ…‹ ---
                const user = auth.currentUser;
                if (user) {
                    currentUserId = user.uid;
                    isAuthenticated = true;
                    console.log("å›ºå®šç”¨æˆ¶å·²è¨­ç½®ã€‚UID:", currentUserId);
                    
                    // è¨‚é–±è³‡æ–™
                    subscribeToPlans();
                } else {
                    throw new Error("èªè­‰æµç¨‹å®Œæˆï¼Œä½†ç”¨æˆ¶ç‹€æ…‹ç„¡æ•ˆã€‚");
                }

                // --- æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ ---
                renderApp(); 

            } catch (e) {
                console.error("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:", e);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦åœæ­¢åŸ·è¡Œ
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = `
                    <div class="text-center bg-red-100 border-red-500 border-l-4 p-6 rounded-xl shadow-lg mt-8">
                        <h2 class="text-xl font-bold text-red-700 mb-2">èªè­‰/åˆå§‹åŒ–å¤±æ•—</h2>
                        <p class="text-gray-700">${e.message}</p>
                        <p class="text-sm mt-4">è«‹æª¢æŸ¥ Firebase Console ä¸­æ˜¯å¦å•Ÿç”¨äº†é›»å­éƒµä»¶/å¯†ç¢¼ç™»å…¥ï¼Œæˆ–è€…æ˜¯å¦æ­£ç¢ºè¨­å®šäº†éƒ¨ç½²ç’°å¢ƒè®Šæ•¸ã€‚</p>
                    </div>
                `;
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeAppAndFirebase();
    </script>
</body>
</html>