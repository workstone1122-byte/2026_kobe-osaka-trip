<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- å€å¡ŠåŠŸèƒ½: æ–‡ä»¶å…ƒæ•¸æ“šèˆ‡æ¨£å¼å¼•å…¥ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹è¦åŠƒå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç²å¾—æ›´å¥½çš„ç¾ä»£æ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* éš±è—åŸç”Ÿå½ˆå‡ºå¼å°è©±æ¡†ï¼Œæˆ‘å€‘ä½¿ç”¨è‡ªå®šç¾© Modal */
        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        /* ç§»å‹•ç«¯å…§å®¹å„ªå…ˆä½ˆå±€ï¼Œæœ€å¤§å¯¬åº¦è¨­ç‚ºæ‰‹æ©Ÿå¸¸è¦‹å¯¬åº¦ */
        #app-container {
            max-width: 640px; /* ç›¸ç•¶æ–¼ sm:max-w-xl æˆ– max-w-md */
            margin: 0 auto;
            min-height: 100vh;
        }
        /* ç¢ºä¿è¡Œç¨‹æ™‚é–“è»¸çš„ç·šæ¢åœ¨ç§»å‹•ç«¯æ¸…æ™°å¯è¦‹ */
        .timeline-container {
            border-left: 4px solid #a5b4fc; /* indigo-300 */
            margin-left: 1rem;
            padding-left: 1.5rem;
        }
        .timeline-day-marker {
            position: absolute;
            left: -14px; /* èª¿æ•´ä»¥å°é½Šç·šæ¢ */
            top: 0;
            background-color: #4f46e5; /* indigo-600 */
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            line-height: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- å€å¡ŠåŠŸèƒ½: ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ) -->
    <div id="app-container" class="p-4 sm:p-8">
        <div id="app">
            <!-- åˆå§‹è¼‰å…¥ç‹€æ…‹ -->
            <div class="flex items-center justify-center min-h-screen">
                <p class="text-lg font-semibold text-indigo-600">è¼‰å…¥ä¸­... æ­£åœ¨é€£æ¥ Firebase...</p>
            </div>
        </div>
    </div>
    
    <!-- Modal: æ–°å¢/ç·¨è¼¯æ—…éŠè¨ˆç•«è¡¨å–® (Plan CRUD) -->
    <div id="addPlanModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800" id="planModalTitle">æ–°å¢æ—…éŠè¨ˆç•«</h2>
                <button onclick="closeAddPlanModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addPlanForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±*</label>
                    <input type="text" id="planName" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ç›®çš„åœ° (å¯é¸)</label>
                    <input type="text" id="planDestination" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é–‹å§‹æ—¥æœŸ*</label>
                        <input type="date" id="planStartDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ*</label>
                        <input type="date" id="planEndDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddPlanModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        å„²å­˜è¨ˆç•«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: æ–°å¢/ç·¨è¼¯æ¯æ—¥è¡Œç¨‹å¡ç‰‡è¡¨å–® (Itinerary CRUD) -->
    <div id="addItineraryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800" id="itineraryModalTitle">æ–°å¢è¡Œç¨‹å¡ç‰‡</h2>
                <button onclick="closeAddItineraryModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addItineraryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ´»å‹•åç¨±*</label>
                    <input type="text" id="itineraryActivity" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é¸æ“‡æ—¥æœŸ*</label>
                        <select id="itineraryDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required>
                            <!-- é¸é …å°‡ç”± JS å‹•æ…‹å¡«å…… -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ™‚é–“ (å¯é¸)</label>
                        <input type="time" id="itineraryTime" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">åœ°é» (å¯é¸)</label>
                    <input type="text" id="itineraryLocation" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">å‚™è¨»/ç­†è¨˜ (å¯é¸)</label>
                    <textarea id="itineraryNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddItineraryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition shadow-md">
                        å„²å­˜è¡Œç¨‹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: è‡ªå®šç¾©æç¤º/ç¢ºèªè¦–çª— (å–ä»£ alert/confirm) -->
    <div id="customAlertModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
            <h3 id="alertTitle" class="text-xl font-bold mb-3 text-gray-800">è¨Šæ¯</h3>
            <p id="alertMessage" class="text-gray-700 mb-6"></p>
            <div id="alertActions" class="flex justify-center space-x-3">
                <button type="button" id="alertConfirmBtn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md w-full">ç¢ºå®š</button>
            </div>
        </div>
    </div>


    <!-- å€å¡ŠåŠŸèƒ½: æ ¸å¿ƒ JavaScript é‚è¼¯ (æ¨¡å¡ŠåŒ–åˆ†å€) -->
    <script type="module">
        // --- å¼•å…¥ Firebase æ¨¡çµ„ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // å•Ÿç”¨ Firestore åµéŒ¯æ—¥èªŒ
        setLogLevel('Debug');

        // --- 0. é…ç½®èˆ‡è®Šæ•¸ (Configuration & Global State) ---
        
        /* * ğŸ”¥ **è³‡å®‰é‡è¦æç¤ºï¼šFirebase é…ç½®**
         * åœ¨éƒ¨ç½²åˆ° GitHub/Netlify/Vercel ç­‰å…¬é–‹å¹³å°æ™‚ï¼Œ**è«‹å‹™å¿…**å°‡ä¸‹æ–¹ `firebaseConfig` æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„å¯¦éš›å€¼ã€‚
         * **è«‹å‹¿**å°‡æ­¤æª”æ¡ˆä¸Šå‚³åˆ° GitHub è€Œæœªæ›¿æ› YOUR_... é ç•™ä½ç½®ï¼Œæˆ–ä½¿ç”¨ Netlify ç’°å¢ƒè®Šæ•¸ä»£æ›¿ã€‚
        */
        
		const firebaseConfig = {
		  apiKey: "AIzaSyBsMiLUgtJtcv48iRp_9QFx5fShtRd6Lro",
		  authDomain: "kobe-osaka-2026travel.firebaseapp.com",
		  projectId: "kobe-osaka-2026travel",
		  storageBucket: "kobe-osaka-2026travel.firebasestorage.app",
		  messagingSenderId: "772246724994",
		  appId: "1:772246724994:web:26c067ae1096d13ebdef9b"
		};
        
        // ä½¿ç”¨ projectId ä½œç‚ºæ‡‰ç”¨ç¨‹å¼ ID çš„æ›¿ä»£å“
        const appId = firebaseConfig.projectId || 'default-travel-planner';
        
        // ç¡¬ç·¨ç¢¼çš„æ¸¬è©¦ç”¨æˆ¶æ†‘è­‰ (ç¢ºä¿ Canvas ç’°å¢ƒèƒ½ç«‹å³é‹è¡Œä¸¦å„²å­˜è³‡æ–™)
        const HARDCODED_EMAIL = 'test@travelplanner.com';
        const HARDCODED_PASSWORD = '123456';

        // å…¨åŸŸç‹€æ…‹è®Šæ•¸
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthenticated = false;
        let plans = []; // å„²å­˜æ‰€æœ‰æ—…éŠè¨ˆç•«
        let activePlanId = null; // ç•¶å‰æŸ¥çœ‹çš„è¨ˆç•« ID
        let datesArray = []; // å„²å­˜ç•¶å‰æ´»èºè¨ˆç•«çš„æ—¥æœŸåˆ—è¡¨
        let editingPlanId = null; // æ­£åœ¨ç·¨è¼¯çš„è¨ˆç•« ID


        // --- 1. è¼”åŠ©å‡½æ•¸ (Helper Functions) ---

        /**
         * å°‡æ—¥æœŸå­—ä¸²æ ¼å¼åŒ–ç‚º "YYYY/MM/DD (é€±X)"
         * @param {string} dateString - æ ¼å¼ç‚º YYYY-MM-DD çš„æ—¥æœŸå­—ä¸²
         */
        function formatDate(dateString) {
            if (!dateString) return 'æ—¥æœŸæœªå®š';
            try {
                const date = new Date(dateString + 'T00:00:00'); // é¿å…æ™‚å€å•é¡Œ
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[date.getDay()];
                return `${year}/${month}/${day} (é€±${weekday})`;
            } catch (error) {
                console.error("æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:", error);
                return dateString;
            }
        }

        /**
         * è¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸ï¼ˆå«èµ·è¨–æ—¥ï¼‰ä¸¦ç”Ÿæˆæ—¥æœŸé™£åˆ—
         */
        function getDatesArray(start, end) {
            const dates = [];
            // ä½¿ç”¨ 'T00:00:00' ç¢ºä¿æ—¥æœŸè™•ç†ä¸æœƒå› æ™‚å€è€Œåç§»
            let currentDate = new Date(start + 'T00:00:00'); 
            const endDate = new Date(end + 'T00:00:00');
            let dayCount = 1;

            while (currentDate <= endDate) {
                dates.push({
                    date: currentDate.toISOString().split('T')[0],
                    day: dayCount
                });
                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;
            }
            return dates;
        }

        /**
         * ç²å– Firestore æ–‡ä»¶åƒè€ƒè·¯å¾‘ (ç§æœ‰ç”¨æˆ¶è³‡æ–™)
         */
        function getPlanDocRef(planId) {
            if (!db || !currentUserId) throw new Error("Firebase æœªåˆå§‹åŒ–æˆ–ç”¨æˆ¶ ID æœªçŸ¥");
            // ä½¿ç”¨ /artifacts/{appId}/users/{userId}/travel_plans è·¯å¾‘
            return doc(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`, planId);
        }

        /** é¡¯ç¤ºè‡ªå®šç¾©è­¦å ±/è¨Šæ¯ */
        window.showMessage = function(message, isError = false) {
            const modal = document.getElementById('customAlertModal');
            const titleElement = document.getElementById('alertTitle');
            const messageElement = document.getElementById('alertMessage');
            const confirmBtn = document.getElementById('alertConfirmBtn');

            titleElement.textContent = isError ? 'éŒ¯èª¤ï¼' : 'é€šçŸ¥';
            messageElement.textContent = message;
            
            if (isError) {
                 titleElement.classList.add('text-red-600');
                 confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                 confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                 titleElement.classList.remove('text-red-600');
                 confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                 confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }

            confirmBtn.onclick = () => modal.classList.remove('open');
            modal.classList.add('open');
        }
        
        /** é¡¯ç¤ºè‡ªå®šç¾©ç¢ºèªå°è©±æ¡† (å–ä»£ window.confirm) */
        function confirmAction(message, onConfirm) {
            const modal = document.getElementById('customAlertModal');
            const titleElement = document.getElementById('alertTitle');
            const messageElement = document.getElementById('alertMessage');
            const actionsDiv = document.getElementById('alertActions');
            
            // ç¢ºä¿åªæœ‰ç¢ºèªæŒ‰éˆ•å­˜åœ¨
            actionsDiv.innerHTML = `
                <button type="button" id="alertCancelBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition w-full">å–æ¶ˆ</button>
                <button type="button" id="alertConfirmBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition shadow-md w-full">ç¢ºèªåˆªé™¤</button>
            `;
            
            titleElement.textContent = 'è«‹ç¢ºèª';
            titleElement.classList.add('text-red-600');
            messageElement.textContent = message;

            document.getElementById('alertCancelBtn').onclick = () => modal.classList.remove('open');
            document.getElementById('alertConfirmBtn').onclick = () => {
                onConfirm();
                modal.classList.remove('open');
            };

            modal.classList.add('open');
        }


        // --- 2. Firebase CRUD æ“ä½œ (CRUD Operations) ---

        /** æ–°å¢æˆ–æ›´æ–°æ—…éŠè¨ˆç•« */
        async function handleSavePlan(planData) {
            if (!db || !currentUserId) return;

            try {
                if (editingPlanId) {
                    // æ›´æ–°ç¾æœ‰è¨ˆç•«
                    const planRef = getPlanDocRef(editingPlanId);
                    await updateDoc(planRef, {
                        ...planData,
                        updatedAt: serverTimestamp()
                    });
                    showMessage('æ—…éŠè¨ˆç•«æ›´æ–°æˆåŠŸï¼');
                } else {
                    // æ–°å¢è¨ˆç•«
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`), {
                        ...planData,
                        userId: currentUserId,
                        itineraries: [], // åˆå§‹è¡Œç¨‹ç‚ºç©ºé™£åˆ—
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    showMessage('æ—…éŠè¨ˆç•«å»ºç«‹æˆåŠŸï¼');
                }
                closeAddPlanModal();
            } catch (e) {
                console.error("å„²å­˜è¨ˆç•«å¤±æ•—:", e);
                showMessage(`å„²å­˜è¨ˆç•«å¤±æ•—: ${e.message}`, true);
            }
        }
        
        /** åˆªé™¤æ—…éŠè¨ˆç•« */
        window.handleDeletePlan = function(planId) {
            if (!db || !currentUserId) return;

            confirmAction('ç¢ºå®šè¦åˆªé™¤æ­¤æ—…éŠè¨ˆç•«å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚', async () => {
                try {
                    await deleteDoc(getPlanDocRef(planId));
                    activePlanId = null; // å¦‚æœåˆªé™¤ç•¶å‰è¨ˆç•«ï¼Œå‰‡è¿”å›åˆ—è¡¨
                    showMessage('æ—…éŠè¨ˆç•«å·²åˆªé™¤ã€‚');
                } catch (e) {
                    console.error("åˆªé™¤è¨ˆç•«å¤±æ•—:", e);
                    showMessage(`åˆªé™¤è¨ˆç•«å¤±æ•—: ${e.message}`, true);
                }
            });
        }

        /** æ–°å¢è¡Œç¨‹å¡ç‰‡ */
        async function handleAddItinerary(itineraryData) {
            if (!activePlanId) return;

            try {
                const planDocRef = getPlanDocRef(activePlanId);
                const planDoc = await getDoc(planDocRef);
                if (!planDoc.exists()) {
                    throw new Error("æ‰¾ä¸åˆ°æ—…éŠè¨ˆç•«ã€‚");
                }

                let currentItineraries = planDoc.data().itineraries || [];
                
                if (!itineraryData.date || typeof itineraryData.date !== 'string') {
                    throw new Error("è¡Œç¨‹æ—¥æœŸç„¡æ•ˆã€‚");
                }
                
                const newItinerary = {
                    id: crypto.randomUUID(), // ä½¿ç”¨ UUID ç¢ºä¿å”¯ä¸€æ€§
                    ...itineraryData,
                    notes: itineraryData.notes || ''
                };

                currentItineraries.push(newItinerary);

                await updateDoc(planDocRef, {
                    itineraries: currentItineraries,
                    updatedAt: serverTimestamp()
                });

                closeAddItineraryModal();
                showMessage('è¡Œç¨‹å¡ç‰‡æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("æ–°å¢è¡Œç¨‹å¤±æ•—:", e);
                showMessage(`æ–°å¢è¡Œç¨‹å¤±æ•—: ${e.message}`, true);
            }
        }

        /** åˆªé™¤è¡Œç¨‹å¡ç‰‡ */
        window.handleDeleteItinerary = function(itineraryId) {
            if (!activePlanId) return;

            confirmAction('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å¡ç‰‡å—ï¼Ÿ', async () => {
                try {
                    const planDocRef = getPlanDocRef(activePlanId);
                    const planDoc = await getDoc(planDocRef);
                    if (!planDoc.exists()) return;

                    const currentItineraries = planDoc.data().itineraries || [];
                    const updatedItineraries = currentItineraries
                        .filter(item => item.id !== itineraryId);

                    await updateDoc(planDocRef, {
                        itineraries: updatedItineraries,
                        updatedAt: serverTimestamp()
                    });
                    showMessage('è¡Œç¨‹å¡ç‰‡å·²åˆªé™¤ã€‚');

                } catch (e) {
                    console.error("åˆªé™¤è¡Œç¨‹å¤±æ•—:", e);
                    showMessage(`åˆªé™¤è¡Œç¨‹å¤±æ•—: ${e.message}`, true);
                }
            });
        }


        // --- 3. UI æ¸²æŸ“å‡½æ•¸ (Rendering Functions) ---

        /** æ¸²æŸ“å–®å€‹è¡Œç¨‹å¡ç‰‡ HTML (å„ªåŒ–æ‰‹æ©Ÿè§¸æ§) */
        function renderItineraryCard(item) {
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-emerald-500 relative transition duration-300 hover:shadow-xl space-y-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${item.activity}</h4>
                            <div class="flex items-center text-sm font-medium text-emerald-600 mt-1">
                                <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="12 6 12 12 16 14"/><circle cx="12" cy="12" r="10"/></svg>
                                ${item.time || 'å…¨å¤©æ´»å‹•'}
                            </div>
                        </div>
                        <!-- åˆªé™¤æŒ‰éˆ• (å¤§è§¸æ§ç›®æ¨™) -->
                        <button onclick="handleDeleteItinerary('${item.id}')"
                            class="p-3 text-red-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-50"
                            title="åˆªé™¤è¡Œç¨‹">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>
                    </div>
                    ${item.location ? `
                    <p class="text-sm text-gray-600 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        ${item.location}
                    </p>` : ''}
                    ${item.notes ? `
                    <p class="text-xs text-gray-500 italic mt-2 border-t border-gray-100 pt-2">
                        å‚™è¨»: ${item.notes}
                    </p>` : ''}
                </div>
            `;
        }

        /** æ¸²æŸ“å–®æ—¥è¡Œç¨‹åˆ†çµ„ HTML (æ™‚é–“è»¸æ¨£å¼) */
        function renderDayItinerary(date, day, items) {
            // å°è¡Œç¨‹æŒ‰æ™‚é–“æ’åº (æ²’æœ‰æ™‚é–“çš„æ’åœ¨æœ€å¾Œ)
            const sortedItems = items.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

            const itemsHtml = sortedItems.length === 0 
                ? `<div class="text-gray-500 italic ml-0 py-4">é€™ä¸€å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ã€‚</div>`
                : sortedItems.map(renderItineraryCard).join('');

            return `
                <div class="relative pb-8 pt-2">
                    <!-- æ—¥æœŸæ¨™ç±¤/æ¨™è¨˜é» -->
                    <div class="timeline-day-marker text-white font-bold">
                        ${day}
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 ml-5">${formatDate(date)}</h3>

                    <div class="space-y-4 pt-4">
                        ${itemsHtml}
                        <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ• (å…¨å¯¬è§¸æ§ç›®æ¨™) -->
                        <button onclick="openAddItineraryModal('${date}')"
                            class="flex items-center justify-center w-full bg-white border-2 border-dashed border-emerald-300 text-emerald-600 hover:bg-emerald-50 transition duration-150 py-3 rounded-xl shadow-sm font-medium mt-4">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            æ–°å¢ ${day} æ—¥è¡Œç¨‹å¡ç‰‡
                        </button>
                    </div>
                </div>
            `;
        }

        /** æ¸²æŸ“æ—…éŠè¨ˆç•«è©³æƒ…é é¢ (è¡Œç¨‹æ™‚é–“è»¸) */
        function renderPlanDetail(plan) {
            datesArray = getDatesArray(plan.startDate, plan.endDate);
            
            // æŒ‰æ—¥æœŸåˆ†çµ„è¡Œç¨‹
            const groupedItineraries = datesArray.reduce((acc, { date, day }) => {
                acc[date] = {
                    day: day,
                    items: (plan.itineraries || [])
                        .filter(item => item.date === date)
                };
                return acc;
            }, {});

            let dayItinerariesHtml = datesArray.map(({ date, day }) => {
                const group = groupedItineraries[date];
                return renderDayItinerary(date, day, group.items);
            }).join('');

            return `
                <header class="mb-6 bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-600">
                    <div class="flex justify-between items-start mb-4">
                        <button onclick="activePlanId = null; renderApp();" class="text-indigo-600 hover:text-indigo-800 transition mb-2 flex items-center p-2 -ml-2 rounded-full hover:bg-indigo-50">
                            <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            è¿”å›
                        </button>
                        <button onclick="openEditPlanModal('${plan.id}')"
                            class="p-2 text-gray-500 hover:text-gray-700 transition duration-150 rounded-full hover:bg-gray-100"
                            title="ç·¨è¼¯è¨ˆç•«">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                        </button>
                    </div>
                    <h1 class="text-2xl font-extrabold text-gray-900">${plan.name}</h1>
                    <p class="text-md text-gray-500 mt-1">${formatDate(plan.startDate)} ~ ${formatDate(plan.endDate)} (${datesArray.length} å¤©)</p>
                    ${plan.destination ? `
                    <p class="text-sm text-gray-600 mt-2 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        ${plan.destination}
                    </p>` : ''}
                </header>
                <!-- è¡Œç¨‹æ™‚é–“è»¸å®¹å™¨ -->
                <div class="timeline-container mt-8">
                    ${dayItinerariesHtml}
                </div>
                <div class="mt-8 pt-4 border-t border-gray-200 flex justify-center">
                    <button onclick="handleDeletePlan('${plan.id}')"
                        class="flex items-center px-4 py-2 text-sm font-medium text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition shadow-md">
                        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        åˆªé™¤æ­¤è¨ˆç•«
                    </button>
                </div>
            `;
        }

        /** æ¸²æŸ“æ—…éŠè¨ˆç•«åˆ—è¡¨é é¢ (ç§»å‹•ç«¯å¡ç‰‡å„ªåŒ–) */
        function renderPlanList() {
            let planCardsHtml = '';

            if (plans.length === 0) {
                planCardsHtml = `
                    <div class="col-span-full text-center py-12 bg-white rounded-xl shadow-lg border-2 border-dashed border-indigo-200">
                        <p class="text-xl text-gray-500">å°šç„¡æ—…éŠè¨ˆç•«ã€‚</p>
                        <p class="text-md text-gray-400 mt-2">é»æ“Šå³ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è¦åŠƒï¼</p>
                    </div>
                `;
            } else {
                planCardsHtml = plans.map(plan => `
                    <div data-plan-id="${plan.id}" onclick="setActivePlan('${plan.id}')"
                        class="bg-white rounded-xl shadow-lg p-5 flex flex-col hover:shadow-xl transition duration-300 border-t-4 border-indigo-500 active:bg-gray-50 cursor-pointer">
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${plan.name}</h3>
                        <p class="text-sm text-gray-600 mb-3">${plan.destination || 'ç›®çš„åœ°æœªå®š'}</p>
                        
                        <div class="text-xs text-gray-500 space-y-1">
                            <p class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                ${formatDate(plan.startDate)} - ${formatDate(plan.endDate)}
                            </p>
                            <p class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2v4a1 1 0 0 0 1 1h4"/><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/></svg>
                                å…± ${getDatesArray(plan.startDate, plan.endDate).length} å¤©è¡Œç¨‹
                            </p>
                        </div>
                        <div class="flex justify-end mt-3 pt-3 border-t border-gray-100">
                            <span class="text-xs text-indigo-500 font-medium hover:text-indigo-700 transition">
                                æŸ¥çœ‹è¡Œç¨‹ &rarr;
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            return `
                <header class="flex justify-between items-center mb-6 pt-4">
                    <h1 class="text-2xl font-extrabold text-gray-900">æˆ‘çš„æ—…éŠè¨ˆç•«</h1>
                    <button onclick="openAddPlanModal()"
                        class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold p-3 rounded-full shadow-md transition duration-300 transform active:scale-95"
                        title="æ–°å¢æ—…éŠè¨ˆç•«">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    </button>
                </header>
                <div class="bg-gray-200 border-l-4 border-gray-500 text-gray-800 p-3 rounded-lg mb-6 text-xs">
                    <p>ç•¶å‰ç”¨æˆ¶ ID: <span class="font-mono bg-gray-300 p-1 rounded break-all">${currentUserId || 'N/A'}</span></p>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${planCardsHtml}
                </div>
            `;
        }


        // --- 4. æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼èˆ‡ç‹€æ…‹ç®¡ç† (Core App Logic) ---

        /** é‡æ–°æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼Œæ ¹æ“š activePlanId é¡¯ç¤ºåˆ—è¡¨æˆ–è©³æƒ… */
        window.renderApp = function() {
            const appContainer = document.getElementById('app');
            if (!appContainer || !db || !currentUserId) return;
            
            const activePlan = plans.find(p => p.id === activePlanId);

            if (activePlanId && activePlan) {
                appContainer.innerHTML = renderPlanDetail(activePlan);
                populateItineraryDates(activePlan); // ç¢ºä¿è¡Œç¨‹ Modal çš„æ—¥æœŸé¸é …æ˜¯æœ€æ–°çš„
            } else {
                appContainer.innerHTML = renderPlanList();
            }
        }

        /** è¨­å®šæ´»èºè¨ˆç•« ID ä¸¦é‡æ–°æ¸²æŸ“ */
        window.setActivePlan = function(planId) {
            activePlanId = planId;
            renderApp();
        }

        /** è¨‚é–±æ—…éŠè¨ˆç•«åˆ—è¡¨ (Firestore Realtime) */
        function subscribeToPlans() {
            if (!isAuthenticated || !currentUserId || !db) return;

            const plansCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`);
            const q = query(plansCollectionRef);

            onSnapshot(q, (snapshot) => {
                plans = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => {
                    // åœ¨å®¢æˆ¶ç«¯æŒ‰å»ºç«‹æ™‚é–“å€’åºæ’åº (æœ€æ–°å»ºç«‹çš„åœ¨å‰)
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });
                
                // æ¯æ¬¡è³‡æ–™æ›´æ–°æ™‚ï¼Œé‡æ–°æ¸²æŸ“ App
                renderApp();
            }, (err) => {
                console.error("Firestore è¨‚é–±å¤±æ•—:", err);
                showMessage(`è³‡æ–™è®€å–å¤±æ•—: ${err.message}`, true);
            });
        }


        // --- 5. Modal æ§åˆ¶å‡½æ•¸ (Modal Control) ---

        /** æ‰“é–‹æ–°å¢è¨ˆç•« Modal */
        window.openAddPlanModal = function() {
            editingPlanId = null;
            document.getElementById('planModalTitle').textContent = 'æ–°å¢æ—…éŠè¨ˆç•«';
            document.getElementById('addPlanForm').reset();
            document.getElementById('addPlanModal').classList.add('open');
        }
        
        /** æ‰“é–‹ç·¨è¼¯è¨ˆç•« Modal */
        window.openEditPlanModal = function(planId) {
            const plan = plans.find(p => p.id === planId);
            if (!plan) return showMessage('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è¨ˆç•«ã€‚', true);

            editingPlanId = planId;
            document.getElementById('planModalTitle').textContent = 'ç·¨è¼¯æ—…éŠè¨ˆç•«';
            
            // å¡«å……è¡¨å–®
            document.getElementById('planName').value = plan.name || '';
            document.getElementById('planDestination').value = plan.destination || '';
            document.getElementById('planStartDate').value = plan.startDate || '';
            document.getElementById('planEndDate').value = plan.endDate || '';

            document.getElementById('addPlanModal').classList.add('open');
        }

        /** é—œé–‰æ–°å¢è¨ˆç•« Modal */
        window.closeAddPlanModal = function() {
            editingPlanId = null;
            document.getElementById('addPlanModal').classList.remove('open');
        }

        /** å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸä¸‹æ‹‰é¸å–® */
        function populateItineraryDates(activePlan) {
            const dateSelect = document.getElementById('itineraryDate');
            if (!dateSelect) return;

            datesArray = getDatesArray(activePlan.startDate, activePlan.endDate);
            dateSelect.innerHTML = datesArray.map(d => 
                `<option value="${d.date}">Day ${d.day} - ${formatDate(d.date)}</option>`
            ).join('');
        }
        
        /** æ‰“é–‹æ–°å¢è¡Œç¨‹ Modal ä¸¦é è¨­æ—¥æœŸ */
        window.openAddItineraryModal = function(preselectedDate = null) {
            if (!activePlanId) return showMessage('è«‹å…ˆé¸æ“‡ä¸€å€‹æ—…éŠè¨ˆç•«ã€‚', true);

            document.getElementById('itineraryModalTitle').textContent = 'æ–°å¢è¡Œç¨‹å¡ç‰‡';
            document.getElementById('addItineraryForm').reset();
            
            // å¡«å……æ—¥æœŸé¸å–® (åœ¨ renderPlanDetail ä¸­å·²èª¿ç”¨ï¼Œé€™è£¡ç¢ºä¿é é¸)
            const dateSelect = document.getElementById('itineraryDate');
            if (preselectedDate && dateSelect.querySelector(`option[value="${preselectedDate}"]`)) {
                dateSelect.value = preselectedDate;
            } else if (datesArray.length > 0) {
                 dateSelect.value = datesArray[0].date;
            }
            
            document.getElementById('addItineraryModal').classList.add('open');
        }

        /** é—œé–‰æ–°å¢è¡Œç¨‹ Modal */
        window.closeAddItineraryModal = function() {
            document.getElementById('addItineraryModal').classList.remove('open');
        }


        // --- 6. äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ– (Event Listeners & Init) ---

        /** è¨»å†Šè¡¨å–®æäº¤äº‹ä»¶: æ—…éŠè¨ˆç•« */
        document.getElementById('addPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('planName').value.trim();
            const destination = document.getElementById('planDestination').value.trim();
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;

            if (!name || !startDate || !endDate) {
                showMessage('è«‹å¡«å¯«è¨ˆç•«åç¨±ã€é–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸã€‚', true);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚', true);
                return;
            }

            handleSavePlan({ name, destination, startDate, endDate });
        });
        
        /** è¨»å†Šè¡¨å–®æäº¤äº‹ä»¶: æ¯æ—¥è¡Œç¨‹ */
        document.getElementById('addItineraryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const activity = document.getElementById('itineraryActivity').value.trim();
            const date = document.getElementById('itineraryDate').value;
            const time = document.getElementById('itineraryTime').value;
            const location = document.getElementById('itineraryLocation').value.trim();
            const notes = document.getElementById('itineraryNotes').value.trim();

            if (!activity || !date) {
                showMessage('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œæ—¥æœŸã€‚', true);
                return;
            }

            handleAddItinerary({ activity, date, time, location, notes });
        });
        
        /** æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•èˆ‡ Firebase åˆå§‹åŒ– */
        async function initializeAppAndFirebase() {
            
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase é…ç½®æœªæ›´æ–°ã€‚è«‹æ›¿æ› index.html ä¸­æ‰€æœ‰çš„ 'YOUR_...' é ç•™ä½ç½®ã€‚");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // --- èªè­‰æµç¨‹: å˜—è©¦ä»¥å›ºå®šå¸³è™Ÿç™»å…¥/å‰µå»º (ç¢ºä¿ Canvas å¯é‹è¡Œ) ---
                try {
                    await signInWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);
                } catch (loginError) {
                    await createUserWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);
                }
                
                // ä½¿ç”¨ onAuthStateChanged ç¢ºä¿åœ¨èªè­‰æˆåŠŸå¾Œæ‰åŸ·è¡Œè¨‚é–±
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthenticated = true;
                        console.log("èªè­‰æˆåŠŸã€‚UID:", currentUserId);
                        // ç¢ºä¿åœ¨èªè­‰æˆåŠŸå¾Œæ‰è¨‚é–±è³‡æ–™
                        subscribeToPlans();
                    } else {
                        currentUserId = null;
                        isAuthenticated = false;
                        plans = [];
                        renderApp();
                    }
                });

            } catch (e) {
                console.error("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:", e);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦åœæ­¢åŸ·è¡Œ
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = `
                    <div class="text-center bg-red-100 border-red-500 border-l-4 p-6 rounded-xl shadow-lg mt-8">
                        <h2 class="text-xl font-bold text-red-700 mb-2">åˆå§‹åŒ–å¤±æ•—</h2>
                        <p class="text-gray-700">${e.message}</p>
                        <p class="text-sm mt-4">è«‹ç¢ºä¿æ‚¨çš„ Firebase é…ç½®æ­£ç¢ºï¼Œä¸¦ä¸”é›»å­éƒµä»¶/å¯†ç¢¼èªè­‰å·²å•Ÿç”¨ã€‚</p>
                    </div>
                `;
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeAppAndFirebase();
    </script>
</body>
</html>