<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠè¡Œç¨‹ - 2026 é—œè¥¿æ—…ç¨‹</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å­—é«”èˆ‡ç§»å‹•ç«¯å„ªåŒ– */
        :root { font-family: 'Inter', sans-serif; }
        /* ç¢ºä¿åº•éƒ¨æŒ‰éˆ•ä¸è¢«é®æ“‹ */
        .content-area { padding-bottom: 80px; }
        .fab {
            /* æµ®å‹•åœ“å½¢æŒ‰éˆ• */
            width: 56px;
            height: 56px;
            box-shadow: 0 10px 15px -3px rgba(49, 46, 129, 0.5), 0 4px 6px -2px rgba(49, 46, 129, 0.2);
        }
        .trip-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .trip-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Loading éª¨æ¶å±å‹•ç•« */
        .skeleton {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- è¼‰å…¥ç™»å…¥ç‹€æ…‹å®ˆè¡› (Auth Guard) -->
    <script type="module" src="./auth-guard.js"></script>

    <!-- é é¢é ‚éƒ¨å°èˆªåˆ— -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="max-w-xl mx-auto flex justify-between items-center p-4">
            <h1 class="text-xl font-bold text-indigo-700">æˆ‘çš„æ—…ç¨‹</h1>
            <button id="logout-button" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full active:bg-red-50">
                ç™»å‡º
            </button>
        </div>
    </header>

    <!-- è¡Œç¨‹åˆ—è¡¨å€ -->
    <main class="content-area max-w-xl mx-auto p-4">
        
        <!-- Loading ç‹€æ…‹æˆ–ç„¡è¡Œç¨‹æ™‚çš„æç¤º -->
        <div id="loading-spinner" class="mt-8 text-center text-gray-500">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„æ—…ç¨‹åˆ—è¡¨...</p>
        </div>

        <!-- è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
        <div id="trip-list-container" class="space-y-4">
            <!-- è¡Œç¨‹å¡ç‰‡å°‡é€é JavaScript æ’å…¥é€™è£¡ -->
        </div>
        
        <!-- ç„¡è¡Œç¨‹æç¤º -->
        <div id="no-trips-message" class="mt-16 p-6 text-center text-gray-500 bg-white rounded-xl shadow hidden">
            <p class="text-lg font-semibold mb-2">æ‚¨å°šæœªå»ºç«‹ä»»ä½•æ—…ç¨‹ ğŸ‡¯ğŸ‡µ</p>
            <p class="text-sm">é»æ“Šå³ä¸‹è§’çš„æŒ‰éˆ•é–‹å§‹è¦åŠƒæ‚¨çš„ 2026 é—œè¥¿ä¹‹æ—…ï¼</p>
        </div>

    </main>

    <!-- æ–°å¢è¡Œç¨‹çš„ FAB (æµ®å‹•åœ“å½¢æŒ‰éˆ•) -->
    <button id="add-trip-fab" class="fab fixed bottom-6 right-6 flex items-center justify-center 
                                        bg-indigo-600 hover:bg-indigo-700 text-white 
                                        rounded-full transition duration-200 z-20 active:shadow-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- é é¢é‚è¼¯è…³æœ¬ -->
    <script type="module">
        import { auth, db } from './auth.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, query, onSnapshot, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI å…ƒç´ 
        const tripListContainer = document.getElementById('trip-list-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noTripsMessage = document.getElementById('no-trips-message');
        const logoutButton = document.getElementById('logout-button');
        const addTripFab = document.getElementById('add-trip-fab');

        let currentUserId = null;
        let unsubscribe = null; // ç”¨æ–¼å„²å­˜ Firestore ç›£è½å™¨çš„å–æ¶ˆå‡½å¼

        // ç™»å‡ºåŠŸèƒ½
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºå¾Œ auth-guard.js æœƒè‡ªå‹•å°å‘ login.html
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚"); // å¯¦éš›æ‡‰ç”¨ç¨‹å¼æ‡‰ä½¿ç”¨è‡ªè¨‚ Modal
            }
        });

        // ç›£è½ AuthReady äº‹ä»¶ï¼Œç¢ºä¿ Firebase æœå‹™å·²åˆå§‹åŒ–ä¸”ç”¨æˆ¶å·²ç™»å…¥
        document.addEventListener('authReady', (e) => {
            currentUserId = e.detail.uid;
            
            // ç”±æ–¼ Auth å·²å°±ç·’ï¼Œå¯ä»¥å®‰å…¨åœ°é–‹å§‹è¼‰å…¥è¡Œç¨‹
            loadTrips();
        });

        // è¼‰å…¥è¡Œç¨‹åˆ—è¡¨
        function loadTrips() {
            if (!currentUserId) {
                console.error("éŒ¯èª¤: ç”¨æˆ¶ ID å°šæœªè¼‰å…¥ã€‚");
                return;
            }

            // æ ¹æ“šæ‚¨çš„æ¶æ§‹ï¼Œè¡Œç¨‹è³‡æ–™æ‡‰å­˜å„²åœ¨å…±ç”¨è·¯å¾‘ä¸‹ï¼Œä»¥ä¾¿åœ˜éšŠæˆå“¡ç·¨è¼¯
            // å‡è¨­å…±ç”¨è¡Œç¨‹çš„è·¯å¾‘ç‚º: /artifacts/{appId}/public/data/trips
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const tripsColRef = collection(db, `artifacts/${appId}/public/data/trips`);
            
            // æŸ¥è©¢: é€™è£¡æˆ‘å€‘åªé¡¯ç¤ºåœ˜éšŠæˆå“¡çš„è¡Œç¨‹ï¼Œç‚ºäº†æ¸¬è©¦ï¼Œæˆ‘å€‘æš«æ™‚é¡¯ç¤ºæ‰€æœ‰å…¬é–‹è¡Œç¨‹
            // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸€å€‹ 'members' é™£åˆ—ä¾†éæ¿¾
            const tripsQuery = query(
                tripsColRef,
                // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘åœ¨é€™è£¡ä¸ä½¿ç”¨ orderByï¼Œé¿å…Firestoreç´¢å¼•å•é¡Œã€‚
                // å¯¦éš›æ’åºæ‡‰åœ¨å‰ç«¯é€²è¡Œã€‚
            );

            // è¨­å®š Firestore å³æ™‚ç›£è½
            unsubscribe = onSnapshot(tripsQuery, (snapshot) => {
                loadingSpinner.classList.add('hidden'); // éš±è—è¼‰å…¥æç¤º
                tripListContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

                if (snapshot.empty) {
                    noTripsMessage.classList.remove('hidden');
                    return;
                }

                noTripsMessage.classList.add('hidden');
                
                // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ—ä¸¦åœ¨å‰ç«¯æ’åº
                const trips = [];
                snapshot.forEach(doc => {
                    trips.push({ id: doc.id, ...doc.data() });
                });
                
                // ä¾æ“šæœ€å¾Œç·¨è¼¯æ™‚é–“æ’åº (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                trips.sort((a, b) => {
                    // å°‡ Firebase Timestamp è½‰æ›ç‚ºæ•¸å­—é€²è¡Œæ¯”è¼ƒ
                    const timeA = a.lastEditedTime?.toMillis() || 0;
                    const timeB = b.lastEditedTime?.toMillis() || 0;
                    return timeB - timeA;
                });

                // æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨
                trips.forEach(trip => {
                    const card = createTripCard(trip);
                    tripListContainer.appendChild(card);
                });

            }, (error) => {
                console.error("Firestore å³æ™‚ç›£è½å¤±æ•—:", error);
                loadingSpinner.innerHTML = `<p class="text-red-600">è¼‰å…¥éŒ¯èª¤: ${error.message}ã€‚è«‹æª¢æŸ¥å®‰å…¨è¦å‰‡ã€‚</p>`;
            });
        }

        // å»ºç«‹å–®å€‹è¡Œç¨‹å¡ç‰‡çš„ HTML å…ƒç´ 
        function createTripCard(trip) {
            const startDate = trip.startDate ? new Date(trip.startDate.seconds * 1000).toLocaleDateString('zh-TW') : 'æœªå®š';
            const endDate = trip.endDate ? new Date(trip.endDate.seconds * 1000).toLocaleDateString('zh-TW') : 'æœªå®š';
            
            const lastEditedTime = trip.lastEditedTime 
                ? new Date(trip.lastEditedTime.seconds * 1000).toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' })
                : 'ç„¡';
            
            const lastEditorName = trip.lastEditorName || 'åŒ¿åä½¿ç”¨è€…';
            
            const card = document.createElement('a');
            card.href = `trip.html?tripId=${trip.id}`; // é»æ“Šé€²å…¥è¡Œç¨‹å…§å®¹é 
            card.className = 'trip-card block bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-indigo-400 transition duration-150 cursor-pointer';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h2 class="text-xl font-extrabold text-gray-800 truncate">${trip.name || 'æœªå‘½åæ—…ç¨‹'}</h2>
                    <!-- ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• (é€™è£¡åªæ˜¯è¦–è¦ºå ä½ç¬¦ï¼Œå¯¦éš›æ‰‹å‹¢æ“ä½œå°‡åœ¨ä¸‹ä¸€æ­¥å¯¦ä½œ) -->
                    <div class="flex space-x-2 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l-7-7m7 7l7-7m-7 7l7-7m-7 1l4-4m-4 4l4-4"/></svg>
                        <!-- <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hover:text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 12.04A2 2 0 0116.14 21H7.86a2 2 0 01-1.99-1.96L5 7m1 0h12m-6 4v6m-4-6v6m8-6v6"/></svg> -->
                    </div>
                </div>
                
                <p class="text-sm font-semibold text-indigo-600 mb-4">${startDate} ~ ${endDate}</p>

                <div class="flex justify-between text-xs text-gray-500">
                    <div>
                        <span class="font-medium">å¤©æ•¸:</span> ${trip.daysCount || 0} å¤©
                    </div>
                    <div class="text-right">
                        <span class="font-medium">æœ€å¾Œç·¨è¼¯è€…:</span> ${lastEditorName}
                        <br>
                        <span class="font-medium">ç·¨è¼¯æ™‚é–“:</span> ${lastEditedTime}
                    </div>
                </div>
            `;
            return card;
        }

        // æ–°å¢è¡Œç¨‹åŠŸèƒ½ (å½ˆå‡º Modal æˆ–è·³è½‰åˆ°ç·¨è¼¯é é¢)
        addTripFab.addEventListener('click', () => {
            // é€™è£¡å¯ä»¥å°å‘ trip.html æˆ–å½ˆå‡ºä¸€å€‹ Modal è®“ç”¨æˆ¶è¼¸å…¥è¡Œç¨‹åç¨±
            // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„æç¤ºå’Œè·³è½‰
            const tripName = prompt("è«‹è¼¸å…¥æ–°è¡Œç¨‹åç¨±:");
            if (tripName) {
                // é€™è£¡æ‡‰è©²å°‡è³‡æ–™å¯«å…¥ Firestoreï¼Œç„¶å¾Œè·³è½‰
                alert(`æ­£åœ¨å‰µå»ºæ–°çš„è¡Œç¨‹: ${tripName}`); // å¯¦éš›æ‡‰ç”¨ç¨‹å¼æ‡‰ä½¿ç”¨ setDoc/addDoc
                // window.location.href = 'trip.html?mode=new'; 
            }
        });

        // ç•¶é é¢è¢«å¸è¼‰æ™‚ï¼Œå–æ¶ˆ Firestore çš„ç›£è½
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

    </script>
</body>
</html>