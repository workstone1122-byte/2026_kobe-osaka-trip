<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¡Œç¨‹è¦åŠƒ</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        .page-container { max-width: 640px; }
        .trip-card {
            transition: all 0.2s ease-in-out;
        }
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* æ‡¸æµ®æ–°å¢æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
        @media (min-width: 640px) {
            /* è®“æŒ‰éˆ•åœ¨ PC æ¨¡å¼ä¸‹ï¼Œä¹Ÿä¿æŒåœ¨å…§å®¹å€åŸŸçš„å³ä¸‹æ–¹ */
            .fab {
                right: calc(50% - 320px + 24px); /* max-width: 640px / 2 + 24px é‚Šè· */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- æ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼Œåœ¨åˆå§‹åŒ–å®Œæˆå‰é è¨­éš±è— -->
    <div id="app-container" class="hidden">
        
        <!-- é é¢é ‚éƒ¨å°èˆªåˆ— -->
        <header class="sticky top-0 bg-white shadow-md z-10">
            <div class="page-container mx-auto flex justify-between items-center p-4">
                <h1 class="text-2xl font-bold text-indigo-700">æˆ‘çš„æ—…ç¨‹</h1>
                <button id="logout-button" class="text-gray-500 hover:text-red-600 transition duration-150 p-2 rounded-full active:bg-red-50" title="ç™»å‡º">
                    <!-- Lucide: Log Out Icon - å°‡é€é JS è¼‰å…¥ -->
                </button>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€å¡Š -->
        <main class="page-container mx-auto p-4">
            
            <!-- ç”¨æˆ¶ ID é¡¯ç¤º (ç”¨æ–¼æ¸¬è©¦èˆ‡å”ä½œ) -->
            <div class="mb-4 p-3 bg-indigo-100 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                <span class="font-medium">æ‚¨çš„ç”¨æˆ¶ ID (UID):</span> 
                <code id="user-id-display" class="font-mono text-xs break-all ml-1">è¼‰å…¥ä¸­...</code>
            </div>

            <!-- è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
            <div id="trip-list" class="space-y-4">
                <!-- è¡Œç¨‹å¡ç‰‡å°‡é€šé JavaScript æ¸²æŸ“åœ¨æ­¤è™• -->
            </div>

            <!-- ç©ºè¡Œç¨‹æç¤º (é è¨­éš±è—) -->
            <div id="no-trips-message" class="hidden text-center mt-20 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                <span class="text-6xl" role="img" aria-label="Japan Flag">ğŸ‡¯ğŸ‡µ</span>
                <p class="mt-4 text-xl font-semibold text-gray-700">æ‚¨å°šæœªå»ºç«‹ä»»ä½•æ—…ç¨‹</p>
                <p class="text-gray-500 mt-2">é»æ“Šå³ä¸‹è§’çš„ <span class="font-bold">+</span> æŒ‰éˆ•ï¼Œé–‹å§‹è¦åŠƒæ‚¨çš„ç¬¬ä¸€è¶Ÿæ—…è¡Œï¼</p>
            </div>
        </main>
        
        <!-- æ‡¸æµ®æ–°å¢æŒ‰éˆ• (FAB) -->
        <button id="add-trip-fab" class="fab p-4 bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 transition duration-200 ease-in-out transform hover:scale-105 active:scale-95" title="æ–°å¢è¡Œç¨‹">
            <!-- Lucide: Plus Icon - å°‡é€é JS è¼‰å…¥ -->
        </button>

    </div>

    <!-- è¼‰å…¥å’ŒéŒ¯èª¤ç‹€æ…‹ä»‹é¢ (åˆå§‹åŒ–æ™‚é¡¯ç¤º) -->
    <div id="status-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl border border-gray-100 text-center">
            <div id="loading-indicator" class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
                <p class="text-indigo-600 font-medium">æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼èˆ‡é©—è­‰èº«ä»½...</p>
            </div>
            <div id="initialization-error" class="hidden mt-6 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200">
                <p class="font-bold mb-2">æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ï¼</p>
                <p id="error-details">è«‹æª¢æŸ¥ Firebase é…ç½®æˆ–ç¶²è·¯é€£ç·šã€‚</p>
            </div>
        </div>
    </div>
    
    <!-- è‡ªè¨‚è¼¸å…¥ Modal (æ–°å¢è¡Œç¨‹) -->
    <div id="new-trip-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">æ–°å¢æ—…ç¨‹</h3>
            <form id="new-trip-form">
                <label for="new-trip-name" class="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥æ–°è¡Œç¨‹åç¨±ï¼š</label>
                <input type="text" id="new-trip-name" required maxlength="50"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       placeholder="ä¾‹å¦‚ï¼š2026 ç¥æˆ¶å¤§é˜ªç¾é£Ÿä¹‹æ—…">
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-new-trip"
                            class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="create-trip-button"
                            class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">
                        å»ºç«‹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è‡ªè¨‚åˆªé™¤ç¢ºèª Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-red-700">ç¢ºèªåˆªé™¤</h3>
            <p id="delete-modal-message" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete"
                        class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                    å–æ¶ˆ
                </button>
                <button type="button" id="confirm-delete"
                        class="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">
                    ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>


    <!-- æ•´åˆå¾Œçš„å–®ä¸€æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (åŒ…å« Firebase åˆå§‹åŒ–ã€èªè­‰å’Œæ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒ) -->
    <script type="module">
        // --- 1. Firebase æ ¸å¿ƒæœå‹™åˆå§‹åŒ–èˆ‡èªè­‰æª¢æŸ¥ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // å°å…¥ Email/Password ç™»å…¥åŠŸèƒ½
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, query, onSnapshot, doc, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®šæ—¥èªŒç´šåˆ¥
        setLogLevel('debug'); 

        // =======================================================
        // æ‚¨çš„ Firebase é…ç½®
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBsMiLUgtJtcv48iRp_9QFx5fShtRd6Lro",
            authDomain: "kobe-osaka-2026travel.firebaseapp.com",
            projectId: "kobe-osaka-2026travel",
            storageBucket: "kobe-osaka-2026travel.firebasestorage.app",
            messagingSenderId: "772246724994",
            appId: "1:772246724994:web:26c067ae1096d13ebdef9b"
        };
        // =======================================================
        
        // =======================================================
        // *** æ¸¬è©¦å°ˆç”¨æ†‘è­‰ (å·²ç¡¬ç·¨ç¢¼åˆ°ç¨‹å¼ç¢¼ä¸­) ***
        // =======================================================
        const TEST_EMAIL = "test@team.com";
        const TEST_PASSWORD = "password123";
        // =======================================================

        // ç’°å¢ƒè®Šæ•¸
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        let firebaseInitialized = false; 
        
        // UI å…ƒç´ 
        const appContainer = document.getElementById('app-container');
        const statusContainer = document.getElementById('status-container');
        const errorDetails = document.getElementById('error-details');
        const loadingIndicator = document.getElementById('loading-indicator');
        const initializationError = document.getElementById('initialization-error');
        
        // æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼ UI å…ƒç´ 
        const tripListElement = document.getElementById('trip-list');
        const noTripsMessage = document.getElementById('no-trips-message');
        const addTripFab = document.getElementById('add-trip-fab');
        const logoutButton = document.getElementById('logout-button');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Modal å…ƒç´ 
        const newTripModal = document.getElementById('new-trip-modal');
        const newTripForm = document.getElementById('new-trip-form');
        const newTripNameInput = document.getElementById('new-trip-name');
        const cancelNewTripButton = document.getElementById('cancel-new-trip');
        const createTripButton = document.getElementById('create-trip-button');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        let tripToDeleteId = null; 

        let unsubscribe = null; 
        let currentUserId = null; 

        // --- è¼”åŠ©å‡½æ•¸ï¼šéŒ¯èª¤è™•ç†èˆ‡ UI ç‹€æ…‹ ---
        function displayError(message) {
            loadingIndicator.classList.add('hidden');
            initializationError.classList.remove('hidden');
            errorDetails.textContent = message;
        }

        // --- 0. è¦–è¦ºå…ƒç´ åˆå§‹åŒ– (æ’å…¥ Lucide åœ–æ¨™) ---
        function initializeIcons() {
            if (typeof lucide !== 'undefined') {
                document.getElementById('logout-button').innerHTML = lucide.createIcons()['log-out'].toSvg({ class: 'h-6 w-6' });
                document.getElementById('add-trip-fab').innerHTML = lucide.createIcons()['plus'].toSvg({ class: 'h-8 w-8' });
            }
        }
        initializeIcons();


        // --- 2. Firebase åˆå§‹åŒ–èˆ‡èªè­‰ ---
        if (!firebaseConfig.apiKey) {
            displayError('Firebase é…ç½®ä¿¡æ¯ç¼ºå¤± (apiKey)ï¼Œç„¡æ³•å•Ÿå‹•ã€‚');
        } else {
            try {
                // å˜—è©¦åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseInitialized = true; 
                
                // å•Ÿå‹•èªè­‰æµç¨‹
                handleSignIn();

            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                displayError('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–éŒ¯èª¤ï¼š' + e.message);
            }
        }

        async function handleSignIn() {
            if (!firebaseInitialized) return;

            try {
                // *** æ ¸å¿ƒè®Šå‹•ï¼šä½¿ç”¨ signInWithEmailAndPassword ç™»å…¥ ***
                console.log(`å˜—è©¦ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ ${TEST_EMAIL} ç™»å…¥...`);
                const userCredential = await signInWithEmailAndPassword(auth, TEST_EMAIL, TEST_PASSWORD);
                
                currentUserId = userCredential.user.uid;
                console.log("ç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶ ID:", currentUserId);
                
                // é¡¯ç¤ºä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢
                statusContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                // é–‹å§‹è¼‰å…¥è¡Œç¨‹è³‡æ–™
                startTripListener(currentUserId);
                userIdDisplay.textContent = currentUserId;
                addTripFab.disabled = false;

            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                // æä¾›æ›´æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯ï¼ŒæŒ‡ç¤ºå¯èƒ½æ˜¯å¸³å¯†å•é¡Œ
                displayError(`èº«ä»½é©—è­‰å¤±æ•—ï¼š${error.message}ã€‚è«‹ç¢ºèªæ¸¬è©¦å¸³è™Ÿ ${TEST_EMAIL} å·²åœ¨ Firebase å°ˆæ¡ˆä¸­è¨»å†Šä¸¦å•Ÿç”¨ã€‚`);
            }
        }

        // --- 3. æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        
        // ç°¡æ˜“çš„é€šç”¨ Modal æ›¿æ› confirm/alert
        const showConfirmModal = (message, onConfirm) => {
            // åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ window.confirm ä½œç‚ºè‡¨æ™‚æ›¿ä»£
            if (window.confirm(message)) {
                onConfirm();
            }
        };
        const showSimpleMessage = (title, message, type) => {
             // åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ alert ä½œç‚ºè‡¨æ™‚æ›¿ä»£
             alert(`${title}: ${message}`);
        };


        // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶è™•ç†
        logoutButton.addEventListener('click', async () => {
            showConfirmModal('æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', async () => {
                try {
                    if (unsubscribe) {
                         unsubscribe(); // å–æ¶ˆç›£è½
                    }
                    await signOut(auth);
                    // ç™»å‡ºæˆåŠŸå¾Œï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥é é¢ï¼Œæœƒå†æ¬¡è§¸ç™¼ç™»å…¥æµç¨‹
                    window.location.reload(); 
                } catch (error) {
                    console.error("ç™»å‡ºå¤±æ•—:", error);
                    showSimpleMessage('éŒ¯èª¤', 'ç™»å‡ºå¤±æ•—: ' + error.message, 'error'); 
                }
            });
        });


        // é¡¯ç¤º/éš±è—åˆªé™¤ç¢ºèª Modal
        const showDeleteModal = (tripId, name) => {
            tripToDeleteId = tripId;
            document.getElementById('delete-modal-message').innerHTML = `æ‚¨ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ <strong>${name}</strong> å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œä¸¦æœƒåˆªé™¤æ‰€æœ‰è¡Œç¨‹æ—¥è³‡æ–™ã€‚`;
            deleteModal.classList.remove('hidden');
        };

        const hideDeleteModal = () => {
            deleteModal.classList.add('hidden');
            tripToDeleteId = null;
        };
        
        // åˆªé™¤æ“ä½œé‚è¼¯
        const handleDeleteTrip = async () => {
            if (!tripToDeleteId || !currentUserId || !db) return;

            const deletingTripId = tripToDeleteId;
            hideDeleteModal(); 
            
            try {
                // åˆªé™¤ä¸»è¡Œç¨‹æ–‡ä»¶ (åœ¨ Firestore è¦å‰‡ä¸­ï¼Œé€™æ‡‰è©²æœƒé˜»æ­¢åˆªé™¤å¸¶æœ‰å­é›†åˆçš„æ–‡ä»¶ï¼Œä½†æˆ‘å€‘ç›®å‰å‡è¨­åªæœ‰é ‚å±¤æ–‡ä»¶)
                const tripRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', deletingTripId);
                await deleteDoc(tripRef);
                
                console.log(`è¡Œç¨‹ ${deletingTripId} åˆªé™¤æˆåŠŸ.`);

            } catch (error) {
                console.error("åˆªé™¤è¡Œç¨‹å¤±æ•—:", error);
                showSimpleMessage('éŒ¯èª¤', `åˆªé™¤è¡Œç¨‹å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // è¨­ç½®åˆªé™¤ Modal çš„äº‹ä»¶ç›£è½å™¨
        confirmDeleteButton.addEventListener('click', handleDeleteTrip);
        cancelDeleteButton.addEventListener('click', hideDeleteModal);
        
        
        // --- æ¸²æŸ“å–®å€‹è¡Œç¨‹å¡ç‰‡ ---
        const renderTripCard = (trip) => {
            const usersIconSvg = lucide.createIcons()['users'].toSvg({ class: 'h-3 w-3 mr-1' });
            const chevronIconSvg = lucide.createIcons()['chevron-right'].toSvg({ class: 'h-6 w-6' });

            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'flex items-center space-x-2';
            
            const card = document.createElement('div');
            card.dataset.id = trip.id; 
            card.className = 'trip-card bg-white p-5 rounded-xl shadow-lg border border-gray-100 cursor-pointer flex-grow flex items-center justify-between';
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">${trip.name}</h3>
                    <p class="text-sm text-gray-500 mt-1">
                        <span class="mr-3">å¤©æ•¸: ${trip.days}</span>
                        <span class="text-xs inline-flex items-center font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                            ${usersIconSvg}
                            å…±ç·¨: ${trip.memberCount || 1}
                        </span>
                    </p>
                    <p class="text-xs text-gray-400 mt-2">æœ€å¾Œæ›´æ–°: ${trip.lastUpdated ? new Date(trip.lastUpdated.seconds * 1000).toLocaleString('zh-TW') : 'N/A'}</p>
                </div>
                <div class="text-indigo-500">
                    ${chevronIconSvg}
                </div>
            `;
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-3 text-red-500 hover:text-red-700 rounded-full hover:bg-red-50 transition duration-150 flex-shrink-0';
            deleteButton.title = 'åˆªé™¤æ­¤è¡Œç¨‹';
            deleteButton.innerHTML = lucide.createIcons()['trash-2'].toSvg({ class: 'h-6 w-6' });

            // é»æ“Šäº‹ä»¶ï¼šæš«æ™‚ä½¿ç”¨ alert æç¤ºï¼Œå› ç‚ºè©³ç´°è¡Œç¨‹é å°šæœªå‰µå»º
            card.addEventListener('click', () => {
                showSimpleMessage('å°èˆªæç¤º', `æ‚¨é»æ“Šäº†è¡Œç¨‹: ${trip.name} (ID: ${trip.id})ã€‚\n\nä¸‹ä¸€æ­¥å¯ä»¥å‰µå»ºä¸€å€‹åç‚º trip.html çš„æ–°æª”æ¡ˆä¾†ç·¨è¼¯è©³ç´°è¡Œç¨‹ã€‚`, 'info');
            });
            
            // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                showDeleteModal(trip.id, trip.name);
            });
            
            cardWrapper.appendChild(card);
            cardWrapper.appendChild(deleteButton);

            return cardWrapper;
        };


        // --- å•Ÿå‹• Firestore ç›£è½ ---
        const startTripListener = (userId) => {
            if (!firebaseInitialized) return;

            // å®šç¾©è¡Œç¨‹é›†åˆçš„è·¯å¾‘: /artifacts/{APP_ID}/public/data/trips
            const tripsCollectionRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips');
            const q = query(tripsCollectionRef); 

            if (unsubscribe) {
                unsubscribe();
            }

            // å¯¦æ™‚ç›£è½ (onSnapshot)
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const trips = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    trips.push({
                        id: doc.id,
                        name: data.name || 'æœªå‘½åè¡Œç¨‹',
                        days: data.days || 1,
                        memberCount: data.members ? data.members.length : 1, 
                        lastUpdated: data.updatedAt 
                    });
                });

                // åœ¨å®¢æˆ¶ç«¯æ’åºï¼Œä¾æ“šæœ€å¾Œæ›´æ–°æ™‚é–“é™åºæ’åˆ—
                trips.sort((a, b) => {
                    const dateA = a.lastUpdated ? a.lastUpdated.seconds : 0;
                    const dateB = b.lastUpdated ? b.lastUpdated.seconds : 0;
                    return dateB - dateA;
                });

                // æ¸²æŸ“ UI
                tripListElement.innerHTML = '';
                if (trips.length === 0) {
                    noTripsMessage.classList.remove('hidden');
                } else {
                    noTripsMessage.classList.add('hidden');
                    trips.forEach(trip => {
                        tripListElement.appendChild(renderTripCard(trip));
                    });
                }
            }, (error) => {
                console.error("Firestore ç›£è½å¤±æ•—:", error);
                showSimpleMessage('éŒ¯èª¤', "ç„¡æ³•è¼‰å…¥è¡Œç¨‹åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¨­å®šã€‚", 'error');
                noTripsMessage.classList.remove('hidden'); 
                noTripsMessage.innerHTML = `<span class="text-red-500">è¼‰å…¥å¤±æ•—ï¼${error.code}</span>`;
            });
        };


        // é»æ“Š '+' æŒ‰éˆ•æ–°å¢è¡Œç¨‹çš„é‚è¼¯
        addTripFab.addEventListener('click', () => {
            if (!currentUserId) {
                 showSimpleMessage('æç¤º', "è«‹å…ˆç™»å…¥ä»¥å‰µå»ºè¡Œç¨‹ï¼", 'info');
                 return;
            }
            // é¡¯ç¤ºè‡ªå®šç¾© Modal
            newTripModal.classList.remove('hidden');
            newTripNameInput.focus();
        });
        
        // å–æ¶ˆæŒ‰éˆ•é‚è¼¯
        cancelNewTripButton.addEventListener('click', () => {
            newTripModal.classList.add('hidden');
            newTripForm.reset(); 
        });

        // è¡¨å–®æäº¤é‚è¼¯
        newTripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || !db) return;

            const tripName = newTripNameInput.value.trim();
            if (!tripName) return; 
            
            createTripButton.disabled = true;
            createTripButton.textContent = 'å»ºç«‹ä¸­...';
            
            try {
                const userId = currentUserId;
                const newTripRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips');

                // æº–å‚™æ–°çš„è¡Œç¨‹è³‡æ–™
                const newTripData = {
                    name: tripName,
                    days: 1, // é è¨­ 1 å¤©
                    members: [userId], 
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };
                
                // å¯«å…¥ Firestore
                const docRef = await addDoc(newTripRef, newTripData);
                console.log("æ–°è¡Œç¨‹æ–‡ä»¶å¯«å…¥æˆåŠŸï¼ŒID:", docRef.id);
                
                // éš±è— Modal
                newTripModal.classList.add('hidden');
                newTripForm.reset(); 
                
                showSimpleMessage('å»ºç«‹æˆåŠŸ', `æ–°çš„è¡Œç¨‹ "${tripName}" å·²å‰µå»ºï¼æ‚¨å¯ä»¥ç¹¼çºŒåœ¨åˆ—è¡¨ä¸­ç·¨è¼¯ã€‚`, 'success');
                
            } catch (error) {
                console.error("æ–°å¢è¡Œç¨‹å¤±æ•—:", error);
                showSimpleMessage('éŒ¯èª¤', "æ–°å¢è¡Œç¨‹å¤±æ•—ï¼š" + error.message, 'error');
            } finally {
                createTripButton.disabled = false;
                createTripButton.textContent = 'å»ºç«‹';
            }
        });

        // ç•¶é é¢è¢«å¸è¼‰æ™‚ï¼Œå–æ¶ˆ Firestore çš„ç›£è½
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
                console.log("Firestore ç›£è½å·²å–æ¶ˆã€‚");
            }
        });

    </script>
</body>
</html>