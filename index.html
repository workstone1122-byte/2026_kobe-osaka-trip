<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入您的旅行規劃器</title>
    <!-- 載入 Tailwind CSS 框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    
    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl border border-gray-100 text-center">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-4">旅行規劃</h1>
        <p class="text-gray-500 mb-8">正在為您準備最佳的協作體驗...</p>

        <div id="loading-indicator" class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
            <p class="text-indigo-600 font-medium">正在驗證身份並載入...</p>
        </div>

        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200">
            身份驗證失敗，請檢查配置。
        </div>

    </div>

    <!-- Firebase 身份驗證邏輯 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定日誌級別
        setLogLevel('debug'); 

        // 取得環境變數配置
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            // 雖然這個頁面只處理登入，但為了初始化完整，仍取得 db 實例
            getFirestore(app); 

            async function handleSignIn() {
                try {
                    let userCredential;
                    
                    if (initialAuthToken) {
                        console.log("使用自訂認證令牌登入...");
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        console.log("使用匿名身份登入 (未提供令牌)...");
                        userCredential = await signInAnonymously(auth);
                    }

                    console.log("登入成功，用戶 ID:", userCredential.user.uid);
                    
                    // 登入成功，導向主頁
                    window.location.replace('./home.html'); 

                } catch (error) {
                    console.error("登入失敗:", error);
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('error-message').classList.remove('hidden');
                }
            }

            handleSignIn();

        } catch (e) {
            console.error("Firebase 初始化失敗:", e);
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('error-message').textContent = '應用程式初始化錯誤，請檢查 Firebase 配置。';
        }
    </script>
</body>
</html>