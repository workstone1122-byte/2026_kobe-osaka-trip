import React, { useState, useEffect } from 'react';
import { Calendar, MapPin, Clock, Plus, Trash2, X } from 'lucide-react';

// ============================================
// ğŸ”§ å·¥å…·å‡½æ•¸æ¨¡å¡Š (Utility Functions)
// ============================================

/**
 * æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
 * @param {string} dateString - YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸå­—ä¸²
 * @returns {string} æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸ "YYYY/MM/DD (é€±X)"
 */
const formatDate = (dateString) => {
  if (!dateString) return 'æ—¥æœŸæœªå®š';
  try {
    const date = new Date(dateString);
    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekday = weekdays[date.getDay()];
    
    return `${year}/${month}/${day} (é€±${weekday})`;
  } catch (error) {
    console.error("æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:", error);
    return dateString;
  }
};

/**
 * ç”Ÿæˆæ—¥æœŸç¯„åœé™£åˆ—
 * @param {string} start - é–‹å§‹æ—¥æœŸ YYYY-MM-DD
 * @param {string} end - çµæŸæ—¥æœŸ YYYY-MM-DD
 * @returns {Array} åŒ…å«æ‰€æœ‰æ—¥æœŸå’Œå¤©æ•¸ç·¨è™Ÿçš„é™£åˆ—
 */
const getDatesArray = (start, end) => {
  const dates = [];
  let currentDate = new Date(start + 'T00:00:00');
  const endDate = new Date(end + 'T00:00:00');
  let dayCount = 1;

  while (currentDate <= endDate) {
    dates.push({
      date: currentDate.toISOString().split('T')[0],
      day: dayCount
    });
    currentDate.setDate(currentDate.getDate() + 1);
    dayCount++;
  }
  return dates;
};

/**
 * ç”Ÿæˆå”¯ä¸€ ID
 * @returns {string} å”¯ä¸€è­˜åˆ¥ç¢¼
 */
const generateId = () => {
  return `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
};

// ============================================
// ğŸ¨ UI çµ„ä»¶æ¨¡å¡Š (UI Components)
// ============================================

/**
 * æ¨¡æ…‹è¦–çª—çµ„ä»¶ - å¯é‡ç”¨çš„å½ˆå‡ºè¦–çª—
 * @param {Object} props
 * @param {boolean} props.isOpen - æ˜¯å¦é¡¯ç¤º
 * @param {Function} props.onClose - é—œé–‰å›èª¿
 * @param {string} props.title - æ¨™é¡Œ
 * @param {ReactNode} props.children - å…§å®¹
 */
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
        <div className="flex justify-between items-center mb-4 border-b pb-3">
          <h2 className="text-2xl font-bold text-gray-800">{title}</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
            <X className="w-6 h-6" />
          </button>
        </div>
        {children}
      </div>
    </div>
  );
};

/**
 * è¨Šæ¯æç¤ºçµ„ä»¶ - é¡¯ç¤ºæˆåŠŸ/éŒ¯èª¤è¨Šæ¯
 */
const MessageAlert = ({ message, type = 'success', onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 5000);
    return () => clearTimeout(timer);
  }, [onClose]);

  const className = type === 'error' 
    ? 'bg-red-100 border-red-400 text-red-700' 
    : 'bg-green-100 border-green-400 text-green-700';

  return (
    <div className={`${className} border-l-4 p-4 rounded-lg shadow-md mb-6`}>
      <p className="font-bold">{type === 'error' ? 'éŒ¯èª¤' : 'é€šçŸ¥'}</p>
      <p>{message}</p>
    </div>
  );
};

/**
 * æ—…éŠè¨ˆç•«å¡ç‰‡çµ„ä»¶
 */
const PlanCard = ({ plan, onView, onDelete }) => {
  return (
    <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-xl transition duration-300 border-t-4 border-indigo-500">
      <div>
        <h3 className="text-xl font-bold text-gray-800 mb-2">{plan.name}</h3>
        <div className="text-sm text-gray-500 space-y-1">
          <p className="flex items-center">
            <Calendar className="w-4 h-4 mr-2 text-indigo-400" />
            {formatDate(plan.startDate)}
          </p>
          <p className="flex items-center">
            <Calendar className="w-4 h-4 mr-2 text-indigo-400" />
            {formatDate(plan.endDate)}
          </p>
          {plan.destination && (
            <p className="flex items-center">
              <MapPin className="w-4 h-4 mr-2 text-indigo-400" />
              {plan.destination}
            </p>
          )}
        </div>
      </div>
      <div className="flex justify-end space-x-3 mt-4">
        <button
          onClick={() => onDelete(plan.id)}
          className="p-2 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50"
          title="åˆªé™¤è¨ˆç•«"
        >
          <Trash2 className="w-5 h-5" />
        </button>
        <button
          onClick={() => onView(plan.id)}
          className="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-xl transition duration-300"
        >
          æŸ¥çœ‹è¡Œç¨‹
        </button>
      </div>
    </div>
  );
};

/**
 * è¡Œç¨‹å¡ç‰‡çµ„ä»¶
 */
const ItineraryCard = ({ item, onDelete }) => {
  return (
    <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500 relative ml-4 transition duration-300 hover:shadow-lg">
      <div className="flex justify-between items-start">
        <div className="flex-1">
          <div className="flex items-center text-sm font-medium text-emerald-600 mb-1">
            <Clock className="w-4 h-4 mr-2" />
            {item.time || 'å…¨å¤©'}
          </div>
          <h4 className="text-lg font-bold text-gray-800 mb-2">{item.activity}</h4>
          {item.location && (
            <p className="text-sm text-gray-600 flex items-center">
              <MapPin className="w-4 h-4 mr-1 text-gray-400" />
              åœ°é»: {item.location}
            </p>
          )}
          {item.notes && item.notes !== 'ç„¡å‚™è¨»' && (
            <p className="text-sm text-gray-500 mt-2 italic border-t border-gray-100 pt-2">
              å‚™è¨»: {item.notes}
            </p>
          )}
        </div>
        <button
          onClick={() => onDelete(item.id)}
          className="p-1 text-red-400 hover:text-red-600 transition duration-150 rounded-full"
          title="åˆªé™¤è¡Œç¨‹"
        >
          <Trash2 className="w-4 h-4" />
        </button>
      </div>
    </div>
  );
};

// ============================================
// ğŸ“‹ è¡¨å–®çµ„ä»¶æ¨¡å¡Š (Form Components)
// ============================================

/**
 * æ–°å¢/ç·¨è¼¯è¨ˆç•«è¡¨å–®
 */
const PlanForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    name: '',
    destination: '',
    startDate: '',
    endDate: ''
  });

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.name || !formData.startDate || !formData.endDate) {
      alert('è«‹å¡«å¯«è¨ˆç•«åç¨±ã€é–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸã€‚');
      return;
    }

    if (new Date(formData.startDate) > new Date(formData.endDate)) {
      alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚');
      return;
    }

    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±*</label>
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
          required
        />
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700">ç›®çš„åœ° (å¯é¸)</label>
        <input
          type="text"
          name="destination"
          value={formData.destination}
          onChange={handleChange}
          className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">é–‹å§‹æ—¥æœŸ*</label>
          <input
            type="date"
            name="startDate"
            value={formData.startDate}
            onChange={handleChange}
            className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ*</label>
          <input
            type="date"
            name="endDate"
            value={formData.endDate}
            onChange={handleChange}
            className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            required
          />
        </div>
      </div>
      <div className="pt-4 flex justify-end space-x-3">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
        >
          å–æ¶ˆ
        </button>
        <button
          type="submit"
          className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md"
        >
          å»ºç«‹è¨ˆç•«
        </button>
      </div>
    </form>
  );
};

/**
 * æ–°å¢è¡Œç¨‹è¡¨å–®
 */
const ItineraryForm = ({ dates, onSubmit, onCancel, preselectedDate }) => {
  const [formData, setFormData] = useState({
    activity: '',
    date: preselectedDate || (dates[0]?.date || ''),
    time: '',
    location: '',
    notes: ''
  });

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.activity || !formData.date) {
      alert('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œæ—¥æœŸã€‚');
      return;
    }

    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-700">æ´»å‹•åç¨±*</label>
        <input
          type="text"
          name="activity"
          value={formData.activity}
          onChange={handleChange}
          className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
          required
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">é¸æ“‡æ—¥æœŸ*</label>
          <select
            name="date"
            value={formData.date}
            onChange={handleChange}
            className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            required
          >
            {dates.map(d => (
              <option key={d.date} value={d.date}>
                Day {d.day} - {formatDate(d.date)}
              </option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">æ™‚é–“ (å¯é¸)</label>
          <input
            type="time"
            name="time"
            value={formData.time}
            onChange={handleChange}
            className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
          />
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700">åœ°é» (å¯é¸)</label>
        <input
          type="text"
          name="location"
          value={formData.location}
          onChange={handleChange}
          className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
        />
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700">å‚™è¨»/ç­†è¨˜ (å¯é¸)</label>
        <textarea
          name="notes"
          value={formData.notes}
          onChange={handleChange}
          rows="3"
          className="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
        />
      </div>
      <div className="pt-4 flex justify-end space-x-3">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
        >
          å–æ¶ˆ
        </button>
        <button
          type="submit"
          className="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition shadow-md"
        >
          å„²å­˜è¡Œç¨‹
        </button>
      </div>
    </form>
  );
};

// ============================================
// ğŸ  ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶ (Main App Component)
// ============================================

export default function TravelPlanner() {
  // ============================================
  // ç‹€æ…‹ç®¡ç† (State Management)
  // ============================================
  
  const [plans, setPlans] = useState([]); // æ‰€æœ‰æ—…éŠè¨ˆç•«
  const [activePlanId, setActivePlanId] = useState(null); // ç•¶å‰æŸ¥çœ‹çš„è¨ˆç•« ID
  const [showPlanModal, setShowPlanModal] = useState(false); // é¡¯ç¤ºæ–°å¢è¨ˆç•«å½ˆçª—
  const [showItineraryModal, setShowItineraryModal] = useState(false); // é¡¯ç¤ºæ–°å¢è¡Œç¨‹å½ˆçª—
  const [preselectedDate, setPreselectedDate] = useState(null); // é é¸çš„æ—¥æœŸ
  const [message, setMessage] = useState(null); // è¨Šæ¯æç¤º {text, type}

  // ============================================
  // åˆå§‹åŒ– - å¾ localStorage è¼‰å…¥è³‡æ–™
  // ============================================
  
  useEffect(() => {
    const savedPlans = localStorage.getItem('travelPlans');
    if (savedPlans) {
      setPlans(JSON.parse(savedPlans));
    }
  }, []);

  // ============================================
  // è³‡æ–™æŒä¹…åŒ– - å„²å­˜åˆ° localStorage
  // ============================================
  
  useEffect(() => {
    if (plans.length > 0) {
      localStorage.setItem('travelPlans', JSON.stringify(plans));
    }
  }, [plans]);

  // ============================================
  // è¨ˆç•«æ“ä½œå‡½æ•¸ (Plan Operations)
  // ============================================

  /**
   * æ–°å¢æ—…éŠè¨ˆç•«
   */
  const handleAddPlan = (planData) => {
    const newPlan = {
      id: generateId(),
      ...planData,
      itineraries: [],
      createdAt: new Date().toISOString()
    };
    
    setPlans([newPlan, ...plans]);
    setShowPlanModal(false);
    setMessage({ text: 'æ—…éŠè¨ˆç•«å»ºç«‹æˆåŠŸ!', type: 'success' });
  };

  /**
   * åˆªé™¤æ—…éŠè¨ˆç•«
   */
  const handleDeletePlan = (planId) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ—…éŠè¨ˆç•«å—?é€™å°‡ç„¡æ³•å¾©åŸã€‚')) return;
    
    setPlans(plans.filter(p => p.id !== planId));
    if (activePlanId === planId) setActivePlanId(null);
    setMessage({ text: 'æ—…éŠè¨ˆç•«å·²åˆªé™¤ã€‚', type: 'success' });
  };

  // ============================================
  // è¡Œç¨‹æ“ä½œå‡½æ•¸ (Itinerary Operations)
  // ============================================

  /**
   * æ–°å¢è¡Œç¨‹é …ç›®
   */
  const handleAddItinerary = (itineraryData) => {
    const newItinerary = {
      id: generateId(),
      ...itineraryData,
      notes: itineraryData.notes || 'ç„¡å‚™è¨»'
    };

    setPlans(plans.map(plan => {
      if (plan.id === activePlanId) {
        return {
          ...plan,
          itineraries: [...plan.itineraries, newItinerary]
        };
      }
      return plan;
    }));

    setShowItineraryModal(false);
    setPreselectedDate(null);
    setMessage({ text: 'è¡Œç¨‹å¡ç‰‡æ–°å¢æˆåŠŸ!', type: 'success' });
  };

  /**
   * åˆªé™¤è¡Œç¨‹é …ç›®
   */
  const handleDeleteItinerary = (itineraryId) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å¡ç‰‡å—?')) return;

    setPlans(plans.map(plan => {
      if (plan.id === activePlanId) {
        return {
          ...plan,
          itineraries: plan.itineraries.filter(item => item.id !== itineraryId)
        };
      }
      return plan;
    }));

    setMessage({ text: 'è¡Œç¨‹å¡ç‰‡å·²åˆªé™¤ã€‚', type: 'success' });
  };

  // ============================================
  // æ¸²æŸ“é‚è¼¯ (Render Logic)
  // ============================================

  const activePlan = plans.find(p => p.id === activePlanId);
  const datesArray = activePlan ? getDatesArray(activePlan.startDate, activePlan.endDate) : [];

  /**
   * æ¸²æŸ“å–®æ—¥è¡Œç¨‹
   */
  const renderDayItinerary = (date, day) => {
    const dayItineraries = activePlan.itineraries
      .filter(item => item.date === date)
      .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

    return (
      <div key={date} className="relative border-l-4 border-indigo-300 ml-4 pl-6">
        <div className="absolute -left-3 top-0 bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">
          Day {day}
        </div>
        <h3 className="text-xl font-semibold text-gray-800 mb-6 mt-0 pt-0 ml-4">
          {formatDate(date)}
        </h3>

        <div className="space-y-6">
          {dayItineraries.length === 0 ? (
            <div className="text-gray-500 italic ml-4">é€™ä¸€å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ã€‚</div>
          ) : (
            dayItineraries.map(item => (
              <ItineraryCard key={item.id} item={item} onDelete={handleDeleteItinerary} />
            ))
          )}

          <button
            onClick={() => {
              setPreselectedDate(date);
              setShowItineraryModal(true);
            }}
            className="flex items-center justify-center w-full max-w-sm ml-4 bg-white border-2 border-dashed border-indigo-300 text-indigo-600 hover:bg-indigo-50 transition duration-150 py-3 rounded-xl shadow-sm font-medium"
          >
            <Plus className="w-5 h-5 mr-2" />
            æ–°å¢ç•¶æ—¥è¡Œç¨‹å¡ç‰‡
          </button>
        </div>
      </div>
    );
  };

  // ============================================
  // ä¸»è¦æ¸²æŸ“ (Main Render)
  // ============================================

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-8">
      {/* è¨Šæ¯æç¤º */}
      {message && (
        <MessageAlert
          message={message.text}
          type={message.type}
          onClose={() => setMessage(null)}
        />
      )}

      {/* è¨ˆç•«åˆ—è¡¨è¦–åœ– */}
      {!activePlanId && (
        <>
          <header className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-extrabold text-gray-900">æˆ‘çš„æ—…éŠè¨ˆç•«</h1>
            <button
              onClick={() => setShowPlanModal(true)}
              className="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105"
            >
              <Plus className="w-5 h-5 mr-2" />
              æ–°å¢è¨ˆç•«
            </button>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {plans.length === 0 ? (
              <div className="col-span-full text-center py-10 bg-white rounded-xl shadow">
                <p className="text-xl text-gray-500">å°šç„¡æ—…éŠè¨ˆç•«ã€‚é»æ“Šã€Œæ–°å¢è¨ˆç•«ã€é–‹å§‹è¦åŠƒ!</p>
              </div>
            ) : (
              plans.map(plan => (
                <PlanCard
                  key={plan.id}
                  plan={plan}
                  onView={setActivePlanId}
                  onDelete={handleDeletePlan}
                />
              ))
            )}
          </div>
        </>
      )}

      {/* è¡Œç¨‹è©³æƒ…è¦–åœ– */}
      {activePlanId && activePlan && (
        <>
          <header className="mb-6 bg-white p-6 rounded-xl shadow-lg border-b-4 border-indigo-600">
            <div className="flex justify-between items-start mb-4">
              <div>
                <button
                  onClick={() => setActivePlanId(null)}
                  className="text-indigo-600 hover:text-indigo-800 transition mb-2 flex items-center"
                >
                  â† è¿”å›è¨ˆç•«åˆ—è¡¨
                </button>
                <h1 className="text-3xl font-extrabold text-gray-900">{activePlan.name}</h1>
                <p className="text-md text-gray-500 mt-1">
                  {formatDate(activePlan.startDate)} ~ {formatDate(activePlan.endDate)} ({datesArray.length} å¤©)
                </p>
                {activePlan.destination && (
                  <p className="text-sm text-gray-600 mt-2 flex items-center">
                    <MapPin className="w-4 h-4 mr-1 text-gray-400" />
                    {activePlan.destination}
                  </p>
                )}
              </div>
              <button
                onClick={() => handleDeletePlan(activePlan.id)}
                className="p-3 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50 border border-red-200"
                title="åˆªé™¤æ­¤è¨ˆç•«"
              >
                <Trash2 className="w-5 h-5" />
              </button>
            </div>
          </header>

          <div className="space-y-10">
            {datesArray.map(({ date, day }) => renderDayItinerary(date, day))}
          </div>
        </>
      )}

      {/* æ–°å¢è¨ˆç•« Modal */}
      <Modal
        isOpen={showPlanModal}
        onClose={() => setShowPlanModal(false)}
        title="æ–°å¢æ—…éŠè¨ˆç•«"
      >
        <PlanForm
          onSubmit={handleAddPlan}
          onCancel={() => setShowPlanModal(false)}
        />
      </Modal>

      {/* æ–°å¢è¡Œç¨‹ Modal */}
      <Modal
        isOpen={showItineraryModal}
        onClose={() => {
          setShowItineraryModal(false);
          setPreselectedDate(null);
        }}
        title="æ–°å¢è¡Œç¨‹å¡ç‰‡"
      >
        <ItineraryForm
          dates={datesArray}
          preselectedDate={preselectedDate}
          onSubmit={handleAddItinerary}
          onCancel={() => {
            setShowItineraryModal(false);
            setPreselectedDate(null);
          }}
        />
      </Modal>
    </div>
  );
}