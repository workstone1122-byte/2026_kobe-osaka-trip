<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊行程規劃器</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以獲得更好的現代感 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 隱藏原生彈出式對話框，我們使用自定義 Modal */
        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="p-4 sm:p-8">
        <!-- 應用程式內容將由 JavaScript 動態插入 -->
        <div class="flex items-center justify-center min-h-screen">
            <p class="text-lg font-semibold text-indigo-600">載入中... 正在連接 Firebase...</p>
        </div>
    </div>

    <!-- Modal for Adding/Editing Plan -->
    <div id="addPlanModal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800">新增旅遊計畫</h3>
            <form id="planForm">
                <div class="mb-4">
                    <label for="planTitle" class="block text-gray-700 font-medium mb-1">標題</label>
                    <input type="text" id="planTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div class="mb-4">
                    <label for="planDestination" class="block text-gray-700 font-medium mb-1">目的地</label>
                    <input type="text" id="planDestination" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div class="mb-4">
                    <label for="planDuration" class="block text-gray-700 font-medium mb-1">天數</label>
                    <input type="number" id="planDuration" min="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div class="mb-6">
                    <label for="planNotes" class="block text-gray-700 font-medium mb-1">備註 (可選)</label>
                    <textarea id="planNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('addPlanModal')" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
                    <button type="submit" id="savePlanBtn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">儲存計畫</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Confirmation/Alerts -->
    <div id="alertModal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300 scale-95 modal-content">
            <h3 id="alertTitle" class="text-xl font-bold mb-3 text-gray-800">訊息</h3>
            <p id="alertMessage" class="text-gray-700 mb-6"></p>
            <div id="alertActions" class="flex justify-end space-x-3">
                <button type="button" id="alertConfirmBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">確認</button>
                <button type="button" id="alertCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 啟用 Firestore 偵錯日誌
        setLogLevel('Debug');

        // =========================================================================
        // !!! Netlify 部署配置修改 !!!
        // 請將以下 firebaseConfig 中的預留位置替換為您實際的 Firebase 專案設定值。
        // __firebase_config 變數在外部環境中不存在。
        // =========================================================================
        // Your web app's Firebase configuration
		const firebaseConfig = {
		  apiKey: "AIzaSyBsMiLUgtJtcv48iRp_9QFx5fShtRd6Lro",
		  authDomain: "kobe-osaka-2026travel.firebaseapp.com",
		  projectId: "kobe-osaka-2026travel",
		  storageBucket: "kobe-osaka-2026travel.firebasestorage.app",
		  messagingSenderId: "772246724994",
		  appId: "1:772246724994:web:26c067ae1096d13ebdef9b"
		};
		
		
        
        // 使用 projectId 作為應用程式 ID (appId) 的替代品
        const appId = firebaseConfig.projectId || 'netlify-travel-planner';
        
        // 檢查是否已替換配置
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            document.getElementById('app').innerHTML = `
                <div class="text-center bg-yellow-100 border-yellow-500 border-l-4 p-6 rounded-xl shadow-lg mt-8 max-w-lg mx-auto">
                    <h2 class="text-xl font-bold text-yellow-700 mb-2">配置錯誤</h2>
                    <p class="text-gray-700">請在 index.html 檔案中，將 Firebase 配置區塊 (約 120 行) 的所有 <strong class="font-extrabold">YOUR_...</strong> 預留位置替換為您的實際值。</p>
                </div>
            `;
            throw new Error("Firebase 配置尚未更新。請替換所有 'YOUR_...' 預留位置。");
        }
        // =========================================================================
        
        let app, db, auth;
        let currentUserId = null;
        let isAuthenticated = false;
        let plans = [];
        let editingPlanId = null;

        /**
         * 初始化 Firebase
         */
        async function initializeFirebase() {
            try {
                // 1. 初始化 Firebase App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. 認證：使用標準的 onAuthStateChanged 監聽器
                // 注意：在 Netlify 部署中，您需要為使用者提供一個實際的登入/註冊 UI
                // 這裡我們仍然使用匿名登入作為未登入狀態的啟動方式。
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthenticated = true;
                        console.log("認證狀態變更: 已登入", currentUserId);
                        // 確保在認證成功後才訂閱資料
                        subscribeToPlans();
                    } else {
                        // 如果沒有登入，嘗試匿名登入作為 fallback
                        signInAnonymously(auth).then(anonUser => {
                            // onAuthStateChanged 會再次觸發，並處理用戶狀態
                            if (anonUser) console.log("使用匿名登入作為 fallback");
                        }).catch(e => {
                            console.error("匿名登入失敗:", e);
                            renderError(new Error("無法建立匿名會話，請檢查 Firebase Auth 設定 (Anonymous 應啟用)。"));
                        });

                        currentUserId = null;
                        isAuthenticated = false;
                        plans = []; // 清空資料
                        renderApp();
                    }
                    renderApp(); // 每次狀態變更都更新 UI
                });


            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
                renderError(e);
            }
        }
        
        // ... (subscribeToPlans, renderApp, handleFormSubmit, deletePlan, renderError, showModal, closeModal 函數保持不變)

        /** 訂閱旅遊計畫列表 */
        function subscribeToPlans() {
            // 只有在 Firebase 初始化且用戶 ID 確定後才執行
            if (!isAuthenticated || !currentUserId || !db) return; 

            // 注意：我們使用 appId (projectId) 和 currentUserId 來構建路徑
            const plansCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`);
            // 在 Firestore 中使用 serverTimestamp 進行排序可能需要索引，
            // 為了避免索引錯誤，我們在這裡使用 getDocs 或在客戶端進行排序
            const q = query(plansCollectionRef);

            onSnapshot(q, (snapshot) => {
                plans = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => {
                    // 在客戶端按建立時間倒序排序 (如果 createdAt 存在)
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });
                
                // 每次資料更新時，重新渲染 App
                renderApp();
            }, (err) => {
                console.error("Firestore 訂閱錯誤:", err);
                renderError(new Error("無法訂閱資料。請檢查 Firestore 規則或網路連線。"));
            });
        }

        /** 渲染應用程式主介面 */
        function renderApp() {
            const appDiv = document.getElementById('app');
            
            // 檢查認證狀態是否就緒且配置正確
            if (!auth || !db || !currentUserId) {
                 // 如果配置錯誤已顯示，則不再覆蓋
                if (appDiv.querySelector('.text-yellow-700')) return; 
                 // 顯示載入中或等待認證的訊息
                 appDiv.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <p class="text-lg font-semibold text-indigo-600">正在等待認證狀態...</p>
                    </div>
                `;
                return;
            }

            const planListHtml = plans.length > 0
                ? plans.map(plan => `
                    <div class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition duration-200 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0" data-id="${plan.id}">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${plan.title}</h3>
                            <p class="text-indigo-600 font-medium">目的地: ${plan.destination}</p>
                            <p class="text-gray-500 text-sm">${plan.duration} 天 | 建立時間: ${plan.createdAt ? plan.createdAt.toDate().toLocaleDateString('zh-TW') : 'N/A'}</p>
                            ${plan.notes ? `<p class="text-gray-700 mt-2 text-sm italic border-l-2 border-indigo-200 pl-2">${plan.notes}</p>` : ''}
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button onclick="editPlan('${plan.id}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition duration-150 text-sm font-medium">編輯</button>
                            <button onclick="deletePlan('${plan.id}', '${plan.title}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-150 text-sm font-medium">刪除</button>
                        </div>
                    </div>
                `).join('')
                : `
                    <p class="text-center text-gray-500 p-8 border border-dashed border-gray-300 rounded-xl">您目前沒有任何旅遊計畫。點擊「新增計畫」開始規劃您的旅程吧！</p>
                `;

            appDiv.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
                        <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">旅遊行程規劃器</h1>
                        <p class="text-gray-600">您的用戶 ID：<code class="bg-gray-100 p-1 rounded text-sm font-mono text-indigo-500">${currentUserId}</code></p>
                        <p class="text-gray-600 text-sm mt-1">此 ID 用於資料隔離，其他用戶需知道此 ID 才能加入您的私人協作（如果應用程式支援的話）。</p>
                    </header>

                    <div class="flex justify-end mb-6">
                        <button onclick="openModal('addPlanModal')" class="flex items-center px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 transform hover:scale-[1.02] active:scale-100">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            新增計畫
                        </button>
                    </div>

                    <div id="planList" class="space-y-4">
                        ${planListHtml}
                    </div>
                </div>
            `;
        }

        /** 處理表單提交 */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAuthenticated || !currentUserId || !db) {
                renderError(new Error("用戶未認證，無法儲存資料。"));
                return;
            }

            const title = document.getElementById('planTitle').value.trim();
            const destination = document.getElementById('planDestination').value.trim();
            const duration = parseInt(document.getElementById('planDuration').value, 10);
            const notes = document.getElementById('planNotes').value.trim();

            if (!title || !destination || isNaN(duration) || duration <= 0) {
                showMessage("錯誤", "請檢查標題、目的地和天數是否已正確輸入。", "alert");
                return;
            }

            const planData = {
                title,
                destination,
                duration,
                notes,
                updatedAt: serverTimestamp(),
            };

            const savePlanBtn = document.getElementById('savePlanBtn');
            const originalText = savePlanBtn.textContent;
            savePlanBtn.textContent = '儲存中...';
            savePlanBtn.disabled = true;

            try {
                if (editingPlanId) {
                    // 編輯現有計畫
                    const planRef = doc(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`, editingPlanId);
                    await updateDoc(planRef, planData);
                    showMessage("成功", `旅遊計畫 "${title}" 已成功更新。`, "alert");
                } else {
                    // 新增計畫
                    planData.createdAt = serverTimestamp();
                    const plansCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`);
                    await addDoc(plansCollectionRef, planData);
                    showMessage("成功", `旅遊計畫 "${title}" 已成功建立。`, "alert");
                }
                closeModal('addPlanModal');
            } catch (e) {
                console.error("儲存計畫時發生錯誤:", e);
                renderError(new Error(`儲存資料時發生錯誤: ${e.message}`));
            } finally {
                savePlanBtn.textContent = originalText;
                savePlanBtn.disabled = false;
                editingPlanId = null;
            }
        }

        /** 編輯計畫 */
        function editPlan(id) {
            const plan = plans.find(p => p.id === id);
            if (!plan) {
                showMessage("錯誤", "找不到要編輯的計畫。", "alert");
                return;
            }
            editingPlanId = id;
            document.getElementById('modalTitle').textContent = '編輯旅遊計畫';
            document.getElementById('planTitle').value = plan.title;
            document.getElementById('planDestination').value = plan.destination;
            document.getElementById('planDuration').value = plan.duration;
            document.getElementById('planNotes').value = plan.notes || '';
            openModal('addPlanModal');
        }

        /** 刪除計畫 */
        function deletePlan(id, title) {
            if (!isAuthenticated || !currentUserId || !db) return;

            confirmAction("確認刪除", `您確定要刪除旅遊計畫 "${title}" 嗎？此操作無法撤銷。`, async () => {
                try {
                    const planRef = doc(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`, id);
                    await deleteDoc(planRef);
                    showMessage("成功", `計畫 "${title}" 已刪除。`, "alert");
                } catch (e) {
                    console.error("刪除計畫時發生錯誤:", e);
                    renderError(new Error(`刪除資料時發生錯誤: ${e.message}`));
                }
            });
        }

        /** 渲染錯誤訊息 */
        function renderError(e) {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="max-w-xl mx-auto text-center bg-red-100 border-red-500 border-l-4 p-6 rounded-xl shadow-lg mt-8">
                    <h2 class="text-xl font-bold text-red-700 mb-2">錯誤/初始化失敗</h2>
                    <p class="text-gray-700">${e.message}</p>
                    <p class="text-sm mt-4">請檢查您的 Firebase 配置和 Firestore 規則。</p>
                </div>
            `;
        }
        
        // =========================================================================
        // Modal 和自定義 Alert 函數
        // =========================================================================

        /** 開啟 Modal */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('open');
            }
        }

        /** 關閉 Modal */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('open');
                // 重置新增/編輯表單
                if (modalId === 'addPlanModal') {
                    document.getElementById('planForm').reset();
                    document.getElementById('modalTitle').textContent = '新增旅遊計畫';
                    editingPlanId = null;
                }
            }
        }

        /** 顯示自定義訊息/警報 */
        function showMessage(title, message, type = "alert") {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;

            const confirmBtn = document.getElementById('alertConfirmBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            
            // 警報模式 (Alert Mode)
            if (type === "alert") {
                confirmBtn.textContent = "確定";
                confirmBtn.onclick = () => closeModal('alertModal');
                cancelBtn.style.display = 'none';
                confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
            
            openModal('alertModal');
        }

        /** 顯示自定義確認對話框 */
        function confirmAction(title, message, onConfirm) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;

            const confirmBtn = document.getElementById('alertConfirmBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            
            // 確認模式 (Confirm Mode)
            confirmBtn.textContent = "確認刪除";
            cancelBtn.textContent = "取消";
            cancelBtn.style.display = 'inline-block';
            
            confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');


            confirmBtn.onclick = () => {
                onConfirm();
                closeModal('alertModal');
            };
            cancelBtn.onclick = () => closeModal('alertModal');

            openModal('alertModal');
        }
        
        // =========================================================================
        // 啟動應用程式
        // =========================================================================
        window.onload = () => {
            initializeFirebase();
            document.getElementById('planForm').addEventListener('submit', handleFormSubmit);

            // 讓編輯和刪除函數可以在 HTML 中被調用
            window.editPlan = editPlan;
            window.deletePlan = deletePlan;
            window.openModal = openModal;
            window.closeModal = closeModal;
            window.confirmAction = confirmAction;
        };

    </script>
</body>
</html>