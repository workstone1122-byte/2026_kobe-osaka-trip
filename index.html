<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 連線與身份驗證</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體並確保全寬佈局 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

    <div class="container w-full bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Firebase 服務初始化</h1>

        <div id="status" class="w-full text-center p-4 rounded-lg font-medium text-lg 
                                  bg-yellow-100 text-yellow-800 transition duration-300">
            正在初始化 Firebase 與身份驗證...
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Firebase 配置詳細資訊</h2>
            
            <div id="config-display" class="bg-gray-50 p-4 rounded-lg text-sm break-all">
                <p><span class="font-medium text-gray-600">App ID:</span> <span id="app-id-display">N/A</span></p>
                <p><span class="font-medium text-gray-600">Project ID:</span> <span id="project-id-display">N/A</span></p>
                <p><span class="font-medium text-gray-600">API Key Exists:</span> <span id="api-key-status" class="font-semibold text-red-500">No</span></p>
                <p class="mt-3"><span class="font-medium text-gray-600">Firestore Path Example (Public):</span> <code>/artifacts/&lt;appId&gt;/public/data/items</code></p>
                <p><span class="font-medium text-gray-600">Firestore Path Example (Private):</span> <code>/artifacts/&lt;appId&gt;/users/&lt;userId&gt;/data/items</code></p>
            </div>
        </div>
    </div>

    <script type="module">
        // 匯入 Firebase 核心模組、Auth 與 Firestore 服務
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firestore 偵錯等級，方便開發
        setLogLevel('debug');

        // --- 1. 取得環境變數與配置 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 更新配置顯示區
        document.getElementById('app-id-display').textContent = appId;
        document.getElementById('project-id-display').textContent = firebaseConfig.projectId || 'N/A';
        document.getElementById('api-key-status').textContent = firebaseConfig.apiKey ? 'Yes' : 'No';
        if(firebaseConfig.apiKey) {
            document.getElementById('api-key-status').classList.replace('text-red-500', 'text-green-600');
        }

        // 檢查配置是否完整
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase Configuration is missing.");
            document.getElementById('status').textContent = '錯誤：Firebase 配置遺失！';
            document.getElementById('status').classList.replace('bg-yellow-100', 'bg-red-100');
            document.getElementById('status').classList.replace('text-yellow-800', 'text-red-800');
            return;
        }


        // --- 2. 初始化 Firebase 服務 ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // 設定 Auth 持久性 (Session)
        setPersistence(auth, browserSessionPersistence);


        // --- 3. 處理身份驗證 ---
        onAuthStateChanged(auth, async (user) => {
            const statusElement = document.getElementById('status');
            
            if (user) {
                // 已登入：狀態更新為成功
                const userId = user.uid;
                statusElement.textContent = `成功連線！使用者 ID: ${userId}`;
                statusElement.classList.remove('bg-yellow-100', 'text-yellow-800');
                statusElement.classList.add('bg-green-100', 'text-green-800');
                console.log("Firebase initialized and user signed in with UID:", userId);
                
                // 這裡可以開始執行 Firestore 相關操作
                // 例如: await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'myCollection'));

            } else {
                // 未登入：嘗試使用自訂令牌或匿名登入
                statusElement.textContent = '正在嘗試登入...';
                
                try {
                    // 檢查環境中是否有自訂令牌，若有則使用它
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        // onAuthStateChanged 會再次觸發，進入上面的 if 區塊
                    } else {
                        // 否則使用匿名登入
                        await signInAnonymously(auth);
                        // onAuthStateChanged 會再次觸發，進入上面的 if 區塊
                    }
                } catch (error) {
                    // 登入失敗：狀態更新為失敗
                    console.error("身份驗證失敗 (Auth Failed):", error);
                    statusElement.textContent = '身份驗證失敗！請檢查配置或規則。';
                    statusElement.classList.remove('bg-yellow-100', 'text-yellow-800');
                    statusElement.classList.add('bg-red-100', 'text-red-800');
                }
            }
        });
    </script>
</body>
</html>