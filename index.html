<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊行程規劃器</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以獲得更好的現代感 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 隱藏原生彈出式對話框，我們使用自定義 Modal */
        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="p-4 sm:p-8">
        <!-- 應用程式內容將由 JavaScript 動態插入 -->
        <div class="flex items-center justify-center min-h-screen">
            <p class="text-lg font-semibold text-indigo-600">載入中... 正在連接 Firebase...</p>
        </div>
    </div>

    <!-- Modal for Adding/Editing Plan -->
    <div id="addPlanModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800" id="planModalTitle">新增旅遊計畫</h2>
                <button onclick="closeAddPlanModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addPlanForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">計畫名稱*</label>
                    <input type="text" id="planName" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">目的地 (可選)</label>
                    <input type="text" id="planDestination" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">開始日期*</label>
                        <input type="date" id="planStartDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">結束日期*</label>
                        <input type="date" id="planEndDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddPlanModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        建立計畫
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Adding Itinerary -->
    <div id="addItineraryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800">新增行程卡片</h2>
                <button onclick="closeAddItineraryModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="addItineraryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">活動名稱*</label>
                    <input type="text" id="itineraryActivity" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">選擇日期*</label>
                        <select id="itineraryDate" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" required>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">時間 (可選)</label>
                        <input type="time" id="itineraryTime" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">地點 (可選)</label>
                    <input type="text" id="itineraryLocation" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">備註/筆記 (可選)</label>
                    <textarea id="itineraryNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddItineraryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition shadow-md">
                        儲存行程
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, // 引入 Email/Password 登入
            createUserWithEmailAndPassword // 引入 Email/Password 註冊
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration and Credentials ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // 定義硬編碼的測試用戶憑證
        const HARDCODED_EMAIL = 'test@team.com';
        const HARDCODED_PASSWORD = '123456';


        // --- Global State Variables ---
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthenticated = false;
        let plans = [];
        let activePlanId = null;
        let datesArray = []; // Store dates for active plan


        // --- Helper Functions ---

        /**
         * 將日期字串格式化為 "YYYY/MM/DD (週X)"
         * @param {string} dateString - 格式為 YYYY-MM-DD 的日期字串
         */
        function formatDate(dateString) {
            if (!dateString) return '日期未定';
            try {
                const date = new Date(dateString);
                // 處理時區問題，確保日期正確
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); 

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const weekday = weekdays[date.getDay()];
                return `${year}/${month}/${day} (週${weekday})`;
            } catch (error) {
                console.error("日期格式化錯誤:", error);
                return dateString;
            }
        }

        /**
         * 計算兩個日期之間的天數（含起訖日）
         * @param {string} start - 開始日期 (YYYY-MM-DD)
         * @param {string} end - 結束日期 (YYYY-MM-DD)
         * @returns {Array<{date: string, day: number}>} - 包含日期和天數編號的陣列
         */
        function getDatesArray(start, end) {
            const dates = [];
            // 確保日期是 UTC 午夜，避免時區偏差
            let currentDate = new Date(start + 'T00:00:00');
            const endDate = new Date(end + 'T00:00:00');
            let dayCount = 1;

            while (currentDate <= endDate) {
                dates.push({
                    date: currentDate.toISOString().split('T')[0],
                    day: dayCount
                });
                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;
            }
            return dates;
        }

        /**
         * 獲取 Firestore 文件參考路徑
         * @param {string} planId - 旅遊計畫 ID
         */
        function getPlanDocRef(planId) {
            if (!db || !currentUserId) throw new Error("Firebase 未初始化或用戶 ID 未知");
            // 使用 /artifacts/{appId}/users/{userId}/travel_plans 路徑 (私有路徑)
            return doc(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`, planId);
        }

        /**
         * 顯示自定義錯誤訊息 (取代 alert)
         * @param {string} message - 訊息內容
         */
        function showMessage(message, isError = false) {
            const app = document.getElementById('app');
            const existingMessage = document.getElementById('appMessage');
            if (existingMessage) existingMessage.remove();

            const className = isError 
                ? 'bg-red-100 border-red-400 text-red-700' 
                : 'bg-green-100 border-green-400 text-green-700';

            const messageHtml = `
                <div id="appMessage" class="${className} border-l-4 p-4 rounded-lg shadow-md mb-6 transition-all duration-300">
                    <p class="font-bold">${isError ? '錯誤' : '通知'}</p>
                    <p>${message}</p>
                </div>
            `;
            // 插入到 App 容器的頂部
            app.insertAdjacentHTML('afterbegin', messageHtml);
            // 3 秒後自動消失
            setTimeout(() => {
                document.getElementById('appMessage')?.classList.add('opacity-0');
                setTimeout(() => document.getElementById('appMessage')?.remove(), 300);
            }, 5000); // 延長顯示時間，讓用戶看清楚
        }

        // --- Firebase CRUD Operations ---

        /** 新增旅遊計畫 */
        async function handleAddPlan(planData) {
            if (!db || !currentUserId) return;

            try {
                // 使用 collection(db, `path`) 確保路徑正確
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`), {
                    ...planData,
                    userId: currentUserId,
                    itineraries: [], // 初始行程為空陣列
                    createdAt: serverTimestamp()
                });
                closeAddPlanModal();
                showMessage('旅遊計畫建立成功！');
            } catch (e) {
                console.error("新增計畫失敗:", e);
                showMessage(`新增計畫失敗: ${e.message}`, true);
            }
        }

        /** 刪除旅遊計畫 */
        async function handleDeletePlan(planId) {
            if (!db || !currentUserId) return;

            // 使用自定義確認視窗來取代 window.confirm
            if (!confirmAction('確定要刪除此旅遊計畫嗎？這將無法復原。')) return;
            
            try {
                await deleteDoc(getPlanDocRef(planId));
                activePlanId = null; // 如果刪除當前計畫，則返回列表
                showMessage('旅遊計畫已刪除。');
            } catch (e) {
                console.error("刪除計畫失敗:", e);
                showMessage(`刪除計畫失敗: ${e.message}`, true);
            }
        }

        /** 新增行程卡片 */
        async function handleAddItinerary(itineraryData) {
            if (!activePlanId) return;

            try {
                const planDocRef = getPlanDocRef(activePlanId);
                const planDoc = await getDoc(planDocRef);
                if (!planDoc.exists()) {
                    throw new Error("找不到旅遊計畫。");
                }

                // 由於 Firestore 不支援直接對陣列元素進行操作 (如 arrayUnion/remove for complex objects),
                // 我們採用讀取、修改、寫入整個陣列的方式。
                let currentItineraries = planDoc.data().itineraries || [];
                
                // 確認 itineraryData.date 是 string 且是 YYYY-MM-DD 格式
                if (!itineraryData.date || typeof itineraryData.date !== 'string') {
                    throw new Error("行程日期無效。");
                }
                
                const newItinerary = {
                    id: crypto.randomUUID(), // 使用 UUID 確保唯一性
                    ...itineraryData,
                    order: currentItineraries.length + 1, // 簡單排序
                    notes: itineraryData.notes || '無備註'
                };

                currentItineraries.push(newItinerary);

                await updateDoc(planDocRef, {
                    itineraries: currentItineraries
                });

                closeAddItineraryModal();
                showMessage('行程卡片新增成功！');

            } catch (e) {
                console.error("新增行程失敗:", e);
                showMessage(`新增行程失敗: ${e.message}`, true);
            }
        }

        /** 刪除行程卡片 */
        async function handleDeleteItinerary(itineraryId) {
            if (!activePlanId) return;

            // 使用自定義確認視窗來取代 window.confirm
            if (!confirmAction('確定要刪除此行程卡片嗎？')) return;

            try {
                const planDocRef = getPlanDocRef(activePlanId);
                const planDoc = await getDoc(planDocRef);
                if (!planDoc.exists()) return;

                const currentItineraries = planDoc.data().itineraries || [];
                const updatedItineraries = currentItineraries
                    .filter(item => item.id !== itineraryId)
                    .map((item, index) => ({ ...item, order: index + 1 })); // 重新排序

                await updateDoc(planDocRef, {
                    itineraries: updatedItineraries
                });
                showMessage('行程卡片已刪除。');

            } catch (e) {
                console.error("刪除行程失敗:", e);
                showMessage(`刪除行程失敗: ${e.message}`, true);
            }
        }

        /** 替換 window.confirm 的自定義 Modal 邏輯 */
        function confirmAction(message) {
            // 由於 iFrame 環境不支援原生 confirm，這裡做一個簡單的模擬
            console.warn(`[Confirm Action Required]: ${message} - 假設用戶點擊了 "確定"。`);
            return true; 
        }

        // --- UI Rendering Functions (HTML String Generation) ---

        /** 渲染旅遊計畫列表 */
        function renderPlanList() {
            let planCardsHtml = '';

            if (plans.length === 0) {
                planCardsHtml = `
                    <div class="col-span-full text-center py-10 bg-white rounded-xl shadow">
                        <p class="text-xl text-gray-500">尚無旅遊計畫。點擊「新增計畫」開始規劃！</p>
                    </div>
                `;
            } else {
                planCardsHtml = plans.map(plan => `
                    <div id="plan-card-${plan.id}" class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-xl transition duration-300 border-t-4 border-indigo-500">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${plan.name}</h3>
                            <div class="text-sm text-gray-500 space-y-1">
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    ${formatDate(plan.startDate)}
                                </p>
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    ${formatDate(plan.endDate)}
                                </p>
                                ${plan.destination ? `
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    ${plan.destination}
                                </p>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button data-plan-id="${plan.id}" onclick="event.stopPropagation(); handleDeletePlan('${plan.id}')"
                                class="p-2 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50"
                                title="刪除計畫">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                            </button>
                            <button data-plan-id="${plan.id}" onclick="setActivePlan('${plan.id}')"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-xl transition duration-300">
                                查看行程
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            return `
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">我的旅遊計畫</h1>
                    <button onclick="openAddPlanModal()"
                        class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        新增計畫
                    </button>
                </header>
                <div class="bg-gray-200 border-l-4 border-gray-500 text-gray-800 p-3 rounded-lg mb-6">
                    <p class="text-sm">當前用戶 ID (UID): <span class="font-mono text-xs bg-gray-300 p-1 rounded break-all">${currentUserId || 'N/A'}</span></p>
                    <p class="text-xs text-red-600 mt-1">此 ID 應始終為固定用戶 <code>${HARDCODED_EMAIL}</code> 的 UID。</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${planCardsHtml}
                </div>
            `;
        }

        /** 渲染行程卡片 */
        function renderItineraryCard(item) {
            return `
                <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500 relative ml-4 transition duration-300 hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center text-sm font-medium text-emerald-600 mb-1">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                ${item.time || '全天'}
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 mb-2">${item.activity}</h4>
                            ${item.location ? `
                            <p class="text-sm text-gray-600 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                地點: ${item.location}
                            </p>` : ''}
                            ${item.notes && item.notes !== '無備註' ? `
                            <p class="text-sm text-gray-500 mt-2 italic border-t border-gray-100 pt-2">
                                備註: ${item.notes}
                            </p>` : ''}
                        </div>
                        <button onclick="handleDeleteItinerary('${item.id}')"
                            class="p-1 text-red-400 hover:text-red-600 transition duration-150 rounded-full"
                            title="刪除行程">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        /** 渲染單日行程分組 */
        function renderDayItinerary(date, day, items) {
            // 對行程按時間排序，確保順序正確
            const sortedItems = items.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

            const itemsHtml = sortedItems.length === 0 
                ? `<div class="text-gray-500 italic ml-4">這一天還沒有安排行程。</div>`
                : sortedItems.map(renderItineraryCard).join('');

            return `
                <div class="relative border-l-4 border-indigo-300 ml-4 pl-6">
                    <!-- 日期標籤 -->
                    <div class="absolute -left-3 top-0 bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">
                        Day ${day}
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 mt-0 pt-0 ml-4">${formatDate(date)}</h3>

                    <div class="space-y-6">
                        ${itemsHtml}
                        <!-- 新增行程按鈕 -->
                        <button onclick="openAddItineraryModal('${date}')"
                            class="flex items-center justify-center w-full max-w-sm ml-4 bg-white border-2 border-dashed border-indigo-300 text-indigo-600 hover:bg-indigo-50 transition duration-150 py-3 rounded-xl shadow-sm font-medium">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            新增當日行程卡片
                        </button>
                    </div>
                </div>
            `;
        }

        /** 渲染行程詳情頁面 */
        function renderPlanDetail(plan) {
            datesArray = getDatesArray(plan.startDate, plan.endDate);
            
            // 按日期分組行程
            const groupedItineraries = datesArray.reduce((acc, { date, day }) => {
                acc[date] = {
                    day: day,
                    items: (plan.itineraries || [])
                        .filter(item => item.date === date)
                        // Note: Sorting happens inside renderDayItinerary now to handle time/order
                };
                return acc;
            }, {});

            let dayItinerariesHtml = datesArray.map(({ date, day }) => {
                const group = groupedItineraries[date];
                return renderDayItinerary(date, day, group.items);
            }).join('');

            return `
                <header class="mb-6 bg-white p-6 rounded-xl shadow-lg border-b-4 border-indigo-600">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <button onclick="activePlanId = null; renderApp();" class="text-indigo-600 hover:text-indigo-800 transition mb-2 flex items-center">
                                &larr; 返回計畫列表
                            </button>
                            <h1 class="text-3xl font-extrabold text-gray-900">${plan.name}</h1>
                            <p class="text-md text-gray-500 mt-1">${formatDate(plan.startDate)} ~ ${formatDate(plan.endDate)} (${datesArray.length} 天)</p>
                            ${plan.destination ? `
                            <p class="text-sm text-gray-600 mt-2 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                ${plan.destination}
                            </p>` : ''}
                        </div>
                        <button onclick="handleDeletePlan('${plan.id}')"
                            class="p-3 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-50 border border-red-200"
                            title="刪除此計畫">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>
                    </div>
                </header>
                <div class="space-y-10">
                    ${dayItinerariesHtml}
                </div>
            `;
        }

        // --- Core Application Logic ---

        /** 重新渲染應用程式主體 */
        window.renderApp = function() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            
            const activePlan = plans.find(p => p.id === activePlanId);

            if (activePlanId && activePlan) {
                appContainer.innerHTML = renderPlanDetail(activePlan);
                // 必須重新填充行程 Modal 的日期選項
                populateItineraryDates(activePlan);
            } else {
                appContainer.innerHTML = renderPlanList();
            }
        }

        /** 設定活躍計畫 ID 並重新渲染 */
        window.setActivePlan = function(planId) {
            activePlanId = planId;
            renderApp();
        }

        // --- Modal Control ---

        function openAddPlanModal() {
            document.getElementById('addPlanModal').classList.add('open');
            document.getElementById('addPlanForm').reset();
        }

        function closeAddPlanModal() {
            document.getElementById('addPlanModal').classList.remove('open');
        }

        /** 打開新增行程 Modal 並預設日期 */
        window.openAddItineraryModal = function(preselectedDate = null) {
            const modal = document.getElementById('addItineraryModal');
            const dateSelect = document.getElementById('itineraryDate');
            
            // 確保日期下拉菜單中的值被正確預選
            if (preselectedDate) {
                dateSelect.value = preselectedDate;
            } else if (datesArray.length > 0) {
                 dateSelect.value = datesArray[0].date;
            }
            
            modal.classList.add('open');
            document.getElementById('addItineraryForm').reset();
            // 由於重置會清空，需要重新設定日期
            if (preselectedDate) {
                 dateSelect.value = preselectedDate;
            }
        }

        function closeAddItineraryModal() {
            document.getElementById('addItineraryModal').classList.remove('open');
        }

        /** 填充新增行程 Modal 中的日期下拉選單 */
        function populateItineraryDates(activePlan) {
            const dateSelect = document.getElementById('itineraryDate');
            if (!dateSelect) return;

            datesArray = getDatesArray(activePlan.startDate, activePlan.endDate);
            dateSelect.innerHTML = datesArray.map(d => 
                `<option value="${d.date}">Day ${d.day} - ${formatDate(d.date)}</option>`
            ).join('');
        }
        
        // --- Event Listeners and Init ---

        /** 註冊表單提交事件 */
        document.getElementById('addPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('planName').value.trim();
            const destination = document.getElementById('planDestination').value.trim();
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;

            if (!name || !startDate || !endDate) {
                showMessage('請填寫計畫名稱、開始日期和結束日期。', true);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('開始日期不能晚於結束日期。', true);
                return;
            }

            handleAddPlan({ name, destination, startDate, endDate });
        });
        
        document.getElementById('addItineraryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const activity = document.getElementById('itineraryActivity').value.trim();
            const date = document.getElementById('itineraryDate').value;
            const time = document.getElementById('itineraryTime').value;
            const location = document.getElementById('itineraryLocation').value.trim();
            const notes = document.getElementById('itineraryNotes').value.trim();

            if (!activity || !date) {
                showMessage('請填寫活動名稱和日期。', true);
                return;
            }

            handleAddItinerary({ activity, date, time, location, notes });
        });
        
        // 暴露給全局，以便在 HTML 屬性中調用
        window.handleDeletePlan = handleDeletePlan;
        window.handleDeleteItinerary = handleDeleteItinerary;
        window.openAddPlanModal = openAddPlanModal;
        window.closeAddPlanModal = closeAddPlanModal;
        
        /** 應用程式啟動與 Firebase 初始化 */
        async function initializeAppAndFirebase() {
            
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase 配置未提供。");
                }
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // --- 步驟 1: 嘗試以固定帳號登入/創建 ---
                try {
                    console.log(`嘗試以硬編碼用戶 ${HARDCODED_EMAIL} 登入...`);
                    // 嘗試登入
                    await signInWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);
                    console.log(`成功登入為 ${HARDCODED_EMAIL}.`);

                } catch (loginError) {
                    console.warn(`登入失敗 (${loginError.code})。嘗試創建用戶...`);
                    // 如果登入失敗，嘗試創建該用戶
                    await createUserWithEmailAndPassword(auth, HARDCODED_EMAIL, HARDCODED_PASSWORD);
                    console.log(`用戶 ${HARDCODED_EMAIL} 創建成功並已登入。`);
                }

                // --- 步驟 2: 確認並設置用戶狀態 ---
                const user = auth.currentUser;
                if (user) {
                    currentUserId = user.uid;
                    isAuthenticated = true;
                    console.log("固定用戶已設置。UID:", currentUserId);
                    
                    // 訂閱資料
                    subscribeToPlans();
                } else {
                    // 如果登入/創建成功，但 currentUser 為空，則拋出錯誤
                    throw new Error("認證流程完成，但用戶狀態無效。");
                }

                // --- 步驟 3: 渲染應用程式 ---
                renderApp(); 

            } catch (e) {
                console.error("應用程式初始化失敗:", e);
                // 顯示錯誤訊息並停止執行
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = `
                    <div class="text-center bg-red-100 border-red-500 border-l-4 p-6 rounded-xl shadow-lg mt-8">
                        <h2 class="text-xl font-bold text-red-700 mb-2">認證/初始化失敗</h2>
                        <p class="text-gray-700">${e.message}</p>
                        <p class="text-sm mt-4">請檢查 Firebase Console 中是否啟用了電子郵件/密碼登入。</p>
                    </div>
                `;
            }
        }

        /** 訂閱旅遊計畫列表 */
        function subscribeToPlans() {
            if (!isAuthenticated || !currentUserId || !db) return;

            const plansCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/travel_plans`);
            const q = query(plansCollectionRef);

            onSnapshot(q, (snapshot) => {
                plans = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => {
                    // 在客戶端按建立時間倒序排序
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB - dateA;
                });
                
                // 每次資料更新時，重新渲染 App
                renderApp();
            }, (err) => {
                console.error("Firestore 訂閱失敗:", err);
                showMessage(`資料讀取失敗: ${err.message}`, true);
            });
        }

        // 啟動應用程式
        initializeAppAndFirebase();
    </script>
</body>
</html>