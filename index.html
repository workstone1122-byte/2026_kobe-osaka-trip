<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¡Œç¨‹</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        .page-container { max-width: 640px; }
        .trip-card {
            transition: all 0.2s ease-in-out;
        }
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* æ‡¸æµ®æ–°å¢æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
        @media (min-width: 640px) {
            /* è®“æŒ‰éˆ•åœ¨ PC æ¨¡å¼ä¸‹ï¼Œä¹Ÿä¿æŒåœ¨å…§å®¹å€åŸŸçš„å³ä¸‹æ–¹ */
            .fab {
                right: calc(50% - 320px + 24px); /* max-width: 640px / 2 + 24px é‚Šè· */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- é é¢é ‚éƒ¨å°èˆªåˆ— -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="page-container mx-auto flex justify-between items-center p-4">
            <h1 class="text-2xl font-bold text-indigo-700">æˆ‘çš„æ—…ç¨‹</h1>
            <button id="logout-button" class="text-gray-500 hover:text-red-600 transition duration-150 p-2 rounded-full active:bg-red-50" title="ç™»å‡º">
                <!-- Lucide: Log Out Icon - å°‡é€é JS è¼‰å…¥ -->
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <main class="page-container mx-auto p-4">
        
        <!-- ç”¨æˆ¶ ID é¡¯ç¤º (ç”¨æ–¼æ¸¬è©¦èˆ‡å”ä½œ) -->
        <div class="mb-4 p-3 bg-indigo-100 border border-indigo-200 rounded-lg text-sm text-indigo-700">
            <span class="font-medium">æ‚¨çš„ç”¨æˆ¶ ID (UID):</span> 
            <code id="user-id-display" class="font-mono text-xs break-all ml-1">è¼‰å…¥ä¸­...</code>
        </div>

        <!-- è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
        <div id="trip-list" class="space-y-4">
            <!-- è¡Œç¨‹å¡ç‰‡å°‡é€šé JavaScript æ¸²æŸ“åœ¨æ­¤è™• -->
        </div>

        <!-- ç©ºè¡Œç¨‹æç¤º (é è¨­éš±è—) -->
        <div id="no-trips-message" class="hidden text-center mt-20 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
            <span class="text-6xl" role="img" aria-label="Japan Flag">ğŸ‡¯ğŸ‡µ</span>
            <p class="mt-4 text-xl font-semibold text-gray-700">æ‚¨å°šæœªå»ºç«‹ä»»ä½•æ—…ç¨‹</p>
            <p class="text-gray-500 mt-2">é»æ“Šå³ä¸‹è§’çš„ <span class="font-bold">+</span> æŒ‰éˆ•ï¼Œé–‹å§‹è¦åŠƒæ‚¨çš„ç¬¬ä¸€è¶Ÿæ—…è¡Œï¼</p>
        </div>
    </main>
    
    <!-- æ‡¸æµ®æ–°å¢æŒ‰éˆ• (FAB) -->
    <button id="add-trip-fab" class="fab p-4 bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 transition duration-200 ease-in-out transform hover:scale-105 active:scale-95" title="æ–°å¢è¡Œç¨‹">
        <!-- Lucide: Plus Icon - å°‡é€é JS è¼‰å…¥ -->
    </button>
    
    <!-- è‡ªè¨‚è¼¸å…¥ Modal (å–ä»£ prompt()) -->
    <div id="new-trip-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">æ–°å¢æ—…ç¨‹</h3>
            <form id="new-trip-form">
                <label for="new-trip-name" class="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥æ–°è¡Œç¨‹åç¨±ï¼š</label>
                <input type="text" id="new-trip-name" required maxlength="50"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       placeholder="ä¾‹å¦‚ï¼š2026 ç¥æˆ¶å¤§é˜ªç¾é£Ÿä¹‹æ—…">
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-new-trip"
                            class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="create-trip-button"
                            class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">
                        å»ºç«‹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è‡ªè¨‚åˆªé™¤ç¢ºèª Modal (å–ä»£ confirm()) -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-red-700">ç¢ºèªåˆªé™¤</h3>
            <p id="delete-modal-message" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹æ—¥å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete"
                        class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">
                    å–æ¶ˆ
                </button>
                <button type="button" id="confirm-delete"
                        class="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">
                    ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>


    <!-- æ•´åˆå¾Œçš„å–®ä¸€æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (åŒ…å« Firebase åˆå§‹åŒ–ã€èªè­‰å®ˆè¡›å’Œæ‡‰ç”¨ç¨‹å¼é‚è¼¯) -->
    <script type="module">
        // --- 1. Firebase æ ¸å¿ƒæœå‹™åˆå§‹åŒ–èˆ‡èªè­‰æª¢æŸ¥ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, query, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®šæ—¥èªŒç´šåˆ¥
        setLogLevel('debug'); 

        // å–å¾—ç’°å¢ƒè®Šæ•¸é…ç½®
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        let unsubscribe = null; // ç”¨æ–¼å­˜æ”¾ Firestore ç›£è½å™¨çš„å–æ¶ˆå‡½æ•¸
        let currentUserId = null; // å„²å­˜ç•¶å‰ç”¨æˆ¶ ID
        
        // UI å…ƒç´ 
        const tripListElement = document.getElementById('trip-list');
        const noTripsMessage = document.getElementById('no-trips-message');
        const addTripFab = document.getElementById('add-trip-fab');
        const logoutButton = document.getElementById('logout-button');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Modal å…ƒç´  (æ–°å¢è¡Œç¨‹)
        const newTripModal = document.getElementById('new-trip-modal');
        const newTripForm = document.getElementById('new-trip-form');
        const newTripNameInput = document.getElementById('new-trip-name');
        const cancelNewTripButton = document.getElementById('cancel-new-trip');
        const createTripButton = document.getElementById('create-trip-button');
        
        // Modal å…ƒç´  (åˆªé™¤ç¢ºèª)
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        let tripToDeleteId = null; // æš«å­˜è¦åˆªé™¤çš„è¡Œç¨‹ ID


        // --- 0. è¦–è¦ºå…ƒç´ åˆå§‹åŒ– (æ’å…¥ Lucide åœ–æ¨™) ---
        // ä¿®æ­£ Lucide åœ–æ¨™çš„æ’å…¥æ–¹å¼ï¼Œé¿å… document.write é€ æˆçš„æ¸²æŸ“å•é¡Œ
        if (typeof lucide !== 'undefined') {
            document.getElementById('logout-button').innerHTML = lucide.createIcons()['log-out'].toSvg({ class: 'h-6 w-6' });
            document.getElementById('add-trip-fab').innerHTML = lucide.createIcons()['plus'].toSvg({ class: 'h-8 w-8' });
        }


        // --- 2. èªè­‰å®ˆè¡›é‚è¼¯ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ç”¨æˆ¶å·²ç™»å…¥ï¼Œé–‹å§‹è¼‰å…¥è¡Œç¨‹
                currentUserId = user.uid;
                console.log(`ç”¨æˆ¶å·²ç™»å…¥ (UID: ${currentUserId})ï¼Œé–‹å§‹ç›£è½è¡Œç¨‹ã€‚`);
                // ç”±æ–¼å·²ç¶“ç™»å…¥ï¼Œæˆ‘å€‘ç¾åœ¨æ‰å•Ÿå‹•ä¸»è¦çš„ Firestore ç›£è½
                startTripListener(currentUserId);
                userIdDisplay.textContent = currentUserId;
                
                // ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•å¯ç”¨
                addTripFab.disabled = false;

            } else {
                // ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢
                console.log("ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ login.htmlã€‚");
                window.location.replace('./login.html'); 
            }
        });


        // --- 3. ä¸»è¦æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        
        // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶è™•ç†
        logoutButton.addEventListener('click', async () => {
            // é€™è£¡ä½¿ç”¨è‡ªå®šç¾© Modal é‚è¼¯ä¾†å–ä»£ confirm()
            showConfirmModal('ç™»å‡ºç¢ºèª', 'æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', async () => {
                try {
                    if (unsubscribe) {
                         unsubscribe(); // å–æ¶ˆç›£è½
                    }
                    await signOut(auth);
                    // ç™»å‡ºå¾Œæœƒè¢« onAuthStateChanged å°å‘åˆ° login.html
                } catch (error) {
                    console.error("ç™»å‡ºå¤±æ•—:", error);
                    // å¯¦éš›æ‡‰ç”¨ç¨‹å¼æ‡‰ä½¿ç”¨è‡ªè¨‚ Modal
                    showSimpleMessage('éŒ¯èª¤', 'ç™»å‡ºå¤±æ•—: ' + error.message, 'error'); 
                }
            });
        });

        // --- è¼”åŠ©å‡½æ•¸ï¼šModal ç›¸é—œ ---
        
        // é¡¯ç¤ºåˆªé™¤ç¢ºèª Modal (å·²èª¿æ•´ç‚ºè™•ç†è¡Œç¨‹åˆªé™¤)
        const showDeleteModal = (tripId, name) => {
            tripToDeleteId = tripId;
            document.getElementById('delete-modal-message').innerHTML = `æ‚¨ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ <strong>${name}</strong> å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œä¸¦æœƒåˆªé™¤æ‰€æœ‰è¡Œç¨‹æ—¥è³‡æ–™ã€‚`;
            deleteModal.classList.remove('hidden');
        };

        // éš±è—åˆªé™¤ç¢ºèª Modal
        const hideDeleteModal = () => {
            deleteModal.classList.add('hidden');
            tripToDeleteId = null;
        };
        
        // åˆªé™¤æ“ä½œé‚è¼¯
        const handleDeleteTrip = async () => {
            if (!tripToDeleteId || !currentUserId) return;

            const deletingTripId = tripToDeleteId;
            hideDeleteModal(); // å…ˆé—œé–‰ Modal
            
            // ç”±æ–¼ Firestore ä¸æ”¯æ´éè¿´åˆªé™¤å­é›†åˆï¼Œæˆ‘å€‘éœ€è¦åœ¨å®¢æˆ¶ç«¯æ‰‹å‹•åˆªé™¤å­é›†åˆä¸­çš„æ–‡ä»¶
            try {
                // 1. å–å¾—ä¸¦åˆªé™¤å­é›†åˆ 'schedules' ä¸­çš„æ‰€æœ‰æ–‡ä»¶
                const schedulesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips', deletingTripId, 'schedules');
                const scheduleDocs = await getDocs(schedulesRef);
                
                const deletePromises = [];
                scheduleDocs.forEach(docSnapshot => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });
                
                await Promise.all(deletePromises);
                console.log(`æˆåŠŸåˆªé™¤è¡Œç¨‹ ${deletingTripId} ä¸‹ ${deletePromises.length} å€‹è¡Œç¨‹æ—¥ã€‚`);

                // 2. åˆªé™¤ä¸»è¡Œç¨‹æ–‡ä»¶
                const tripRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'trips', deletingTripId);
                await deleteDoc(tripRef);
                
                console.log(`è¡Œç¨‹ ${deletingTripId} åˆªé™¤æˆåŠŸ.`);

            } catch (error) {
                console.error("åˆªé™¤è¡Œç¨‹å¤±æ•—:", error);
                // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‡‰å°‡æ­¤æ›¿æ›ç‚º showCustomErrorModal(`åˆªé™¤å¤±æ•—: ${error.message}`)
                showSimpleMessage('éŒ¯èª¤', `åˆªé™¤è¡Œç¨‹å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // è¨­ç½®åˆªé™¤ Modal çš„äº‹ä»¶ç›£è½å™¨
        confirmDeleteButton.addEventListener('click', handleDeleteTrip);
        cancelDeleteButton.addEventListener('click', hideDeleteModal);
        
        // ç°¡æ˜“çš„é€šç”¨ Modal æ›¿æ› confirm/alert (ç‚ºäº†ç°¡æ½”ï¼Œä½¿ç”¨ç°¡å–®çš„ JS confirm/alert æç¤º)
        const showConfirmModal = (title, message, onConfirm) => {
            // æ³¨æ„: åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè«‹ä½¿ç”¨è‡ªå®šç¾© Modal UI æ›¿ä»£ window.confirm
            if (window.confirm(message)) {
                onConfirm();
            }
        };
        const showSimpleMessage = (title, message, type) => {
             // æ³¨æ„: åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè«‹ä½¿ç”¨è‡ªå®šç¾© Modal UI æ›¿ä»£ alert
             alert(`${title}: ${message}`);
        };


        // --- æ¸²æŸ“å–®å€‹è¡Œç¨‹å¡ç‰‡ (ä¿®æ­£ Lucide æ¸²æŸ“å•é¡Œ) ---
        const renderTripCard = (trip) => {
            // é å…ˆç”Ÿæˆ SVG å­—ä¸²ï¼Œé¿å…ä½¿ç”¨ document.write
            const usersIconSvg = lucide.createIcons()['users'].toSvg({ class: 'h-3 w-3 mr-1' });
            const chevronIconSvg = lucide.createIcons()['chevron-right'].toSvg({ class: 'h-6 w-6' });

            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'flex items-center space-x-2';
            
            // è¡Œç¨‹å¡ç‰‡æœ¬é«” (é»æ“Šå°èˆª)
            const card = document.createElement('div');
            card.dataset.id = trip.id; 
            card.className = 'trip-card bg-white p-5 rounded-xl shadow-lg border border-gray-100 cursor-pointer flex-grow flex items-center justify-between';
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">${trip.name}</h3>
                    <p class="text-sm text-gray-500 mt-1">
                        <span class="mr-3">å¤©æ•¸: ${trip.days}</span>
                        <span class="text-xs inline-flex items-center font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                            ${usersIconSvg}
                            å…±ç·¨: ${trip.memberCount || 1}
                        </span>
                    </p>
                    <p class="text-xs text-gray-400 mt-2">æœ€å¾Œæ›´æ–°: ${trip.lastUpdated ? new Date(trip.lastUpdated.seconds * 1000).toLocaleString('zh-TW') : 'N/A'}</p>
                </div>
                <div class="text-indigo-500">
                    ${chevronIconSvg}
                </div>
            `;
            
            // åˆªé™¤æŒ‰éˆ•
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-3 text-red-500 hover:text-red-700 rounded-full hover:bg-red-50 transition duration-150 flex-shrink-0';
            deleteButton.title = 'åˆªé™¤æ­¤è¡Œç¨‹';
            // ç›´æ¥æ’å…¥ trash-2 åœ–æ¨™çš„ SVG
            deleteButton.innerHTML = lucide.createIcons()['trash-2'].toSvg({ class: 'h-6 w-6' });

            // é»æ“Šäº‹ä»¶ï¼šå°å‘åˆ° trip.html
            card.addEventListener('click', () => {
                window.location.href = `./trip.html?tripId=${trip.id}`;
            });
            
            // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å°èˆª
                showDeleteModal(trip.id, trip.name);
            });
            
            cardWrapper.appendChild(card);
            cardWrapper.appendChild(deleteButton);

            return cardWrapper;
        };


        // --- å•Ÿå‹• Firestore ç›£è½ ---
        const startTripListener = (userId) => {
            // 1. å®šç¾©è¡Œç¨‹é›†åˆçš„è·¯å¾‘
            // è·¯å¾‘: /artifacts/{APP_ID}/public/data/trips
            const tripsCollectionRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips');

            // 2. å»ºç«‹æŸ¥è©¢: åªæŠ“å–å…¬é–‹çš„ trips é›†åˆä¸­çš„æ‰€æœ‰æ–‡ä»¶
            const q = query(tripsCollectionRef); 

            // å¦‚æœå·²ç¶“æœ‰ç›£è½å™¨åœ¨é‹è¡Œï¼Œå…ˆå–æ¶ˆå®ƒ
            if (unsubscribe) {
                unsubscribe();
            }

            // 3. å¯¦æ™‚ç›£è½ (onSnapshot)
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const trips = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    trips.push({
                        id: doc.id,
                        name: data.name || 'æœªå‘½åè¡Œç¨‹',
                        days: data.days || 1,
                        memberCount: data.members ? data.members.length : 1, 
                        lastUpdated: data.updatedAt 
                    });
                });

                // æ’åº (åœ¨å®¢æˆ¶ç«¯æ’åºï¼Œä¾æ“šæœ€å¾Œæ›´æ–°æ™‚é–“é™åºæ’åˆ—)
                trips.sort((a, b) => {
                    const dateA = a.lastUpdated ? a.lastUpdated.seconds : 0;
                    const dateB = b.lastUpdated ? b.lastUpdated.seconds : 0;
                    return dateB - dateA;
                });


                // æ¸²æŸ“ UI
                tripListElement.innerHTML = '';
                if (trips.length === 0) {
                    noTripsMessage.classList.remove('hidden');
                } else {
                    noTripsMessage.classList.add('hidden');
                    trips.forEach(trip => {
                        tripListElement.appendChild(renderTripCard(trip));
                    });
                }
            }, (error) => {
                console.error("Firestore ç›£è½å¤±æ•—:", error);
                // å¯¦éš›æ‡‰ç”¨ç¨‹å¼æ‡‰ä½¿ç”¨è‡ªè¨‚ Modal
                showSimpleMessage('éŒ¯èª¤', "ç„¡æ³•è¼‰å…¥è¡Œç¨‹åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¨­å®šã€‚", 'error');
                noTripsMessage.classList.remove('hidden'); 
                noTripsMessage.innerHTML = `<span class="text-red-500">è¼‰å…¥å¤±æ•—ï¼${error.code}</span>`;
            });
        };


        // é»æ“Š '+' æŒ‰éˆ•æ–°å¢è¡Œç¨‹çš„é‚è¼¯
        addTripFab.addEventListener('click', () => {
            if (!currentUserId) {
                 showSimpleMessage('æç¤º', "è«‹å…ˆç™»å…¥ä»¥å‰µå»ºè¡Œç¨‹ï¼", 'info');
                 return;
            }
            // é¡¯ç¤ºè‡ªå®šç¾© Modal
            newTripModal.classList.remove('hidden');
            newTripNameInput.focus();
        });
        
        // å–æ¶ˆæŒ‰éˆ•é‚è¼¯
        cancelNewTripButton.addEventListener('click', () => {
            newTripModal.classList.add('hidden');
            newTripForm.reset(); // æ¸…ç©ºè¡¨å–®
        });

        // è¡¨å–®æäº¤é‚è¼¯
        newTripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripName = newTripNameInput.value.trim();
            
            if (!tripName) return; 
            
            createTripButton.disabled = true;
            createTripButton.textContent = 'å»ºç«‹ä¸­...';
            
            try {
                const userId = currentUserId;
                const newTripRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'trips');

                // 1. æº–å‚™æ–°çš„è¡Œç¨‹è³‡æ–™
                const newTripData = {
                    name: tripName,
                    days: 1, // é è¨­ 1 å¤©
                    members: [userId], // å‰µå»ºè€…è‡ªå‹•æˆç‚ºç¬¬ä¸€å€‹æˆå“¡
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };
                
                // 2. å¯«å…¥ Firestore
                const docRef = await addDoc(newTripRef, newTripData);
                console.log("æ–°è¡Œç¨‹æ–‡ä»¶å¯«å…¥æˆåŠŸï¼ŒID:", docRef.id);
                
                // 3. éš±è— Modal ä¸¦å°å‘é é¢
                newTripModal.classList.add('hidden');
                newTripForm.reset(); 
                
                // ä½¿ç”¨ç›¸å°è·¯å¾‘è·³è½‰ï¼Œä¸¦å¸¶ä¸Šæ–°è¡Œç¨‹çš„ ID
                window.location.href = `./trip.html?tripId=${docRef.id}`; 
                
            } catch (error) {
                console.error("æ–°å¢è¡Œç¨‹å¤±æ•—:", error);
                showSimpleMessage('éŒ¯èª¤', "æ–°å¢è¡Œç¨‹å¤±æ•—ï¼š" + error.message, 'error');
            } finally {
                createTripButton.disabled = false;
                createTripButton.textContent = 'å»ºç«‹';
            }
        });

        // ç•¶é é¢è¢«å¸è¼‰æ™‚ï¼Œå–æ¶ˆ Firestore çš„ç›£è½
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
                console.log("Firestore ç›£è½å·²å–æ¶ˆã€‚");
            }
        });

    </script>
</body>
</html>